if("undefined"==typeof Peer){const e=document.createElement("script");e.src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js",e.onload=initP2P,document.head.appendChild(e)}else initP2P();function initP2P(){(function(){class P2PConnectionManager{constructor(e,t){this.peer=e,this.config=t||{},this._openHandler=null,this._connectionHandler=null,this._errorHandler=null,this._defaultOutgoingOpen=null,this._defaultOutgoingError=null}onOpen(e){return this._openHandler=e,this.peer.on("open",e),this}onConnection(e){return this._connectionHandler=e,this.peer.on("connection",e),this}onError(e){return this._errorHandler=e,this.peer.on("error",e),this}setDefaultOutgoingHandlers({onOpen:e,onError:t}={}){return this._defaultOutgoingOpen=e||null,this._defaultOutgoingError=t||null,this}connectTo(e,{onOpen:t,onError:o}={}){const i=this.peer.connect(e),l=t||this._defaultOutgoingOpen,s=o||this._defaultOutgoingError;return l&&i.on("open",(()=>l(i))),s&&i.on("error",(e=>s(e,i))),i}replacePeer(e){return this.peer=e,this._openHandler&&this.peer.on("open",this._openHandler),this._connectionHandler&&this.peer.on("connection",this._connectionHandler),this._errorHandler&&this.peer.on("error",this._errorHandler),this}reconnect(){if(this.peer)try{return"function"==typeof this.peer.reconnect&&this.peer.reconnect(),this.peer}catch(e){const t=new Peer({host:this.config.peerHost,path:this.config.peerPath,debug:this.config.debug?2:0});return this.replacePeer(t),t}}}const CONFIG={peerHost:"0.peerjs.com",peerPath:"/",updateInterval:50,debug:!0},peer=new Peer({host:CONFIG.peerHost,path:CONFIG.peerPath,debug:CONFIG.debug?2:0}),connManager=new P2PConnectionManager(peer);connManager.config=CONFIG;let connections=[];const clientId=Math.floor(256*Math.random());window.username="unnamed player",window.oldUsername="";let lastUpdateTime=0;window.remotePlayers={};const techList=[];let oldTech={};window.receivedLevelData=!1,window.seedUpdateInProgress=!1,window.lastSeedUpdateTime=0,window.remotePlayerLevel=new Map;const seedUpdateCD=1e3,BinaryProtocol={writeUint8:(e,t,o)=>(e.setUint8(t,o),t+1),writeUint16:(e,t,o)=>(e.setUint16(t,o,!0),t+2),writeUint32:(e,t,o)=>(e.setUint32(t,o,!0),t+4),writeFloat32:(e,t,o)=>(e.setFloat32(t,o,!0),t+4),writeFloat64:(e,t,o)=>(e.setFloat64(t,o,!0),t+8),writeBoolean:(e,t,o)=>(e.setUint8(t,o?1:0),t+1),writeString:(e,t,o)=>{const i=(new TextEncoder).encode(o);return t=BinaryProtocol.writeUint16(e,t,i.length),new Uint8Array(e.buffer).set(i,t),t+i.length},readUint8:(e,t)=>[e.getUint8(t),t+1],readUint16:(e,t)=>[e.getUint16(t,!0),t+2],readUint32:(e,t)=>[e.getUint32(t,!0),t+4],readFloat32:(e,t)=>[e.getFloat32(t,!0),t+4],readFloat64:(e,t)=>[e.getFloat64(t,!0),t+8],readBoolean:(e,t)=>[1===e.getUint8(t),t+1],readString:(e,t)=>{const[o,i]=BinaryProtocol.readUint16(e,t);return[(new TextDecoder).decode(new Uint8Array(e.buffer,i,o)),i+o]}},protocol={sync_request:0,sync:1,next_level:2,player_join:16,player_leave:17,player_movement:18,player_level:19,player_input:20,player_health:22,player_tech:23,player_tech_request:24,player_username:25,player_username_request:32,hole:33,rewind:34,molecular_mode:35,block_create:53,block_update:54,block_remove:55,block_request_all:56,block_all_data:57,seed_sync:58,seed_request:59,game_event:80,chat_message:81,damage:96,peer_list:112,level_seed:128},knownBlocks=new Set;let nextBlockId=1;const remoteIdToBlock=new Map,blockToRemoteId=new WeakMap,block_update_interval=150;window.agreedSeed=null,window.currentLevelId=null;const style=document.createElement("style");style.textContent="\n            .status-connected {\n                color: #4CAF50;\n            }\n            .status-disconnected {\n                color: #f44336;\n            }\n            .status-connecting {\n                color: #FF9800;\n            }\n            #p2p-id-display {\n                user-select: all;\n                background: rgba(255, 255, 255, 0.1);\n                padding: 4px 8px;\n                border-radius: 4px;\n                margin-right: 5px;\n            }\n            .copy-button {\n                background: linear-gradient(145deg, #43a047, #4CAF50);\n                color: white;\n                border: none;\n                padding: 6px 12px;\n                border-radius: 6px;\n                cursor: pointer;\n                font-size: 12px;\n                font-weight: 500;\n                transition: all 0.3s ease;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n                position: relative;\n                overflow: hidden;\n            }\n\n            .copy-button:hover {\n                background: linear-gradient(145deg, #388e3c, #43a047);\n                transform: translateY(-1px);\n                box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n            }\n\n            .copy-button:active {\n                transform: translateY(0);\n                box-shadow: 0 1px 2px rgba(0,0,0,0.2);\n            }\n\n            .copy-button::after {\n                content: '';\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                width: 0;\n                height: 0;\n                background: rgba(255,255,255,0.2);\n                border-radius: 50%;\n                transform: translate(-50%, -50%);\n                transition: width 0.3s ease, height 0.3s ease;\n            }\n\n            .copy-button:active::after {\n                width: 100px;\n                height: 100px;\n            }\n            .connection-button {\n                padding: 8px 16px;\n                border-radius: 6px;\n                border: 1px solid #555;\n                background: linear-gradient(145deg, #1a1a1a, #2d2d2d);\n                color: white;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.3s ease;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                position: relative;\n                overflow: hidden;\n            }\n            .connection-button:hover {\n                background: linear-gradient(145deg, #2d2d2d, #3a3a3a);\n                border-color: #666;\n                transform: translateY(-1px);\n                box-shadow: 0 4px 8px rgba(0,0,0,0.4);\n            }\n            .connection-button:active {\n                transform: translateY(0);\n                box-shadow: 0 1px 2px rgba(0,0,0,0.3);\n            }\n            .connection-button::before {\n                content: '';\n                position: absolute;\n                top: 0;\n                left: -100%;\n                width: 100%;\n                height: 100%;\n                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);\n                transition: left 0.5s ease;\n            }\n            .connection-button:hover::before {\n                left: 100%;\n            }\n            .id-container {\n                display: flex;\n                align-items: center;\n            }\n            h3 {\n                margin: 0 0 15px 0;\n                font-size: 16px;\n                border-bottom: 1px solid #444;\n                padding-bottom: 8px;\n            }\n            ",document.head.appendChild(style);const container=document.createElement("details");container.id="multiplayer-details",container.innerHTML=`\n        <summary>multiplayer</summary>\n        <div class="details-div" style="max-width: 50rem;">\n            <div class="id-container">\n                <span>Your ID:</span>\n                <span id="p2p-id-display">...</span>\n                <button class="copy-button" id="p2p-copy-id">Copy</button>\n            </div>\n            <div>Client ID: <span id="client-id-display">${clientId}</span></div>\n            <div>\n                <label for="p2p-username">Username:</label>\n                <input type="text" id="p2p-username" placeholder="Enter username" maxlength="20">\n            </div>\n            <input type="text" id="p2p-remote-id" placeholder="Friend's ID">\n            <button id="p2p-connect" class="connection-button">Connect</button>\n            <div id="p2p-status">Status: <span class="status-disconnected">Disconnected</span></div>\n        </div>\n        `;const infoSection=document.getElementById("info");infoSection.insertBefore(container,infoSection.firstChild),document.getElementById("p2p-copy-id").addEventListener("click",(()=>{const e=document.getElementById("p2p-id-display");"..."!==e.textContent&&navigator.clipboard.writeText(e.textContent).then((()=>{const e=document.getElementById("p2p-copy-id"),t=e.textContent;e.textContent="Copied!",setTimeout((()=>{e.textContent=t}),2e3)})).catch((e=>{console.error("Failed to copy: ",e)}))})),document.getElementById("p2p-username").addEventListener("input",(e=>{window.username=e.target.value.trim()||"unnamed player",window.oldUsername=window.username,localStorage.setItem("p2pUsername",username),sendUsernameUpdate()}));const savedUsername=localStorage.getItem("p2pUsername");savedUsername?(username=savedUsername,document.getElementById("p2p-username").value=username):(username="unnamed player",localStorage.setItem("p2pUsername",username),document.getElementById("p2p-username").value=username);const seedInput=document.getElementById("seed");function updateStatus(e,t){document.getElementById("p2p-status").innerHTML=`Status: <span class="${t}">${e}</span>`}function log(e,t="info"){if(!CONFIG.debug)return;const o="[P2P] ";"error"===t?console.error(o+e):"warn"===t?console.warn(o+e):console.log(o+e)}seedInput&&seedInput.addEventListener("input",debounce((()=>{const e=seedInput.value.trim();""===e||seedUpdateInProgress?sendSeedSync(seedInput.placeholder||""):sendSeedSync(e)}),500));const processedMessages=new Set,message_ttl=6e4,clientLastSeen={},connToSenders=new Map;function removeRemotePlayer(e){if(!remotePlayers[e])return;Composite.remove(engine.world,remotePlayers[e]);const t=mob.findIndex((t=>t.id===e));-1!==t&&mob.splice(t,1),simulation.inGameConsole(`${remotePlayers[e].username} left the game`),delete remotePlayers[e]}function handleBinaryPacket(e,t){const o=Date.now()+"-"+Math.random().toString(36).substring(2,9);if(processedMessages.has(o))return;processedMessages.add(o),setTimeout((()=>processedMessages.delete(o)),message_ttl);const i=new DataView(e);let l=0;const[s,a]=BinaryProtocol.readUint8(i,l),[r,n]=BinaryProtocol.readUint8(i,a);if(l=n,clientLastSeen[r]=performance.now?performance.now():Date.now(),t){const e=connToSenders.get(t);e&&e.add(r)}try{switch(s){case protocol.player_username:{const[e,t]=BinaryProtocol.readString(i,l);remotePlayers[r]&&(remotePlayers[r].username=e);break}case protocol.chat_message:{const[e,t]=BinaryProtocol.readString(i,l);simulation.inGameConsole(e);break}case protocol.player_username_request:sendUsernameUpdate();break;case protocol.hole:{const[e,t]=BinaryProtocol.readFloat64(i,l),[o,s]=BinaryProtocol.readFloat64(i,t),[a,n]=BinaryProtocol.readFloat64(i,s),[c,h]=BinaryProtocol.readFloat64(i,n);remotePlayers[r]&&(remotePlayers[r].hole.pos1.x=e,remotePlayers[r].hole.pos1.y=o,remotePlayers[r].hole.pos2.x=a,remotePlayers[r].hole.pos2.y=c);break}case protocol.rewind:{const[e,t]=BinaryProtocol.readBoolean(i,l),[o,s]=BinaryProtocol.readBoolean(i,t);remotePlayers[r]&&(remotePlayers[r].isRewindMode=e,remotePlayers[r].isTimeDilated=o);break}case protocol.molecular_mode:{const[e,t]=BinaryProtocol.readUint8(i,l);remotePlayers[r]&&(remotePlayers[r].molecularMode=e);break}case protocol.player_level:{const[e]=BinaryProtocol.readUint8(i,l);if(remotePlayers){if(!remotePlayers[r])return;remotePlayers[r].level=e,remotePlayers[r].level!=level.onLevel?remotePlayers[r].updateBlocks=!1:remotePlayers[r].updateBlocks=!0}else{if(!alive)return;remotePlayers[r]=spawnPlayer(0,0,r),safeRemoveAllTechForPlayer(r),requestTechUpdate()}break}case protocol.player_movement:{const[e,t]=BinaryProtocol.readFloat64(i,l),[o,s]=BinaryProtocol.readFloat64(i,t),[a,n]=BinaryProtocol.readFloat64(i,s),[c,h]=BinaryProtocol.readFloat64(i,n),[d,y]=BinaryProtocol.readFloat64(i,h),[u,p]=BinaryProtocol.readBoolean(i,y),[g,f]=BinaryProtocol.readUint8(i,p),[x,b]=BinaryProtocol.readFloat64(i,f),[M,P]=BinaryProtocol.readFloat64(i,b),[w,v]=BinaryProtocol.readUint8(i,P),[B,V]=BinaryProtocol.readFloat64(i,v);if(remotePlayers[r]){if(!(remotePlayers[r]&&u&&m.alive))return;{-1==mob.findIndex((e=>e.id===r))&&delete remotePlayers[r];const t=remotePlayers[r];Matter.Vector.magnitude(Matter.Vector.sub(t?t.position:player.position,{x:e,y:o}))>1.5&&Matter.Body.setPosition(t,{x:e,y:o}),Matter.Body.setVelocity(t,{x:a,y:c}),t.angle2=d,t.gunType=g,t.mouse.x=x,t.mouse.y=M,t.fieldMode=w,t.fireCDscale=B}}else{if(!u)return;remotePlayers[r]=spawnPlayer(e,o,r),safeRemoveAllTechForPlayer(r),requestTechUpdate()}break}case protocol.player_input:{const[e,t]=BinaryProtocol.readBoolean(i,l),[o,s]=BinaryProtocol.readBoolean(i,t),[a,n]=BinaryProtocol.readBoolean(i,s),[c,h]=BinaryProtocol.readBoolean(i,n),[d,y]=BinaryProtocol.readBoolean(i,h),[m,u]=BinaryProtocol.readBoolean(i,y);if(remotePlayers[r]){const t=remotePlayers[r];t.inputUp=e,t.inputDown=o,t.inputLeft=a,t.inputRight=c,t.inputFire=d,t.inputField=m}break}case protocol.player_tech:{const[e,t]=BinaryProtocol.readUint16(i,l),[o,s]=BinaryProtocol.readUint8(i,t);let a,n;if(0===o?[a,n]=BinaryProtocol.readFloat64(i,s):1===o?[a,n]=BinaryProtocol.readString(i,s):2===o&&([a,n]=BinaryProtocol.readBoolean(i,s)),remotePlayers[r]){remotePlayers[r].tech||(remotePlayers[r].tech={});const t=techList[e];remotePlayers[r].tech[t]=a}break}case protocol.player_tech_request:for(const e of techList)sendTechUpdate(e,tech[e]);break;case protocol.player_join:remotePlayers[r]?remotePlayers[r].username&&simulation.inGameConsole(`${remotePlayers[r].username} joined the game`):requestUsername();break;case protocol.player_health:{const[e,t]=BinaryProtocol.readFloat64(i,l),[o,s]=BinaryProtocol.readFloat64(i,t),[a,n]=BinaryProtocol.readFloat64(i,s),[c,h]=BinaryProtocol.readFloat64(i,n);if(remotePlayers[r]){const t=remotePlayers[r];t.health=100*c,t.energy=o,t.maxHealth=100*a,t.maxEnergy=e}break}case protocol.damage:{const[e,t]=BinaryProtocol.readFloat64(i,l);r===clientId&&m.takeDamage(e);break}case protocol.block_create:{if(remotePlayers[r]&&!remotePlayers[r].updateBlocks)return;const[e,t]=BinaryProtocol.readString(i,l),[o,s]=BinaryProtocol.readFloat64(i,t),[a,n]=BinaryProtocol.readFloat64(i,s),[c,h]=BinaryProtocol.readFloat64(i,n),[d,y]=BinaryProtocol.readUint8(i,h),m=[];let u=y;for(let e=0;e<d;e++){const[e,t]=BinaryProtocol.readFloat64(i,u),[o,l]=BinaryProtocol.readFloat64(i,t);m.push(Matter.Vector.create(e,o)),u=l}createRemoteBlock(e,o,a,c,m,r);break}case protocol.block_update:{if(remotePlayers[r]&&!remotePlayers[r].updateBlocks)return;const[e,t]=BinaryProtocol.readString(i,l),[o,s]=BinaryProtocol.readFloat64(i,t),[a,n]=BinaryProtocol.readFloat64(i,s),[c,h]=BinaryProtocol.readFloat64(i,n),[d,y]=BinaryProtocol.readFloat64(i,h),[m,u]=BinaryProtocol.readFloat64(i,y),[p,g]=BinaryProtocol.readFloat64(i,u),[f,x]=BinaryProtocol.readBoolean(i,g);updateRemoteBlock(e,o,a,c,d,m,p,r,f);break}case protocol.block_remove:{if(remotePlayers[r]&&!remotePlayers[r].updateBlocks)return;const[e,t]=BinaryProtocol.readUint16(i,l);removeRemoteBlock(e,r);break}case protocol.block_request_all:sendAllBlocks(r);break;case protocol.block_all_data:{if(remotePlayers[r]&&!remotePlayers[r].updateBlocks)return;const[e,t]=BinaryProtocol.readUint16(i,l);let o=t;for(let t=0;t<e;t++){const[e,t]=BinaryProtocol.readUint16(i,o),[l,s]=BinaryProtocol.readFloat64(i,t),[a,n]=BinaryProtocol.readFloat64(i,s),[c,h]=BinaryProtocol.readFloat64(i,n),[d,y]=BinaryProtocol.readUint8(i,h),m=[];o=y;for(let e=0;e<d;e++){const[e,t]=BinaryProtocol.readFloat64(i,o),[l,s]=BinaryProtocol.readFloat64(i,t);m.push(Matter.Vector.create(e,l)),o=s}createRemoteBlock(e,l,a,c,m,r)}break}case protocol.seed_sync:{const[e,t]=BinaryProtocol.readString(i,l);if(r===clientId||seedUpdateInProgress)break;const o=document.getElementById("seed");o&&o.value!==e&&(seedUpdateInProgress=!0,o.value=e,Math.initialSeed=e,setTimeout((()=>{seedUpdateInProgress=!1}),100));break}case protocol.seed_request:sendSeedSync(Math.initialSeed);break;case protocol.player_leave:{const[e,o]=BinaryProtocol.readUint8(i,l);if(t){const o=new ArrayBuffer(2),i=new DataView(o);BinaryProtocol.writeUint8(i,0,protocol.player_leave),BinaryProtocol.writeUint8(i,1,e);for(const e of connections)if(e!==t&&e.open)try{e.send(o)}catch(e){console.error("Error forwarding leave message:",e)}}removeRemotePlayer(e);break}default:log(`Unhandled packet type: 0x${s.toString(16)}`,"warn")}}catch(e){log("Packet handling error: "+e,"error")}}function sendPlayerMovement(e,t,o,i,l,s,a,r,n,c){const h=new ArrayBuffer(69),d=new DataView(h);let y=BinaryProtocol.writeUint8(d,0,protocol.player_movement);y=BinaryProtocol.writeUint8(d,y,clientId),y=BinaryProtocol.writeFloat64(d,y,e),y=BinaryProtocol.writeFloat64(d,y,t),y=BinaryProtocol.writeFloat64(d,y,o),y=BinaryProtocol.writeFloat64(d,y,i),y=BinaryProtocol.writeFloat64(d,y,l),y=BinaryProtocol.writeBoolean(d,y,s),y=BinaryProtocol.writeUint8(d,y,null==a?255:a),y=BinaryProtocol.writeFloat64(d,y,r),y=BinaryProtocol.writeFloat64(d,y,n),y=BinaryProtocol.writeUint8(d,y,null==c?255:c),y=BinaryProtocol.writeFloat64(d,y,b.fireCDscale),sendData(h)}function sendMisc(e=m.health,t=m.maxHealth,o=m.energy,i=m.maxEnergy){const l=new ArrayBuffer(34),s=new DataView(l);let a=BinaryProtocol.writeUint8(s,0,protocol.player_health);a=BinaryProtocol.writeUint8(s,a,clientId),a=BinaryProtocol.writeFloat64(s,a,i),a=BinaryProtocol.writeFloat64(s,a,o),a=BinaryProtocol.writeFloat64(s,a,t),a=BinaryProtocol.writeFloat64(s,a,e),sendData(l)}function sendPlayerLevel(e){const t=new ArrayBuffer(3),o=new DataView(t);let i=BinaryProtocol.writeUint8(o,0,protocol.player_level);i=BinaryProtocol.writeUint8(o,i,clientId),i=BinaryProtocol.writeUint8(o,i,e),sendData(t)}function sendFullTechSync(e){for(const t of techList){const o=new ArrayBuffer(12),i=new DataView(o);let l=BinaryProtocol.writeUint8(i,0,protocol.player_tech);l=BinaryProtocol.writeUint8(i,l,clientId),l=BinaryProtocol.writeUint16(i,l,techList.indexOf(t)),l=BinaryProtocol.writeFloat64(i,l,tech[t]),e.open&&e.send(o)}}function checkAndSendTechUpdates(){for(const e of techList)tech[e]!==oldTech[e]&&(sendTechUpdate(e,tech[e]),oldTech[e]=tech[e])}function sendTechUpdate(e,t){const o=techList.indexOf(e);if(void 0===t||-1===o)return;let i,l,s;if("number"==typeof t)i=new ArrayBuffer(13),l=new DataView(i),s=BinaryProtocol.writeUint8(l,0,protocol.player_tech),s=BinaryProtocol.writeUint8(l,s,clientId),s=BinaryProtocol.writeUint16(l,s,o),s=BinaryProtocol.writeUint8(l,s,0),s=BinaryProtocol.writeFloat64(l,s,t);else if("string"==typeof t){const e=(new TextEncoder).encode(t);i=new ArrayBuffer(7+e.length),l=new DataView(i),s=BinaryProtocol.writeUint8(l,0,protocol.player_tech),s=BinaryProtocol.writeUint8(l,s,clientId),s=BinaryProtocol.writeUint16(l,s,o),s=BinaryProtocol.writeUint8(l,s,1),s=BinaryProtocol.writeUint16(l,s,e.length),new Uint8Array(i,s).set(e),s+=e.length}else"boolean"==typeof t&&(i=new ArrayBuffer(6),l=new DataView(i),s=BinaryProtocol.writeUint8(l,0,protocol.player_tech),s=BinaryProtocol.writeUint8(l,s,clientId),s=BinaryProtocol.writeUint16(l,s,o),s=BinaryProtocol.writeUint8(l,s,2),s=BinaryProtocol.writeBoolean(l,s,t));sendData(i)}function requestTechUpdate(){const e=new ArrayBuffer(2),t=new DataView(e);let o=BinaryProtocol.writeUint8(t,0,protocol.player_tech_request);o=BinaryProtocol.writeUint8(t,o,clientId),sendData(e)}function sendDamage(e,t){const o=new ArrayBuffer(10),i=new DataView(o);let l=BinaryProtocol.writeUint8(i,0,protocol.damage);l=BinaryProtocol.writeUint8(i,l,t),l=BinaryProtocol.writeFloat64(i,l,e/100),sendData(o)}function sendPlayerInput(e){const t=new ArrayBuffer(8),o=new DataView(t);let i=BinaryProtocol.writeUint8(o,0,protocol.player_input);i=BinaryProtocol.writeUint8(o,i,clientId),i=BinaryProtocol.writeBoolean(o,i,e.up),i=BinaryProtocol.writeBoolean(o,i,e.down),i=BinaryProtocol.writeBoolean(o,i,e.left),i=BinaryProtocol.writeBoolean(o,i,e.right),i=BinaryProtocol.writeBoolean(o,i,e.fire),i=BinaryProtocol.writeBoolean(o,i,e.field),sendData(t)}function sendPlayerJoin(){const e=new ArrayBuffer(2),t=new DataView(e);let o=BinaryProtocol.writeUint8(t,0,protocol.player_join);o=BinaryProtocol.writeUint8(t,o,clientId),sendData(e)}function sendUsernameUpdate(){const e=new ArrayBuffer(4+2*username.length),t=new DataView(e);let o=BinaryProtocol.writeUint8(t,0,protocol.player_username);o=BinaryProtocol.writeUint8(t,o,clientId),o=BinaryProtocol.writeString(t,o,username),sendData(e)}function requestUsername(){const e=new ArrayBuffer(2),t=new DataView(e);let o=BinaryProtocol.writeUint8(t,0,protocol.player_username_request);o=BinaryProtocol.writeUint8(t,o,clientId),sendData(e)}function sentChat(e){const t=new ArrayBuffer(4+2*e.length),o=new DataView(t);let i=BinaryProtocol.writeUint8(o,0,protocol.chat_message);i=BinaryProtocol.writeUint8(o,i,clientId),i=BinaryProtocol.writeString(o,i,e),sendData(t)}function createRemoteBlock(e,t,o,i,l,s){let a=body.find((t=>t.id===e));if(a)return a.remoteBlock=!0,knownBlocks.add(e),void remoteIdToBlock.set(e,a);knownBlocks.add(e),a=Bodies.fromVertices(t,o,[l],{render:{fillStyle:"#AAAAAA"},friction:.1,restitution:.3,collisionFilter:{category:cat.body,mask:cat.player|cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet}}),a&&(a.id=e,a.remoteBlock=!0,a.senderId=s,a.lastUpdate=0,Matter.Body.setAngle(a,i),Composite.add(engine.world,a),body.push(a),remoteIdToBlock.set(e,a),console.log(`[P2P] Created remote block ${e} from player ${s}`))}function updateRemoteBlock(e,t,o,i,l,s,a,r,n){const c=remoteIdToBlock.get(e)||body.find((t=>t.id===e));c&&(c.senderId===r||c.lastUpdate<Date.now()-100||n)&&(Matter.Body.setPosition(c,{x:t,y:o}),Matter.Body.setAngle(c,i),Matter.Body.setVelocity(c,{x:l,y:s}),Matter.Body.setAngularVelocity(c,a),c.lastUpdate=Date.now())}function removeRemoteBlock(e,t){const o=remoteIdToBlock.get(e);if(o&&!o.remoteBlock)return remoteIdToBlock.delete(e),knownBlocks.delete(e),void console.log(`[P2P] Dropped alias for remote block ${e}`);const i=body.findIndex((t=>t.id===e&&t.remoteBlock));if(-1!==i){const o=body[i];o.senderId===t&&(Composite.remove(engine.world,o),body.splice(i,1),knownBlocks.delete(e),remoteIdToBlock.delete(e),console.log(`[P2P] Removed remote block ${e}`))}}function sendAllBlocks(e){const t=connections.find((t=>{const o=connToSenders.get(t);return o&&o.has(e)}));if(!t||!t.open)return;let o=3;body.forEach((e=>{e.remoteBlock||(o+=2,o+=24,o+=1,o+=16*e.vertices.length)}));const i=new ArrayBuffer(o),l=new DataView(i);let s=BinaryProtocol.writeUint8(l,0,protocol.block_all_data);s=BinaryProtocol.writeUint8(l,s,clientId),s=BinaryProtocol.writeUint16(l,s,body.filter((e=>!e.remoteBlock)).length),body.forEach((e=>{if(!e.remoteBlock){const t=blockToRemoteId.get(e)||e.id;s=BinaryProtocol.writeUint16(l,s,t),s=BinaryProtocol.writeFloat64(l,s,e.position.x),s=BinaryProtocol.writeFloat64(l,s,e.position.y),s=BinaryProtocol.writeFloat64(l,s,e.angle),s=BinaryProtocol.writeUint8(l,s,e.vertices.length),e.vertices.forEach((e=>{s=BinaryProtocol.writeFloat64(l,s,e.x),s=BinaryProtocol.writeFloat64(l,s,e.y)}))}})),t.send(i)}function sendBlockCreate(e){const t=4+(new TextEncoder).encode(e.id).length+24+1+16*e.vertices.length,o=new ArrayBuffer(t),i=new DataView(o);let l=BinaryProtocol.writeUint8(i,0,protocol.block_create);l=BinaryProtocol.writeUint8(i,l,clientId),l=BinaryProtocol.writeString(i,l,e.id),l=BinaryProtocol.writeFloat64(i,l,e.position.x),l=BinaryProtocol.writeFloat64(i,l,e.position.y),l=BinaryProtocol.writeFloat64(i,l,e.angle),l=BinaryProtocol.writeUint8(i,l,e.vertices.length),e.vertices.forEach((e=>{l=BinaryProtocol.writeFloat64(i,l,e.x),l=BinaryProtocol.writeFloat64(i,l,e.y)})),sendData(o)}function sendBlockUpdate(e,t=!1){const o=new ArrayBuffer(4+e.id.length+48+1),i=new DataView(o);let l=BinaryProtocol.writeUint8(i,0,protocol.block_update);l=BinaryProtocol.writeUint8(i,l,clientId),l=BinaryProtocol.writeString(i,l,e.id),l=BinaryProtocol.writeFloat64(i,l,e.position.x),l=BinaryProtocol.writeFloat64(i,l,e.position.y),l=BinaryProtocol.writeFloat64(i,l,e.angle),l=BinaryProtocol.writeFloat64(i,l,e.velocity.x),l=BinaryProtocol.writeFloat64(i,l,e.velocity.y),l=BinaryProtocol.writeFloat64(i,l,e.angularVelocity),l=BinaryProtocol.writeBoolean(i,l,t),sendData(o)}function sendBlockRemove(e){const t=new ArrayBuffer(4),o=new DataView(t);let i,l=BinaryProtocol.writeUint8(o,0,protocol.block_remove);l=BinaryProtocol.writeUint8(o,l,clientId),"number"==typeof e?i=e:e&&"object"==typeof e&&(i=blockToRemoteId.get(e)||e.id),l=BinaryProtocol.writeUint16(o,l,i),sendData(t)}function requestAllBlocks(){const e=new ArrayBuffer(2),t=new DataView(e);let o=BinaryProtocol.writeUint8(t,0,protocol.block_request_all);o=BinaryProtocol.writeUint8(t,o,clientId),sendData(e)}function sendHole(){if(9==m.fieldMode&&m.hole){const e=new ArrayBuffer(66),t=new DataView(e);let o=BinaryProtocol.writeUint8(t,0,protocol.hole);o=BinaryProtocol.writeUint8(t,o,clientId),o=BinaryProtocol.writeFloat64(t,o,m.hole.pos1.x),o=BinaryProtocol.writeFloat64(t,o,m.hole.pos1.y),o=BinaryProtocol.writeFloat64(t,o,m.hole.pos2.x),o=BinaryProtocol.writeFloat64(t,o,m.hole.pos2.y),sendData(e)}}function sendRewind(){if(6==m.fieldMode){const e=new ArrayBuffer(4),t=new DataView(e);let o=BinaryProtocol.writeUint8(t,0,protocol.rewind);o=BinaryProtocol.writeUint8(t,o,clientId),o=BinaryProtocol.writeBoolean(t,o,m.fieldUpgrades[6].isRewindMode),o=BinaryProtocol.writeBoolean(t,o,m.isTimeDilated),sendData(e)}}function sendMode(){if(4==m.fieldMode){const e=new ArrayBuffer(3),t=new DataView(e);let o=BinaryProtocol.writeUint8(t,0,protocol.molecular_mode);o=BinaryProtocol.writeUint8(t,o,clientId),o=BinaryProtocol.writeUint8(t,o,simulation.molecularMode),sendData(e)}}function sendSeedSync(e){if("string"!=typeof e&&(e=String(e)),seedUpdateInProgress||Date.now()-lastSeedUpdateTime<seedUpdateCD)return;const t=document.getElementById("seed");t&&t.value!==e&&(t.value=e);const o=(new TextEncoder).encode(e),i=new ArrayBuffer(4+o.length),l=new DataView(i);let s=BinaryProtocol.writeUint8(l,0,protocol.seed_sync);s=BinaryProtocol.writeUint8(l,s,clientId),s=BinaryProtocol.writeUint16(l,s,o.length),new Uint8Array(i,s).set(o),sendData(i)}function debounce(e,t){let o;return function(...i){clearTimeout(o),o=setTimeout((()=>{clearTimeout(o),e(...i)}),t)}}function ensureBidirectional(e){if(!connections.some((t=>t.peer===e.peer))){const t=peer.connect(e.peer);t.on("open",(()=>setupConnection(t))),t.on("error",(()=>{setTimeout((()=>ensureBidirectional(e)),2e3)}))}}function broadcastPeerList(){if(0===connections.length)return;const e=connections.map((e=>e.peer)).concat(peer.id);for(const t of connections)if(t.open)try{t.send({type:"peer-list",peers:e})}catch(e){console.error("Error sending peer list:",e)}}function handlePeerList(e,t){if(peer.disconnected)return void reconnect();const o=new Set(e);for(const e of o)if(e!==peer.id&&!connections.some((t=>t.peer===e))){const o=peer.connect(e);o.on("open",(()=>{setupConnection(o),broadcastPeerList()})),o.on("error",(()=>{console.warn("Connection failed, retrying:",e),setTimeout((()=>{connections.some((t=>t.peer===e))||handlePeerList([e],t)}),2e3)}))}}function setupConnection(e){connections.some((t=>t.peer===e.peer))||(connections.push(e),connToSenders.set(e,new Set),e.on("data",(t=>{t instanceof ArrayBuffer?handleBinaryPacket(t,e):"object"==typeof t&&"peer-list"===t.type&&handlePeerList(t.peers,e)})),e.on("close",(()=>{const t=connToSenders.get(e)||new Set;for(const o of t)propagatePlayerLeave(o,e),removeRemotePlayer(o);connToSenders.delete(e),connections=connections.filter((t=>t!==e)),updateConnectionStatus(),broadcastPeerList()})),e.on("error",(()=>{connections=connections.filter((t=>t!==e)),updateConnectionStatus()})),ensureBidirectional(e),broadcastPeerList(),sendPlayerJoin(),sendPlayerLevel(level.onLevel),sendFullTechSync(e))}function validateUsernames(){for(const e in remotePlayers)remotePlayers[e].username&&"unnamed player"!==remotePlayers[e].username&&"undefined"!==remotePlayers[e].username||requestUsername()}function sendData(e){if(!e)return!1;if(0===connections.length)return!1;let t=!1;for(const o of connections)if(o.open)try{o.send(e),t=!0}catch(e){log("Error sending data: "+e,"error"),connections=connections.filter((e=>e!==o))}return t}function initTechList(){for(const e in tech)(null==tech[e]||["boolean","number","string"].includes(typeof tech[e]))&&techList.push(e);for(const e of techList)oldTech[e]=tech[e]}function propagatePlayerLeave(e,t){const o=new ArrayBuffer(2),i=new DataView(o);BinaryProtocol.writeUint8(i,0,protocol.player_leave),BinaryProtocol.writeUint8(i,1,e);for(const e of connections)if(e!==t&&e.open)try{e.send(o)}catch(e){console.error("Error propagating leave message:",e)}removeRemotePlayer(e)}function monitorMeshHealth(){setInterval((()=>{connections=connections.filter((e=>{if(!e.open){const t=connToSenders.get(e)||new Set;for(const o of t)propagatePlayerLeave(o,e),removeRemotePlayer(o);return connToSenders.delete(e),!1}return!0})),updateConnectionStatus()}),5e3),setInterval((()=>{broadcastPeerList()}),5e3)}function startTechSync(){setInterval(checkAndSendTechUpdates,1e3)}function clampVelocity(e){const t=1e-6;return{x:Math.abs(e.x)<t?0:e.x,y:Math.abs(e.y)<t?0:e.y}}function monitorGameState(e){if(e-lastUpdateTime>=CONFIG.updateInterval&&connections.some((e=>e.open))){if(lastUpdateTime=e,player&&player.position){oldUsername!=username&&(sendUsernameUpdate(),b2.oldUsername=username);let e=clampVelocity(player.velocity);sendPlayerMovement(player.position.x,player.position.y,e.x||0,e.y||0,m.angle||0,m.alive,b.activeGun,simulation.mouseInGame.x||0,simulation.mouseInGame.y||0,m.fieldMode),sendMisc()}else m.alive||sendPlayerMovement(0,0,0,0,0,m.alive,b.activeGun,0,0,m.fieldMode);input&&sendPlayerInput({up:input.up||!1,down:input.down||!1,left:input.left||!1,right:input.right||!1,fire:input.fire||!1,field:input.field||!1}),m.holdingTarget&&"string"==typeof m.holdingTarget.id&&sendBlockUpdate(m.holdingTarget,!0),9==m.fieldMode&&m.hole&&m.hole.pos1&&m.hole.pos2&&sendHole(),6==m.fieldMode&&sendRewind(),4==m.fieldMode&&sendMode();const t=Date.now();for(const e of body)e&&!e.remoteBlock&&"string"==typeof e.id&&(!e._lastBlockUpdate||t-e._lastBlockUpdate>=block_update_interval)&&(sendBlockUpdate(e),e._lastBlockUpdate=t);sendPlayerLevel(level.onLevel)}requestAnimationFrame(monitorGameState)}function updateConnectionStatus(){const e=connections.filter((e=>e.open)).length;e>0?updateStatus(`Connected to ${e} peers`,"status-connected"):updateStatus("Disconnected","status-disconnected")}function reconnect(){if(peer)try{const e=connManager.reconnect();e&&e!==peer&&(peer=e),updateStatus("Reconnecting...","status-connecting"),console.log("[P2P] Attempting to reconnect with same ID:",peer&&peer.id)}catch(e){updateStatus("Error: reconnect failed","status-disconnected"),console.warn("[P2P] reconnect failed:",e)}}function buildSafeRemoveFns(){for(let e=0;e<tech.tech.length;e++){const t=tech.tech[e];if("function"==typeof t.remove){const e=t.remove.toString().split("\n").map((e=>e.trim())).filter((e=>e.startsWith("tech.")&&e.includes("="))).map((e=>e.replace(/^tech\./,"remotePlayers[id].tech.")));if(e.length>0)try{t.safeRemove=new Function("id",e.join("\n"))}catch(e){t.safeRemove=function(){}}else t.safeRemove=function(){}}else t.safeRemove=function(){}}}function safeRemoveAllTechForPlayer(e){if(remotePlayers[e]&&remotePlayers[e].tech){for(let t=0;t<tech.tech.length;t++)if("function"==typeof tech.tech[t].safeRemove)try{tech.tech[t].safeRemove(e)}catch(e){console.error("error",tech.tech[t].name,e)}remotePlayers[e].tech.removeCount=0,remotePlayers[e].tech.duplication=0,remotePlayers[e].tech.extraMaxHealth=0,remotePlayers[e].tech.totalCount=0,remotePlayers[e].tech.junkChance=0}}setInterval(validateUsernames,5e3),initTechList(),startTechSync(),connManager.onOpen((e=>{document.getElementById("p2p-id-display").textContent=e,updateStatus("Ready to connect","status-disconnected"),log("PeerJS initialized with ID: "+e),requestAnimationFrame(monitorGameState),monitorMeshHealth()})).onConnection((e=>{setupConnection(e)})).onError((e=>{"disconnected"==e&&(simulation.inGameConsole("connection probably lost. attemping reconnect"),reconnect()),updateStatus("Error: "+e.type,"status-disconnected")})),document.getElementById("p2p-connect").addEventListener("click",(()=>{const e=document.getElementById("p2p-remote-id").value.trim();if(!e)return alert("Please enter a Peer ID");updateStatus("Connecting...","status-connecting");const t=connManager.connectTo(e);t.on("open",(()=>setupConnection(t))),t.on("error",(e=>{log("Connection failed: "+e,"error"),updateStatus("Connection failed","status-disconnected")}))}));const oldSimulation=simulation.startGame;simulation.startGame=()=>{oldSimulation();for(const e in remotePlayers)remotePlayers.hasOwnProperty(e)&&delete remotePlayers[e];buildSafeRemoveFns(),requestTechUpdate(),validateUsernames(),simulation.ephemera.push({name:"personal best",do(){if(m.isTimeDilated)for(const e in remotePlayers)remotePlayers[e].do()}})};const oldNext=level.nextLevel;function pm(obj,methodName,replacements){if("function"!=typeof obj[methodName])throw new Error(`${methodName} is not a function`);let fnStr=obj[methodName].toString();for(const[e,t]of replacements)fnStr=fnStr.replace(e,t);/^function/.test(fnStr)||(fnStr="function "+fnStr);try{obj[methodName]=eval(`(${fnStr})`)}catch(e){}}function wrapAllBulletFunctions(e){const t={};for(const[o,i]of Object.entries(e))if("function"==typeof i){let e=i.toString().trim();e.startsWith("function")||e.startsWith("(")||e.startsWith("async")||(e="function "+e),e=e.replace(/\bplayer(?=\s*[\.\[])/g,"remotePlayers[id]"),e=e.replace(/\bplayer\b/g,"remotePlayers[id]"),e=e.replace(/\btech\./g,"remotePlayers[id].tech."),e=e.replace(/\bb\.fireAttributes\s*\(([^)]*)\)/g,"b2.fireAttributes($1, id)"),e=e.replace(/\bComposite\.add\s*\(\s*engine\.world\s*,\s*bullet\[me\]\s*\)\s*;/g,"Composite.add(engine.world, bullet[me]); bullet[me].remoteBullet = true; bullet[me].collisionFilter.group = -id;");const l=e.match(/function\s*[^(]*\(([^)]*)\)/);if(l){let t=l[1].trim();const o=t?t.split(",").map((e=>e.trim())).filter(Boolean):[];o.includes("id")||(t=t?`${t}, id`:"id",e=e.replace(/\([^)]*\)/,`(${t})`))}let s;try{s=new Function(`return (${e});`)()}catch(e){s=i}t[o]=s}else t[o]=i;return t}function sha256(e){let t=2166136261;for(let o=0;o<e.length;o++)t^=e.charCodeAt(o),t=16777619*t>>>0;return t.toString()}function deterministicBlockId(e,t,o,i){return sha256(`${e},${JSON.stringify(t)},${o}${i}`)}function removeLocalBlock(e){if(!e)return;e.remoteBlock||"number"!=typeof e.id||sendBlockRemove(e.id),Composite.remove(engine.world,e);const t=body.indexOf(e);-1!==t&&body.splice(t,1),knownBlocks.delete(e.id)}function spawnPlayer(e,t,o){mobs.spawn(0,0,6,20,"transparent");let l=mob[mob.length-1];Composite.remove(engine.world,l);let s=Vertices.fromPath("0,40, 50,40, 50,115, 30,130, 20,130, 0,115, 0,40"),a=Bodies.fromVertices(e,t,s,{collisionFilter:{category:cat.mob,mask:cat.player|cat.map|cat.body|cat.bullet|cat.mob},alive:!0}),r=Bodies.rectangle(e,t+46,36,6,{sleepThreshold:99999999999,isSensor:!0,collisionFilter:{category:cat.mob,mask:cat.player|cat.map|cat.body|cat.bullet|cat.mob},alive:!0});s=Vertices.fromPath("16 -82 2 -66 2 -37 43 -37 43 -66 30 -82");let n=Bodies.fromVertices(e,t-55,s,{collisionFilter:{category:cat.mob,mask:cat.player|cat.map|cat.body|cat.bullet|cat.mob}}),c=Bodies.rectangle(e,t-57,48,45,{sleepThreshold:99999999999,isSensor:!0,collisionFilter:{category:cat.mob,mask:cat.player|cat.map|cat.body|cat.bullet|cat.mob},alive:!0});function h(e,t,o){return e+(t-e)*o}return Body.setParts(l,[a,n,r,c]),l.id=o,l.username="unnamed player",l.inertia=1/0,l.mob=!0,l.friction=.002,l.frictionAir=.001,l.restitution=0,l.stroke="transparent",l.showHealthBar=!1,l.sleepThreshold=1/0,l.collisionFilter.category=cat.mob,l.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob,l.collisionFilter.group=-o,l.Fx=.016,l.fxAir=.016,l.jumpForce=.42,l.setMovement=function(){l.Fx=l.tech.baseFx*m.fieldFx*m.squirrelFx*(l.tech.isFastTime?1.5:1)/l.mass,l.jumpForce=l.tech.baseJumpForce*m.fieldJump*m.squirrelJump*(tech.isFastTime?1.13:1)/l.mass/l.mass},l.airSpeedLimit=125,l.onGround=!1,l.lastOnGroundCycle=0,l.coyoteCycles=5,l.hardLanding=130,l.numTouching=0,l.crouch=!1,l.yOff=70,l.yOffGoal=70,l.standingOn=void 0,l.pos={x:0,y:0},l.eyeFillColor=null,l.fillColor=null,l.fillColorDark=null,l.bodyGradient=null,l.color={hue:0,sat:0,light:100},l.immuneCycle=0,l.cycle=0,l.setFillColors=function(){l.fillColor=`hsl(${l.color.hue},${l.color.sat}%,${l.color.light}%)`,l.fillColorDark=`hsl(${l.color.hue},${l.color.sat}%,${l.color.light-25}%)`;let e=ctx.createLinearGradient(-30,0,30,0);e.addColorStop(0,l.fillColorDark),e.addColorStop(1,l.fillColor),l.bodyGradient=e},l.angle2=0,l.buttonCD_jump=0,l.walk_cycle=0,l.stepSize=0,l.flipLegs=-1,l.hip={x:12,y:24},l.knee={x:0,y:0,x2:0,y2:0},l.foot={x:0,y:0},l.legLength1=55,l.legLength2=45,l.height=42,l.yOffWhen={crouch:22,stand:49,jump:70},l.tech={fireRate:1,bulletSize:null,energySiphon:null,healSpawn:null,crouchAmmoCount:null,bulletsLastLonger:null,isImmortal:null,sporesOnDeath:null,isImmuneExplosion:null,isExplodeMob:null,isDroneOnDamage:null,isAcidDmg:null,isAnnihilation:null,largerHeals:null,isCrit:null,isLowHealthDmg:null,isLowHealthDefense:null,isLowHealthFireRate:null,isFarAwayDmg:null,isFirstDer:null,isMassEnergy:null,extraChoices:null,laserBotCount:null,dynamoBotCount:null,nailBotCount:null,foamBotCount:null,soundBotCount:null,boomBotCount:null,plasmaBotCount:null,missileBotCount:null,orbitBotCount:null,blockDmg:null,isBlockRadiation:null,isPiezo:null,isFastDrones:null,oneSuperBall:null,laserReflections:null,laserDamage:null,isAmmoFromHealth:null,mobSpawnWithHealth:null,isEnergyRecovery:null,isHealthRecovery:null,isEnergyLoss:null,isDeathAvoid:null,isDeathAvoidedThisLevel:null,isPlasmaRange:null,isFreezeMobs:null,isIceCrystals:null,blockDamage:null,isBlockStun:null,isStunField:null,isHarmDamage:null,isVacuumBomb:null,renormalization:null,fragments:null,energyDamage:null,botSpawner:null,isBotSpawnerReset:null,isSporeFollow:null,isNailRadiation:null,isEnergyHealth:null,isStun:null,restDamage:null,isRPG:null,missileCount:null,isDeterminism:null,isSuperDeterminism:null,isHarmReduce:null,nailsDeathMob:null,isSlowFPS:null,isNeutronStun:null,isAnsatz:null,isDamageFromBulletCount:null,laserDrain:null,isNailShot:null,slowFire:null,fastTime:null,isFastRadiation:null,isAmmoForGun:null,isRapidPulse:null,isSporeFreeze:null,isShotgunRecoil:null,isHealLowHealth:null,isAoESlow:null,isHarmArmor:null,isTurret:null,isRerollDamage:null,isHarmFreeze:null,isBotArmor:null,isRerollHaste:null,researchHaste:null,isMineDrop:null,isRerollBots:null,isNailBotUpgrade:null,isFoamBotUpgrade:null,isSoundBotUpgrade:null,isLaserBotUpgrade:null,isBoomBotUpgrade:null,isOrbitBotUpgrade:null,isDroneGrab:null,isOneGun:null,isDamageForGuns:null,isGunCycle:null,isFastFoam:null,isSporeGrowth:null,isStimulatedEmission:null,nailInstantFireRate:null,isCapacitor:null,isEnergyNoAmmo:null,isSmallExplosion:null,isExplosionHarm:null,extraMaxHealth:null,isIntangible:null,isCloakStun:null,bonusEnergy:null,healMaxEnergyBonus:0,slowFireDamage:null,isNoFireDefense:null,isNoFireDamage:null,duplicateChance:null,beamSplitter:null,iceEnergy:null,isPerfectBrake:null,explosiveRadius:null,isWormholeDamage:null,isNailCrit:null,isFlechetteExplode:null,isWormholeWorms:null,isWormHoleBullets:null,isWideLaser:null,wideLaser:null,isPulseLaser:null,isRadioactive:null,radioactiveDamage:null,isRailEnergy:null,isMineSentry:null,isIncendiary:null,overfillDrain:null,isNeutronSlow:null,historyLaser:null,isSpeedHarm:null,isSpeedDamage:null,speedAdded:null,isTimeSkip:null,isCancelDuplication:null,duplication:null,isCancelRerolls:null,isCancelTech:null,cancelTechCount:null,isBotDamage:null,isBanish:null,isRetain:null,isMaxEnergyTech:null,isLowEnergyDamage:null,isRewindBot:null,isRewindGrenade:null,isExtruder:null,isEndLevelPowerUp:null,isMissileBig:null,isMissileBiggest:null,isMissileFast:null,isMissile2ndExplode:null,isLaserMine:null,isFoamMine:null,isAmmoFoamSize:null,isIceIX:null,isDupDamage:null,isDupEnergy:null,isFireRateForGuns:null,cyclicImmunity:null,isTechDamage:null,isRestHarm:null,isFireMoveLock:null,isRivets:null,isNeedles:null,isExplodeRadio:null,isPauseSwitchField:null,isPauseEjectTech:null,pauseEjectTech:null,isShieldPierce:null,isDuplicateMobs:null,isDynamoBotUpgrade:null,isBlockPowerUps:null,isHarmReduceNoKill:null,isSwitchReality:null,isResearchReality:null,isAnthropicDamage:null,isMetaAnalysis:null,isFoamAttract:null,droneCycleReduction:null,droneEnergyReduction:null,isHalfHeals:null,isAlwaysFire:null,isDroneRespawn:null,deathSpawns:null,isMobBlockFling:null,isPhaseVelocity:null,waveBeamSpeed:null,wavePacketAmplitude:null,isCollisionRealitySwitch:null,iceIXOnDeath:null,wimpCount:null,isAddBlockMass:null,isDarkMatter:null,isHarmDarkMatter:null,isMoveDarkMatter:null,isNotDarkMatter:null,isSneakAttack:null,isFallingDamage:null,harmonics:null,isStandingWaveExpand:null,isTokamak:null,isTokamakHeal:null,tokamakHealCount:null,isTokamakFly:null,deflectEnergy:null,superBallDelay:null,isBlockExplode:null,isOverHeal:null,isDroneRadioactive:null,droneRadioDamage:null,isDroneTeleport:null,isDroneFastLook:null,isBulletTeleport:null,isJunkResearch:null,laserColor:null,laserColorAlpha:null,isLongitudinal:null,is360Longitudinal:null,isShotgunReversed:null,fieldDuplicate:null,isCloakingDamage:null,harmonicEnergy:null,isFieldHarmReduction:null,isFastTime:null,isAnthropicTech:null,isSporeWorm:null,isSporeFlea:null,isFoamShot:null,isIceShot:null,isBlockRestitution:null,isZeno:null,isFieldFree:null,isExtraGunField:null,isBigField:null,isSmartRadius:null,isFilament:null,isLargeHarpoon:null,extraHarpoons:null,ammoCap:null,isHarpoonPowerUp:null,harpoonDensity:null,isAddRemoveMaxHealth:null,cloakDuplication:null,extruderRange:null,isForeverDrones:null,nailRecoil:null,baseJumpForce:null,baseFx:null,isNeutronium:null,isFreeWormHole:null,isCrouchRegen:null,isAxion:null,isDarkEnergy:null,isDarkStar:null,isWormholeMapIgnore:null,isLessDamageReduction:null,needleTunnel:null,isBrainstorm:null,isBrainstormActive:null,brainStormDelay:null,wormSize:null,extraSuperBalls:null,isTimeCrystals:null,isGroundState:null,isRailGun:null,isDronesTravel:null,isTechDebt:null,isPlasmaBall:null,plasmaDischarge:null,missileFireCD:null,isBotField:null,isFoamBall:null,isNoDraftPause:null,isFoamPressure:null,foamDamage:null,isClusterExplode:null,isCircleExplode:null,isPetalsExplode:null,isVerlet:null,isIceMaxHealthLoss:null,isIceKill:null,isCritKill:null,isQuantumEraser:null,isPhononBlock:null,isPhononWave:null,isLaserLens:null,laserCrit:null,isSporeColony:null,isExtraBotOption:null,isLastHitDamage:null,isCloakHealLastHit:null,isRicochet:null,isCancelCouple:null,isCouplingPowerUps:null,isBoostPowerUps:null,isBoostReplaceAmmo:null,isInfiniteWaveAmmo:null,isJunkDNA:null,buffedGun:0,isGunChoice:null,railChargeRate:null,isSuperHarm:null,isZombieMobs:null,isSuperMine:null,sentryAmmo:null,collidePowerUps:null,isDilate:null,isDiaphragm:null,isOffGroundDamage:null,isSuperBounce:null,isDivisor:null,isFoamCavitation:null,isHealAttract:null,isLaserField:null,isHealBrake:null,isMassProduction:null,isPrinter:null,isHookDefense:null,hookNails:null,isHarpoonDefense:null,isReel:null,harpoonPowerUpCycle:null,isHarpoonFullHealth:null,isMobFullHealthCloak:null,isMobLowHealth:null,isDamageCooldown:null,isDamageCooldownTime:null,isPowerUpDamage:null,isExitPrompt:null,isResearchDamage:null,isResearchHeal:null,interestRate:null,isImmunityDamage:null,isMobDeathImmunity:null,isMaxHealthDefense:null,noDefenseSettingDamage:null,isMaxHealthDamage:null,isEjectOld:null,isWiki:null,isStaticBlock:null,isDamageFieldTech:null,isRemineralize:null,mineralDamageReduction:null,isDemineralize:null,mineralDamage:null,negativeMassCost:null,beamCollimator:null,isInPilot:null,isNoPilotCost:null,isPlasmaBoost:null,isControlPlasma:null,energyDefense:null,isNewWormHoleDamage:null,isNoDeath:null,isDeathTech:null,isDeathTechTriggered:null,isRebar:null,isMaul:null,isTargeting:null,isBreakHarpoon:null,isBreakHarpoonGain:null,isExponential:null,isCoyote:null,isNitinol:null,isEndothermic:null,isPrecision:null},l.onGroundCheck=function(e){function t(){if(l.numTouching++,!l.onGround)if(l.onGround=!0,l.crouch)l.checkHeadClear()?l.undoCrouch():l.yOffGoal=l.yOffWhen.crouch;else{const e=player.velocity.y*player.mass;e>l.hardLanding?(l.doCrouch(),l.yOff=l.yOffWhen.jump,l.hardLandCD=l.cycle+l.hardLandCDScale*Math.min(e/6.5-6,40),tech.isFallingDamage&&l.immuneCycle<l.cycle&&e>150&&(l.damage(Math.min(.01*Math.sqrt(e-133),.25)),l.immuneCycle<l.cycle+l.collisionImmuneCycles&&(l.immuneCycle=l.cycle+l.collisionImmuneCycles))):l.yOffGoal=l.yOffWhen.stand}}const o=e.pairs;for(let e=0,i=o.length;e!=i;++e){let i=o[e];i.bodyA===r?(l.standingOn=i.bodyB,(!0!==l.standingOn.alive||l.immuneCycle>l.cycle)&&t()):i.bodyB===r&&(l.standingOn=i.bodyA,(!0!==l.standingOn.alive||l.immuneCycle>l.cycle)&&t())}l.numTouching=0},l.offGroundCheck=function(e){const t=e.pairs;for(let e=0,o=t.length;e!=o;++e)t[e].bodyA!==r&&t[e].bodyB!==r||l.onGround&&0===l.numTouching&&(l.onGround=!1,l.lastOnGroundCycle=l.cycle,l.hardLandCD=0,l.checkHeadClear()&&(l.crouch&&l.undoCrouch(),l.yOffGoal=l.yOffWhen.jump))},l.checkHeadClear=function(){return!(Matter.Query.collides(c,map).length>0)},l.collisionChecks=function(e){const t=e.pairs;for(let i=0,s=t.length;i!=s;i++)if(l.alive){let r=t[i].bodyA,c=t[i].bodyB;function o(e){if("bullet"===e.classType&&e.speed>e.minDmgSpeed&&!e.remoteBullet){e.beforeDmg(l);let o=e.dmg+.15*e.mass*Vector.magnitude(Vector.sub(l.velocity,e.velocity));return tech.isCrit&&l.isStunned&&(o*=4),l.damage(o),l.alive&&l.foundPlayer(),l.damageReduction&&simulation.drawList.push({x:t[i].activeContacts[0].vertex.x,y:t[i].activeContacts[0].vertex.y,radius:40*Math.log(o+1.1)*l.damageReduction+3,color:simulation.playerDmgColor,time:simulation.drawTime}),void(tech.isLessDamageReduction&&!l.shield&&(l.damageReduction*=l.isBoss?l.isFinalBoss?1.0005:1.0025:1.05))}if("body"===e.classType&&e.speed>6){const o=Vector.magnitude(Vector.sub(l.velocity,e.velocity));if(o>9){tech.blockDmg&&(Matter.Body.setVelocity(l,{x:.5*l.velocity.x,y:.5*l.velocity.y}),!tech.isBlockRadiation||l.isShielded||l.isMobBullet?(l.damage(tech.blockDmg),simulation.drawList.push({x:t[i].activeContacts[0].vertex.x,y:t[i].activeContacts[0].vertex.y,radius:28*l.damageReduction+3,color:"rgba(255,0,255,0.8)",time:4})):mobs.statusDoT(l,.42*tech.blockDmg,180));let s=tech.blockDamage*o*e.mass*(tech.isMobBlockFling?2.5:1)*(tech.isBlockRestitution?2.5:1)*(0===m.fieldMode||8===m.fieldMode?1+.05*m.coupling:1);l.isShielded&&(s*=.7),l.damage(s,!0),tech.isBlockPowerUps&&!l.alive&&l.isDropPowerUp&&Math.random()<.5&&(options=["coupling","boost","heal","research"],tech.isEnergyNoAmmo||options.push("ammo"),powerUps.spawn(l.position.x,l.position.y,options[Math.floor(Math.random()*options.length)]));const a=s/Math.sqrt(e.mass);return a>.5&&l.memory!==1/0&&mobs.statusStun(l,60+60*Math.sqrt(a)),l.alive&&l.distanceToPlayer2()<1e6&&!m.isCloak&&l.foundPlayer(),tech.fragments&&e.speed>10&&!e.hasFragmented&&(e.hasFragmented=!0,b.targetedNail(e.position,4*tech.fragments)),void(l.damageReduction&&simulation.drawList.push({x:t[i].activeContacts[0].vertex.x,y:t[i].activeContacts[0].vertex.y,radius:40*Math.log(s+1.1)*l.damageReduction+3,color:simulation.playerDmgColor,time:simulation.drawTime}))}}}r===l||r===a||r===n?o(t[i].bodyB):c!==l&&c!==a&&c!==n||o(t[i].bodyA)}},Matter.Body.setMass(l,m.mass),Composite.add(engine.world,l),l.drawLeg=function(e){},l.calcLeg=function(e,t){l.hip.x=12+t,l.hip.y=24+t,l.stepSize=.8*l.stepSize+7*Math.sqrt(Math.min(9,Math.abs(l.Vx)))*l.onGround*.2;const o=.034*l.walk_cycle+e;l.foot.x=2.2*l.stepSize*Math.cos(o)+t,l.foot.y=t+1.2*l.stepSize*Math.sin(o)+l.yOff+l.height;const i=l.yOff+l.height;l.foot.y>i&&(l.foot.y=i);const s=Math.sqrt((l.hip.x-l.foot.x)*(l.hip.x-l.foot.x)+(l.hip.y-l.foot.y)*(l.hip.y-l.foot.y)),a=(l.legLength1*l.legLength1-l.legLength2*l.legLength2+s*s)/(2*s),r=Math.sqrt(l.legLength1*l.legLength1-a*a);l.knee.x=a/s*(l.foot.x-l.hip.x)-r/s*(l.foot.y-l.hip.y)+l.hip.x+t,l.knee.y=a/s*(l.foot.y-l.hip.y)+r/s*(l.foot.x-l.hip.x)+l.hip.y},l.draw=function(){},l.resetSkin=function(){l.hardLandCDScale=1,l.yOffWhen.jump=70,l.yOffWhen.stand=49,l.yOffWhen.crouch=22,l.isAltSkin=!1,l.coyoteCycles=5,l.hardLanding=130,l.squirrelFx=1,l.squirrelJump=1,l.velocitySmooth={x:0,y:0},requestAnimationFrame((()=>{l.setMovement()})),l.color={hue:0,sat:0,light:100},l.setFillColors(),l.draw=function(){ctx.fillStyle=l.fillColor,l.walk_cycle+=l.flipLegs*l.Vx,ctx.save(),ctx.globalAlpha=l.immuneCycle<l.cycle?1:.5,ctx.translate(l.pos.x,l.pos.y),l.calcLeg(Math.PI,-3),l.drawLeg("#4a4a4a"),l.calcLeg(0,0),l.drawLeg("#333"),ctx.rotate(l.angle2),ctx.beginPath(),ctx.arc(0,0,30,0,2*Math.PI),ctx.fillStyle=l.bodyGradient,ctx.fill(),ctx.arc(15,0,4,0,2*Math.PI),ctx.strokeStyle="#333",ctx.lineWidth=2,ctx.stroke(),ctx.restore(),l.yOff=.85*l.yOff+.15*l.yOffGoal},l.drawLeg=function(e){l.angle2>-Math.PI/2&&l.angle2<Math.PI/2?l.flipLegs=1:l.flipLegs=-1,ctx.save(),ctx.scale(l.flipLegs,1),ctx.beginPath(),ctx.moveTo(l.hip.x,l.hip.y),ctx.lineTo(l.knee.x,l.knee.y),ctx.lineTo(l.foot.x,l.foot.y),ctx.strokeStyle=e,ctx.lineWidth=5,ctx.stroke(),ctx.beginPath(),ctx.moveTo(l.foot.x,l.foot.y),l.onGround?(ctx.lineTo(l.foot.x-14,l.foot.y+5),ctx.moveTo(l.foot.x,l.foot.y),ctx.lineTo(l.foot.x+14,l.foot.y+5)):(ctx.lineTo(l.foot.x-12,l.foot.y+8),ctx.moveTo(l.foot.x,l.foot.y),ctx.lineTo(l.foot.x+12,l.foot.y+8)),ctx.lineWidth=4,ctx.stroke(),ctx.beginPath(),ctx.arc(l.hip.x,l.hip.y,9,0,2*Math.PI),ctx.moveTo(l.knee.x+5,l.knee.y),ctx.arc(l.knee.x,l.knee.y,5,0,2*Math.PI),ctx.moveTo(l.foot.x+4,l.foot.y+1),ctx.arc(l.foot.x,l.foot.y+1,4,0,2*Math.PI),ctx.fillStyle=l.fillColor,ctx.fill(),ctx.lineWidth=2,ctx.stroke(),ctx.restore()}},Events.on(engine,"collisionStart",(function(e){l.onGroundCheck(e),l.collisionChecks(e)})),Events.on(engine,"collisionActive",(function(e){l.onGroundCheck(e)})),Events.on(engine,"collisionEnd",(function(e){l.offGroundCheck(e)})),l.resetSkin(),l.jump=function(){l.buttonCD_jump=l.cycle,l.force.y=-l.jumpForce},l.doCrouch=function(){l.crouch||(l.crouch=!0,l.yOffGoal=l.yOffWhen.crouch,n.position.y-l.position.y<0&&Matter.Body.setPosition(n,{x:l.position.x,y:l.position.y+9.1740767}))},l.undoCrouch=function(){l.crouch&&(l.crouch=!1,l.yOffGoal=l.yOffWhen.stand,n.position.y-l.position.y>0&&Matter.Body.setPosition(n,{x:l.position.x,y:l.position.y-30.28592321}))},l.groundControl=function(){const e=l.inputDown;if(l.checkHeadClear()?l.inputDown=e:l.inputDown=!0,l.crouch?!l.inputDown&&l.checkHeadClear()&&l.hardLandCD<l.cycle&&l.undoCrouch():l.inputDown||l.hardLandCD>l.cycle?l.doCrouch():l.inputUp&&l.buttonCD_jump+20<l.cycle&&l.jump(),l.inputLeft)l.force.x-=l.Fx;else if(l.inputRight)l.force.x+=l.Fx;else{const e=.92;Matter.Body.setVelocity(l,{x:l.velocity.x*e,y:l.velocity.y*e})}if(l.speed>4){const e=l.crouch?.65:.89;Matter.Body.setVelocity(l,{x:l.velocity.x*e,y:l.velocity.y*e})}},l.airControl=function(){l.inputUp&&l.buttonCD_jump+20<l.cycle&&l.lastOnGroundCycle+l.coyoteCycles>l.cycle&&l.jump(),l.buttonCD_jump+60>l.cycle&&!l.inputUp&&l.Vy<0&&Matter.Body.setVelocity(l,{x:l.velocity.x,y:.94*l.velocity.y}),l.inputLeft?l.velocity.x>-l.airSpeedLimit/l.mass/l.mass&&(l.force.x-=l.fxAir):l.inputRight&&l.velocity.x<l.airSpeedLimit/l.mass/l.mass&&(l.force.x+=l.fxAir)},l.muzzleFlash=(e=30)=>{simulation.drawList.push({x:l.pos.x+20*Math.cos(l.angle2),y:l.pos.y+20*Math.sin(l.angle2),radius:e,color:"#fb0",time:1})},l.baseFire=(e,t=30+6*Math.random())=>{b2.nail({x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},{x:.8*l.velocity.x+t*Math.cos(e),y:.5*l.velocity.y+t*Math.sin(e)},l.id),l.tech.isIceCrystals&&(bullet[bullet.length-1].beforeDmg=function(e){mobs.statusSlow(e,120),l.tech.isNailRadiation&&mobs.statusDoT(e,1*(l.tech.isFastRadiation?1.3:.44),l.tech.isSlowRadiation?360:l.tech.isFastRadiation?60:180),l.tech.isNailCrit&&!e.shield&&Vector.dot(Vector.normalise(Vector.sub(e.position,this.position)),Vector.normalise(this.velocity))>.97-1/e.radius&&b.explosion(this.position,150+30*Math.random()),this.ricochet(e)},l.energy<.01?l.fireCDcycle=l.cycle+60:l.energy-=.005)},l.history=[],l.ammo=17,l.mouse={x:0,y:0},l.nextFireCycle=0,l.startingHoldCycle=0,l.fireCDcycle=0,l.fireCDscale=1,l.wavePacketCycle=0,l.delay=40,l.phononWaveCD=0,l.waves=[],l.charge=0,l.isStuckOn=!1,l.angle3=0,l.isInsideArc=e=>{let t=(o=e-l.angle3+Math.PI,i=2*Math.PI,o-Math.floor(o/i)*i-Math.PI);var o,i;return Math.abs(t)<l.arcRange},l.arcRange=.78,l.lensDamage=1,l.lensDamageOn=0,l.lens=()=>{l.stuckOn(),l.angle3+=.03,l.isInsideArc(l.angle)?(l.lensDamage=l.lensDamageOn,ctx.lineWidth=6+l.lensDamageOn):(l.lensDamage=1,ctx.lineWidth=2),ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,60,l.angle3-l.arcRange,l.angle3+l.arcRange),ctx.strokeStyle="#fff",ctx.stroke()},l.stuckOn=()=>{l.tech.isStuckOn&&(l.isStuckOn?(l.inputFire||l.fire(),m.energy<tech.laserDrain+.06&&(this.isStuckOn=!1)):input.fire&&(this.isStuckOn=!0))},l.setGrenadeMode=()=>{grenadeDefault=function(e={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},t=l.angle2,o=1){const i=bullet.length;bullet[i]=Bodies.circle(e.x,e.y,15,b2.fireAttributes(t,!1,l.id)),Matter.Body.setDensity(bullet[i],3e-4),bullet[i].explodeRad=300*o+100*l.tech.isBlockExplode,bullet[i].onEnd=l.grenadeEnd,bullet[i].minDmgSpeed=1,bullet[i].beforeDmg=function(){this.endCycle=0},speed=l.crouch?43:32,Matter.Body.setVelocity(bullet[i],{x:.5*l.velocity.x+speed*Math.cos(t),y:.5*l.velocity.y+speed*Math.sin(t)}),bullet[i].endCycle=simulation.cycle+Math.floor(l.crouch?120:80)*l.tech.bulletsLastLonger,bullet[i].restitution=.4,bullet[i].do=function(){Matter.Query.collides(this,[player]).length>0&&this.beforeDmg(),this.force.y+=.0025*this.mass},Composite.add(engine.world,bullet[i]),l.tech.isPrecision&&(bullet[i].do=function(){this.force.y+=.0025*this.mass;for(let e=0;e<mob.length;e++)!mob[e].isBadTarget&&!mob[e].isInvulnerable&&this.position.y<mob[e].bounds.min.y&&this.position.x>mob[e].position.x-mob[e].radius/2&&this.position.x<mob[e].position.x+mob[e].radius/2&&0===Matter.Query.ray(map,this.position,mob[e].position).length&&0===Matter.Query.ray(body,this.position,mob[e].position).length&&(Matter.Body.setVelocity(this,{x:0,y:4+Math.max(10,this.speed)}),this.do=function(){this.force.y+=.003*this.mass},ctx.strokeStyle="#000",ctx.lineWidth=3,ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(mob[e].position.x,mob[e].position.y),ctx.stroke())})},grenadeRPG=function(e={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},t=l.angle2,o=1){const i=bullet.length;bullet[i]=Bodies.circle(e.x,e.y,15,b2.fireAttributes(t,!1,l.id)),Matter.Body.setDensity(bullet[i],3e-4),bullet[i].explodeRad=300*o+100*l.tech.isBlockExplode,bullet[i].onEnd=l.grenadeEnd,bullet[i].minDmgSpeed=1,bullet[i].beforeDmg=function(){this.endCycle=0},speed=l.crouch?46:32,Matter.Body.setVelocity(bullet[i],{x:.8*l.velocity.x+speed*Math.cos(t),y:.5*l.velocity.y+speed*Math.sin(t)}),Composite.add(engine.world,bullet[i]),bullet[i].endCycle=simulation.cycle+70*l.tech.bulletsLastLonger,bullet[i].frictionAir=.07;bullet[i].thrust={x:.015*bullet[i].mass*Math.cos(t),y:.015*bullet[i].mass*Math.sin(t)},bullet[i].do=function(){Matter.Query.collides(this,[player]).length>0&&this.beforeDmg(),this.force.x+=this.thrust.x,this.force.y+=this.thrust.y,(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)&&(this.endCycle=0)},l.tech.isPrecision&&(bullet[i].do=function(){this.force.x+=this.thrust.x,this.force.y+=this.thrust.y,(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)&&(this.endCycle=0);for(let e=0;e<mob.length;e++)!mob[e].isBadTarget&&!mob[e].isInvulnerable&&this.position.y<mob[e].bounds.min.y&&this.position.x>mob[e].position.x-mob[e].radius/2&&this.position.x<mob[e].position.x+mob[e].radius/2&&0===Matter.Query.ray(map,this.position,mob[e].position).length&&0===Matter.Query.ray(body,this.position,mob[e].position).length&&(Matter.Body.setVelocity(this,{x:0,y:4+Math.max(10,this.speed)}),this.frictionAir=0,this.do=function(){this.force.y+=.003*this.mass},ctx.strokeStyle="#000",ctx.lineWidth=3,ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(mob[e].position.x,mob[e].position.y),ctx.stroke())})},grenadeRPGVacuum=function(e={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},t=l.angle2,o=1){const s=bullet.length;bullet[s]=Bodies.circle(e.x,e.y,15,b2.fireAttributes(t,!1,l.id)),Matter.Body.setDensity(bullet[s],3e-4),bullet[s].explodeRad=350*o+Math.floor(50*Math.random())+100*l.tech.isBlockExplode,bullet[s].onEnd=l.grenadeEnd,bullet[s].minDmgSpeed=1,bullet[s].beforeDmg=function(){Matter.Body.setVelocity(this,{x:0,y:0}),this.endCycle=0},speed=l.crouch?46:32,Matter.Body.setVelocity(bullet[s],{x:.8*l.velocity.x+speed*Math.cos(t),y:.5*l.velocity.y+speed*Math.sin(t)}),Composite.add(engine.world,bullet[s]),bullet[s].endCycle=simulation.cycle+70*l.tech.bulletsLastLonger,bullet[s].frictionAir=.07,bullet[s].suckCycles=40;bullet[s].thrust={x:.015*bullet[s].mass*Math.cos(t),y:.015*bullet[s].mass*Math.sin(t)},bullet[s].suck=function(){const e=(e,o=3.2*this.explodeRad)=>{for(i=0,len=e.length;i<len;i++){const l=Vector.sub(this.position,e[i].position),s=Vector.magnitude(l);s<o&&s>150&&!e.isInvulnerable&&e[i]!==this&&(knock=Vector.mult(Vector.normalise(l),t*e[i].mass/Math.sqrt(s)),e[i].force.x+=knock.x,e[i].force.y+=knock.y)}};let t=.1;simulation.cycle>this.endCycle-5?(t=-.22,e(mob,3*this.explodeRad),e(body,2*this.explodeRad),e(powerUp,1.5*this.explodeRad),e(bullet,1.5*this.explodeRad),e([l],1.3*this.explodeRad)):(t=.11,e(mob,3*this.explodeRad),e(body,2*this.explodeRad),e(powerUp,1.5*this.explodeRad),e(bullet,1.5*this.explodeRad),e([l],1.3*this.explodeRad)),Matter.Body.setVelocity(this,{x:0,y:0});const o=2.75*this.explodeRad*(this.endCycle-simulation.cycle)/this.suckCycles;ctx.fillStyle="rgba(0,0,0,0.1)",ctx.beginPath(),ctx.arc(this.position.x,this.position.y,o,0,2*Math.PI),ctx.fill()},bullet[s].do=function(){Matter.Query.collides(this,[player]).length>0&&this.beforeDmg(),simulation.cycle>this.endCycle-this.suckCycles?this.do=this.suck:Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length?(Matter.Body.setPosition(this,Vector.sub(this.position,this.velocity)),this.do=this.suck):(this.force.x+=this.thrust.x,this.force.y+=this.thrust.y)},l.tech.isPrecision&&(bullet[s].do=function(){simulation.cycle>this.endCycle-this.suckCycles?this.do=this.suck:Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length?(Matter.Body.setPosition(this,Vector.sub(this.position,this.velocity)),this.do=this.suck):(this.force.x+=this.thrust.x,this.force.y+=this.thrust.y);for(let e=0;e<mob.length;e++)!mob[e].isBadTarget&&!mob[e].isInvulnerable&&this.position.y<mob[e].bounds.min.y&&this.position.x>mob[e].position.x-mob[e].radius/2&&this.position.x<mob[e].position.x+mob[e].radius/2&&0===Matter.Query.ray(map,this.position,mob[e].position).length&&0===Matter.Query.ray(body,this.position,mob[e].position).length&&(Matter.Body.setVelocity(this,{x:0,y:4+Math.max(10,this.speed)}),this.frictionAir=0,this.do=function(){simulation.cycle>this.endCycle-this.suckCycles?this.do=this.suck:(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)&&(Matter.Body.setPosition(this,Vector.sub(this.position,this.velocity)),this.do=this.suck)},ctx.strokeStyle="#000",ctx.lineWidth=3,ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(mob[e].position.x,mob[e].position.y),ctx.stroke())})},grenadeVacuum=function(e={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},t=l.angle2,o=1){const s=bullet.length;bullet[s]=Bodies.circle(e.x,e.y,20,b2.fireAttributes(t,!1,l.id)),Matter.Body.setDensity(bullet[s],2e-4),bullet[s].explodeRad=350*o+Math.floor(50*Math.random())+100*l.tech.isBlockExplode,bullet[s].onEnd=l.grenadeEnd,bullet[s].beforeDmg=function(){Matter.Body.setVelocity(this,{x:0,y:0}),this.endCycle=0},bullet[s].restitution=.4,bullet[s].do=function(){if(Matter.Query.collides(this,[player]).length>0&&this.beforeDmg(),this.force.y+=.0025*this.mass,simulation.cycle>this.endCycle-40){const t=this;function e(e,l=3.2*t.explodeRad){for(i=0,len=e.length;i<len;i++){const s=Vector.sub(t.position,e[i].position),a=Vector.magnitude(s);a<l&&a>150&&!e.isInvulnerable&&(knock=Vector.mult(Vector.normalise(s),o*e[i].mass/Math.sqrt(a)),e[i].force.x+=knock.x,e[i].force.y+=knock.y)}}let o=.1;simulation.cycle>this.endCycle-5?(o=-.22,e(mob,3*this.explodeRad),e(body,2*this.explodeRad),e(powerUp,1.5*this.explodeRad),e(bullet,1.5*this.explodeRad),e([l],1.3*this.explodeRad)):(o=.11,e(mob,3*this.explodeRad),e(body,2*this.explodeRad),e(powerUp,1.5*this.explodeRad),e(bullet,1.5*this.explodeRad),e([l],1.3*this.explodeRad)),Matter.Body.setVelocity(this,{x:0,y:0});const s=2.75*this.explodeRad*(this.endCycle-simulation.cycle)/40;ctx.fillStyle="rgba(0,0,0,0.1)",ctx.beginPath(),ctx.arc(this.position.x,this.position.y,s,0,2*Math.PI),ctx.fill()}},speed=35,bullet[s].endCycle=simulation.cycle+70*l.tech.bulletsLastLonger,l.crouch&&(speed+=9,bullet[s].endCycle+=20),Matter.Body.setVelocity(bullet[s],{x:.5*l.velocity.x+speed*Math.cos(t),y:.5*l.velocity.y+speed*Math.sin(t)}),Composite.add(engine.world,bullet[s]),l.tech.isPrecision&&(bullet[s].do=function(){this.force.y+=.0025*this.mass;if(simulation.cycle>this.endCycle-40){const t=this;function e(e,l=3.2*t.explodeRad){for(i=0,len=e.length;i<len;i++){const s=Vector.sub(t.position,e[i].position),a=Vector.magnitude(s);a<l&&a>150&&!e.isInvulnerable&&(knock=Vector.mult(Vector.normalise(s),o*e[i].mass/Math.sqrt(a)),e[i].force.x+=knock.x,e[i].force.y+=knock.y)}}let o=.1;simulation.cycle>this.endCycle-5?(o=-.22,e(mob,3*this.explodeRad),e(body,2*this.explodeRad),e(powerUp,1.5*this.explodeRad),e(bullet,1.5*this.explodeRad),e([l],1.3*this.explodeRad)):(o=.11,e(mob,3*this.explodeRad),e(body,2*this.explodeRad),e(powerUp,1.5*this.explodeRad),e(bullet,1.5*this.explodeRad),e([l],1.3*this.explodeRad)),Matter.Body.setVelocity(this,{x:0,y:0});const s=2.75*this.explodeRad*(this.endCycle-simulation.cycle)/40;ctx.fillStyle="rgba(0,0,0,0.1)",ctx.beginPath(),ctx.arc(this.position.x,this.position.y,s,0,2*Math.PI),ctx.fill()}for(let a=0;a<mob.length;a++)!mob[a].isBadTarget&&!mob[a].isInvulnerable&&this.position.y<mob[a].bounds.min.y&&this.position.x>mob[a].position.x-mob[a].radius/2&&this.position.x<mob[a].position.x+mob[a].radius/2&&0===Matter.Query.ray(map,this.position,mob[a].position).length&&0===Matter.Query.ray(body,this.position,mob[a].position).length&&(Matter.Body.setVelocity(this,{x:0,y:4+Math.max(10,this.speed)}),this.do=function(){this.force.y+=.0025*this.mass;if(simulation.cycle>this.endCycle-40){const t=this;function e(e,i=3.2*t.explodeRad){for(a=0,len=e.length;a<len;a++){const l=Vector.sub(t.position,e[a].position),s=Vector.magnitude(l);s<i&&s>150&&!e.isInvulnerable&&(knock=Vector.mult(Vector.normalise(l),o*e[a].mass/Math.sqrt(s)),e[a].force.x+=knock.x,e[a].force.y+=knock.y)}}let o=.1;simulation.cycle>this.endCycle-5?(o=-.22,e(mob,3*this.explodeRad),e(body,2*this.explodeRad),e(powerUp,1.5*this.explodeRad),e(bullet,1.5*this.explodeRad),e([l],1.3*this.explodeRad)):(o=.11,e(mob,3*this.explodeRad),e(body,2*this.explodeRad),e(powerUp,1.5*this.explodeRad),e(bullet,1.5*this.explodeRad),e([l],1.3*this.explodeRad)),Matter.Body.setVelocity(this,{x:0,y:0});const i=2.75*this.explodeRad*(this.endCycle-simulation.cycle)/40;ctx.fillStyle="rgba(0,0,0,0.1)",ctx.beginPath(),ctx.arc(this.position.x,this.position.y,i,0,2*Math.PI),ctx.fill()}},ctx.strokeStyle="#000",ctx.lineWidth=3,ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(mob[a].position.x,mob[a].position.y),ctx.stroke())})},grenadeNeutron=function(e={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},t=l.angle2,o=1){const s=bullet.length;if(bullet[s]=Bodies.polygon(e.x,e.y,10,4,b2.fireAttributes(t,!1,l.id)),b2.fireProps((l.crouch?45:25)/Math.pow(.92,l.tech.missileCount),l.crouch?35:20,t,l),Matter.Body.setDensity(bullet[s],1e-6),bullet[s].endCycle=500+simulation.cycle,bullet[s].frictionAir=0,bullet[s].friction=1,bullet[s].frictionStatic=1,bullet[s].restitution=0,bullet[s].minDmgSpeed=0,bullet[s].damageRadius=100,bullet[s].maxDamageRadius=450*o+130*l.tech.isNeutronSlow,bullet[s].radiusDecay=(.81+.15*l.tech.isNeutronSlow)/l.tech.bulletsLastLonger,bullet[s].stuckTo=null,bullet[s].stuckToRelativePosition=null,l.tech.isRPG){const e=2;Matter.Body.scale(bullet[s],e,e),speed=l.crouch?25:15,Matter.Body.setVelocity(bullet[s],{x:.5*l.velocity.x+speed*Math.cos(t),y:.5*l.velocity.y+speed*Math.sin(t)});const o=.005;bullet[s].thrust={x:bullet[s].mass*o*Math.cos(t),y:bullet[s].mass*o*Math.sin(t)}}bullet[s].beforeDmg=function(){},bullet[s].stuck=function(){};let a=!1;bullet[s].do=function(){Matter.Query.collides(this,[player]).length>0&&this.beforeDmg();const e=()=>{this.collisionFilter.mask=0,Matter.Body.setVelocity(this,{x:0,y:0}),l.tech.isRPG&&(this.thrust={x:0,y:0}),this.do=this.radiationMode},t=Matter.Query.collides(this,[...mob,player]);if(t.length)e(),this.stuckTo=t[0].bodyA,mobs.statusDoT(this.stuckTo,.6,360),this.stuckTo.isVerticesChange?this.stuckToRelativePosition={x:0,y:0}:this.stuckToRelativePosition=Vector.rotate(Vector.sub(this.position,this.stuckTo.position),-this.stuckTo.angle),this.stuck=function(){if(this.stuckTo&&this.stuckTo.alive){const e=Vector.rotate(this.stuckToRelativePosition,this.stuckTo.angle);Matter.Body.setPosition(this,Vector.add(Vector.add(e,this.stuckTo.velocity),this.stuckTo.position)),Matter.Body.setVelocity(this,this.stuckTo.velocity)}else this.collisionFilter.mask=cat.map|cat.body|cat.me|cat.mob,this.stuck=function(){this.force.y+=.001*this.mass}};else{const t=Matter.Query.collides(this,body);t.length?(t[0].bodyA.isNotHoldable?this.do=this.radiationMode:(e(),this.stuckTo=t[0].bodyA,this.stuckToRelativePosition=Vector.rotate(Vector.sub(this.position,this.stuckTo.position),-this.stuckTo.angle)),this.stuck=function(){if(this.stuckTo){const e=Vector.rotate(this.stuckToRelativePosition,this.stuckTo.angle);Matter.Body.setPosition(this,Vector.add(Vector.add(e,this.stuckTo.velocity),this.stuckTo.position))}else this.force.y+=.001*this.mass}):Matter.Query.collides(this,map).length?e():l.tech.isRPG?(this.force.x+=this.thrust.x,this.force.y+=this.thrust.y):this.force.y+=.001*this.mass}if(l.tech.isPrecision&&!a)for(let e=0;e<mob.length;e++)!mob[e].isBadTarget&&!mob[e].isInvulnerable&&this.position.y<mob[e].bounds.min.y&&this.position.x>mob[e].position.x-mob[e].radius/2&&this.position.x<mob[e].position.x+mob[e].radius/2&&0===Matter.Query.ray(map,this.position,mob[e].position).length&&0===Matter.Query.ray(body,this.position,mob[e].position).length&&(Matter.Body.setVelocity(this,{x:0,y:4+Math.max(10,this.speed)}),a=!0,l.tech.isRPG&&(this.thrust={x:0,y:0}),ctx.strokeStyle="#000",ctx.lineWidth=3,ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(mob[e].position.x,mob[e].position.y),ctx.stroke())},bullet[s].radiationMode=function(){if(this.stuck(),this.damageRadius=.85*this.damageRadius+.15*this.maxDamageRadius,this.maxDamageRadius-=this.radiusDecay,this.damageRadius<15)this.endCycle=0;else{if(Vector.magnitude(Vector.sub(l.position,this.position))<this.damageRadius){const e=l.tech.isRadioactiveResistance?5e-4:.0025;l.energy>e?l.immuneCycle<l.cycle&&(l.energy-=e):(l.energy=0,l.takeDamage((l.tech.isRadioactiveResistance?16e-5*.2:16e-5)*l.tech.radioactiveDamage*spawn.dmgTomeByLevelsCleared()))}let e=.15*l.tech.radioactiveDamage;for(let t=0,o=mob.length;t<o;t++)Vector.magnitude(Vector.sub(mob[t].position,this.position))<this.damageRadius+mob[t].radius&&(Matter.Query.ray(map,mob[t].position,this.position).length>0&&(e*=.2),mob[t].damage(mob[t].shield?3*e:e),mob[t].locateme(),l.tech.isNeutronSlow&&mob[t].speed>4&&Matter.Body.setVelocity(mob[t],{x:.97*mob[t].velocity.x,y:.97*mob[t].velocity.y}));if(ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.damageRadius,0,2*Math.PI),ctx.globalCompositeOperation="lighter",ctx.fillStyle=`rgba(25,139,170,${.2+.06*Math.random()})`,ctx.fill(),ctx.globalCompositeOperation="source-over",l.tech.isNeutronSlow){let e=(e,t=3.2*this.explodeRad)=>{for(i=0,len=e.length;i<len;i++){const o=Vector.sub(this.position,e[i].position);Vector.magnitude(o)<t&&Matter.Body.setVelocity(e[i],{x:.975*e[i].velocity.x,y:.975*e[i].velocity.y})}};e(body,this.damageRadius),e([l],this.damageRadius)}}}},l.tech.isNeutronBomb?(window.b2.grenade=grenadeNeutron,l.tech.isRPG,l.grenadeDo.do=function(){}):l.tech.isRPG?(l.grenadeDo.do=function(){},l.tech.isVacuumBomb?window.b2.grenade=grenadeRPGVacuum:window.b2.grenade=grenadeRPG):l.tech.isVacuumBomb?(window.b2.grenade=grenadeVacuum,l.grenadeDo.do=function(){}):(window.b2.grenade=grenadeDefault,l.grenadeDo.do=function(){})},l.grenadeDo={do(){}},l.grenadeEnd=function(){l.tech.isCircleExplode?b.starburst(this.position,this.explodeRad):l.tech.isPetalsExplode?b.fireFlower(this.position,this.explodeRad):l.tech.isClusterExplode?b.clusterExplode(this.position,this.explodeRad):b.explosion(this.position,this.explodeRad)},l.isDischarge=!1,l.knockBack=5e-4,l.applyKnock=function(e){l.force.x-=.7*this.knockBack*e.x,e.y>0?l.force.y-=4.3*this.knockBack*e.y:l.force.y-=this.knockBack*e.y},l.lastTextPos||(l.lastTextPos={x:l.position.x,y:l.pos.y-70}),l.crosshair||(l.crosshair={x:l.mouse.x,y:l.mouse.y}),l.fieldRegen=.04,l.fieldCDcycle=0,l.fieldMeterColor="#0cf",l.minEnergyToDeflect=.05,l.fieldMode=0,l.defaultMass=5,l.resetHistory=function(){const e={position:{x:l.position.x,y:l.position.y},velocity:{x:l.velocity.x,y:l.velocity.y},yOff:l.yOff,angle:l.angle2,health:l.health,energy:l.energy,activeGun:l.activeGun};for(let t=0;t<600;t++)m.history[t]=e},l.drawRegenEnergy=function(e="rgba(0, 0, 0, 0.4)",t=60){if(l.energy<l.maxEnergy){l.regenEnergy(),ctx.fillStyle=e;const o=l.pos.x-l.radius*l.maxEnergy,i=l.pos.y-50;ctx.fillRect(o,i,t*l.maxEnergy,10),ctx.fillStyle=l.fieldMeterColor,ctx.fillRect(o,i,t*l.energy,10)}else if(l.energy>l.maxEnergy+.05){ctx.fillStyle=e;const o=l.pos.x-l.radius*l.energy,i=l.pos.y-50;ctx.fillStyle=l.fieldMeterColor,ctx.fillRect(o,i,t*l.energy,10)}},l.drawHold=function(e,t=!0){if(e){const o=15,i=e.vertices.length-1;ctx.fillStyle="rgba(110,170,200,"+(.2+.4*Math.random())+")",ctx.lineWidth=1,ctx.strokeStyle="#000",ctx.beginPath(),ctx.moveTo(l.pos.x+o*Math.cos(l.angle2),l.pos.y+o*Math.sin(l.angle2)),ctx.lineTo(e.vertices[i].x,e.vertices[i].y),ctx.lineTo(e.vertices[0].x,e.vertices[0].y),ctx.fill(),t&&ctx.stroke();for(let s=0;s<i;s++)ctx.beginPath(),ctx.moveTo(l.pos.x+o*Math.cos(l.angle2),l.pos.y+o*Math.sin(l.angle2)),ctx.lineTo(e.vertices[s].x,e.vertices[s].y),ctx.lineTo(e.vertices[s+1].x,e.vertices[s+1].y),ctx.fill(),t&&ctx.stroke()}},l.holding=function(){l.fireCDcycle<l.cycle&&(l.fireCDcycle=l.cycle-1),l.holdingTarget?(l.energy-=l.fieldRegen,l.energy<0&&(l.energy=0),Matter.Body.setPosition(l.holdingTarget,{x:l.pos.x+70*Math.cos(l.angle2),y:l.pos.y+70*Math.sin(l.angle2)}),Matter.Body.setVelocity(l.holdingTarget,l.velocity),Matter.Body.rotate(l.holdingTarget,.01/l.holdingTarget.mass)):l.isHolding=!1},l.throwBlockDefault=function(){if(l.holdingTarget){if(l.inputField)if(l.energy>.001)if(l.fireCDcycle<l.cycle&&(l.fireCDcycle=l.cycle),l.tech.isCapacitor&&l.throwCharge<4&&(l.throwCharge=4),l.throwCharge+=.5/l.holdingTarget.mass/l.fireCDscale,l.throwCharge<6&&(l.energy-=.001/l.fireCDscale),l.tech.isTokamak){const e=l.pos.x+15*Math.cos(l.angle2),t=l.pos.y+15*Math.sin(l.angle2),o=l.holdingTarget.vertices.length-1,i=l.throwCharge>4?.65:.06*l.throwCharge;ctx.fillStyle=`rgba(255,0,255,${i})`,ctx.beginPath(),ctx.moveTo(e,t),ctx.lineTo(l.holdingTarget.vertices[o].x,l.holdingTarget.vertices[o].y),ctx.lineTo(l.holdingTarget.vertices[0].x,l.holdingTarget.vertices[0].y),ctx.fill();for(let i=0;i<o;i++)ctx.beginPath(),ctx.moveTo(e,t),ctx.lineTo(l.holdingTarget.vertices[i].x,l.holdingTarget.vertices[i].y),ctx.lineTo(l.holdingTarget.vertices[i+1].x,l.holdingTarget.vertices[i+1].y),ctx.fill();if(l.tech.isTokamakFly&&l.throwCharge>4&&l.energy>.01){l.force.y-=.5*l.mass*simulation.g;let e=!1;const t=l.mass*simulation.g*Math.pow(5/l.mass,.1);l.inputDown?(e=!0,l.force.y+=.9*t):l.inputUp&&(e=!0,l.force.y-=.9*t),l.onGround||(l.inputLeft?(e=!0,l.force.x-=.4*t):l.inputRight&&(e=!0,l.force.x+=.4*t),e&&(l.energy-=.0017))}}else{if(l.tech.isGroupThrow){const e=81e4;for(let t=0;t<body.length;t++){const o=Vector.sub(l.pos,body[t].position),i=Vector.magnitudeSquared(o);if(i<e&&(body[t].force.y-=body[t].mass*(1.01*simulation.g),i>4e4)){const e=Vector.mult(Vector.normalise(o),8e-4*body[t].mass);body[t].force.x+=e.x,body[t].force.y+=e.y,Matter.Body.setVelocity(body[t],{x:.96*body[t].velocity.x,y:.96*body[t].velocity.y})}}ctx.beginPath(),ctx.arc(l.pos.x,l.pos.y,Math.sqrt(e),0,2*Math.PI),ctx.fillStyle="rgba(245,245,255,0.15)",ctx.fill()}const e=l.pos.x+15*Math.cos(l.angle2),t=l.pos.y+15*Math.sin(l.angle2),o=l.holdingTarget.vertices.length-1,i=l.throwCharge*l.throwCharge*l.throwCharge,s=ctx.createRadialGradient(e,t,i,e,t,i+5);s.addColorStop(0,"rgba(255,50,150,0.3)"),s.addColorStop(1,"transparent"),ctx.fillStyle=s,ctx.beginPath(),ctx.moveTo(e,t),ctx.lineTo(l.holdingTarget.vertices[o].x,l.holdingTarget.vertices[o].y),ctx.lineTo(l.holdingTarget.vertices[0].x,l.holdingTarget.vertices[0].y),ctx.fill();for(let i=0;i<o;i++)ctx.beginPath(),ctx.moveTo(e,t),ctx.lineTo(l.holdingTarget.vertices[i].x,l.holdingTarget.vertices[i].y),ctx.lineTo(l.holdingTarget.vertices[i+1].x,l.holdingTarget.vertices[i+1].y),ctx.fill()}else l.drop();else if(l.throwCharge>0)if(l.holdingTarget.isPrinted&&(l.holdingTarget.isPrinted=void 0),l.fieldCDcycle=l.cycle+20,l.fireCDcycle=l.cycle+20,l.isHolding=!1,l.tech.isTokamak&&l.throwCharge>4){l.throwCycle=l.cycle+180,l.immuneCycle<l.cycle&&(l.energy+=.25*Math.sqrt(l.holdingTarget.mass)*Math.min(5,l.throwCharge)*level.isReducedRegen),l.throwCharge=0,l.definePlayerMass();for(let e=0;e<body.length;e++)body[e]===l.holdingTarget&&(Matter.Composite.remove(engine.world,body[e]),body.splice(e,1));if(b2.pulse(60*Math.pow(l.holdingTarget.mass,.25),l.angle2,l.id),l.tech.isTokamakHeal&&l.tech.tokamakHealCount<5){l.tech.tokamakHealCount++;let e=Math.min(65*Math.sqrt(l.maxHealth),14*Math.pow(l.holdingTarget.mass,.4));powerUps.healGiveMaxEnergy&&(e=powerUps.heal.size()),powerUps.spawn(l.pos.x,l.pos.y,"heal",!0,e*simulation.healScale**.25*Math.sqrt(l.tech.largerHeals*(l.tech.isHalfHeals?.5:1)))}}else{l.holdingTarget.collisionFilter.category=cat.body,l.holdingTarget.collisionFilter.group=-l.id,l.holdingTarget.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet|cat.mobShield|cat.player,l.tech.isBlockRestitution&&(l.holdingTarget.restitution=.999,l.holdingTarget.friction=l.holdingTarget.frictionStatic=l.holdingTarget.frictionAir=.001);const e=function(t){const o=t.position.x-l.position.x,i=t.position.y-l.position.y;o*o+i*i>1e4&&t!==l.holdingTarget?(t.collisionFilter.group=0,t.collisionFilter.category=cat.body,t.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet):setTimeout(e,40,t)};setTimeout(e,200,l.holdingTarget);const t=Math.min(l.throwCharge/5,1);let o=l.tech.isPrinter?15+80*t*Math.min(.85,.8/Math.pow(l.holdingTarget.mass,.1)):80*t*Math.min(.85,.8/Math.pow(l.holdingTarget.mass,.25));if(0!==Matter.Query.collides(l.holdingTarget,map).length&&(o*=.7,0!==Matter.Query.ray(map,l.holdingTarget.position,l.pos).length&&(o=0)),l.throwCharge=0,l.throwCycle=l.cycle+180,Matter.Body.setVelocity(l.holdingTarget,{x:.5*l.velocity.x+Math.cos(l.angle2)*o,y:.5*l.velocity.y+Math.sin(l.angle2)*o}),Matter.Body.setVelocity(l,{x:l.velocity.x-Math.cos(l.angle2)*o/(l.crouch?30:10)*Math.sqrt(l.holdingTarget.mass),y:l.velocity.y-Math.sin(l.angle2)*o/30*Math.sqrt(l.holdingTarget.mass)}),l.definePlayerMass(),l.tech.isStaticBlock&&(l.holdingTarget.isStatic=!0),l.tech.isAddBlockMass){const e=function(t,o){if(t.mass<o){const i=1.04;Matter.Body.scale(t,i,i),setTimeout(e,20,t,o)}};e(l.holdingTarget,Math.min(20,3*l.holdingTarget.mass))}if(l.tech.isGroupThrow){const e=81e4;for(let o=0;o<body.length;o++)if(body[o]!==l.holdingTarget){const i=Vector.magnitudeSquared(Vector.sub(l.pos,body[o].position));if(i<e){const s=90*t*Math.min(.85,.8/Math.pow(body[o].mass,.25))*Math.pow((e-i)/e,.2);Matter.Body.setVelocity(body[o],{x:.5*body[o].velocity.x+Math.cos(l.angle2)*s,y:.5*body[o].velocity.y+Math.sin(l.angle2)*s})}}}}}else l.isHolding=!1},l.pushMobsFacing=function(){for(let e=0,t=mob.length;e<t;++e)Vector.magnitude(Vector.sub(mob[e].position,l.pos))-mob[e].radius<l.fieldRange&&l.lookingAt(mob[e])&&!mob[e].isUnblockable&&!mob[e].id==l.id&&0===Matter.Query.ray(map,mob[e].position,l.pos).length&&(mob[e].locatePlayer(),l.pushMass(mob[e]),!l.tech.deflectEnergy||mob[e].isInvulnerable||mob[e].isShielded||(l.energy+=l.tech.deflectEnergy*level.isReducedRegen));if(Vector.magnitude(Vector.sub(m.pos,l.position))-l.radius<l.fieldRange&&0===Matter.Query.ray(map,m.pos,l.position).length){const e=Vector.normalise(Vector.sub(l.position,player.position)),t=Math.sqrt(Math.min(12,Math.max(.15,player.mass)));Matter.Body.setVelocity(player,{x:l.velocity.x-15*e.x/t,y:l.velocity.y-15*e.y/t})}},l.pushMass=function(e,t=(.025+Math.sqrt(e.mass)*Vector.magnitude(Vector.sub(e.velocity,l.velocity))*.002)*l.fieldShieldingScale){if(l.energy>l.minEnergyToDeflect){if(e.isShielded&&(t*=2),l.energy-=t,l.energy<l.minEnergyToDeflect?(l.energy=0,l.fieldCDcycle=l.cycle+Math.max(l.fieldBlockCD,60),l.tech.isLaserField&&simulation.ephemera.push({count:20+Math.floor(30*l.maxEnergy*.0018/l.tech.laserDrain),do(){this.count--,this.count<0&&simulation.removeEphemera(this);for(let e=0,t=12;e<t;e++){const o=6.28*e/t+.04*l.cycle;l.tech.isLaserLens?b2.laser({x:l.pos.x+30*Math.cos(o),y:l.pos.y+30*Math.sin(o)},{x:l.pos.x+3e3*Math.cos(o),y:l.pos.y+3e3*Math.sin(o)},2.5*l.tech.laserDamage*b.guns[11].lensDamage,l.id):b2.laser({x:l.pos.x+30*Math.cos(o),y:l.pos.y+30*Math.sin(o)},{x:l.pos.x+3e3*Math.cos(o),y:l.pos.y+3e3*Math.sin(o)},2.5*l.tech.laserDamage,l.id)}}})):l.fieldCDcycle=l.cycle+l.fieldBlockCD,!e.isInvulnerable&&l.coupling&&0===l.fieldMode&&bullet.length<200)for(let t=0;t<l.coupling;t++)if(.1*l.coupling-t>1.25*Math.random()){const t=Vector.mult(Vector.normalise(Vector.sub(e.position,l.pos)),l.fieldRange*l.harmonicRadius*(.4+.3*Math.random())),o=Vector.rotate(t,1*(Math.random()-.5)),i=Math.atan2(t.y,t.x);b2.iceIX(6+6*Math.random(),i+3*(Math.random()-.5),Vector.add(l.pos,o),l.id)}l.bulletsToBlocks(e);const o=Vector.normalise(Vector.sub(l.position,e.position));if(l.tech.blockDmg){if(Matter.Body.setVelocity(e,{x:.5*e.velocity.x,y:.5*e.velocity.y}),e.isShielded)for(let t=0,o=mob.length;t<o;t++)mob[t].id===e.shieldID&&mob[t].damage(l.tech.blockDmg*(l.tech.isBlockRadiation?6:2),!0);else l.tech.isBlockRadiation?e.isMobBullet?e.damage(3*l.tech.blockDmg,!0):mobs.statusDoT(e,.42*l.tech.blockDmg,180):e.damage(l.tech.blockDmg,!0);const t=40;ctx.beginPath();for(let e=0,i=.5*l.tech.blockDmg;e<i;e++){let e=l.pos.x-20*o.x,i=l.pos.y-20*o.y;ctx.moveTo(e,i);for(let l=0;l<8;l++)e+=t*(-o.x+1.5*(Math.random()-.5)),i+=t*(-o.y+1.5*(Math.random()-.5)),ctx.lineTo(e,i)}ctx.lineWidth=3,ctx.strokeStyle="#f0f",ctx.stroke()}else l.drawHold(e);l.tech.isStunField&&mobs.statusStun(e,l.tech.isStunField);const i=Math.sqrt(Math.min(12,Math.max(.15,e.mass)));Matter.Body.setVelocity(e,{x:l.velocity.x-15*o.x/i,y:l.velocity.y-15*o.y/i}),e.isUnstable&&(l.fieldCDcycle<l.cycle+30&&(l.fieldCDcycle=l.cycle+10),e.death()),l.crouch?Matter.Body.setVelocity(l,{x:l.velocity.x+.1*l.blockingRecoil*o.x*i,y:l.velocity.y+.1*l.blockingRecoil*o.y*i}):Matter.Body.setVelocity(l,{x:l.velocity.x+l.blockingRecoil*o.x*i,y:l.velocity.y+l.blockingRecoil*o.y*i})}},l.bulletsToBlocks=function(e){if(e.isMobBullet&&!e.isInvulnerable&&e.mass<10&&body.length<mobs.maxMobBody){body[body.length]=Matter.Bodies.polygon(e.position.x,e.position.y,e.vertices.length,e.radius,{friction:.05,frictionAir:.001,collisionFilter:{category:cat.bullet,mask:cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet|cat.mobShield},classType:"body",isPrinted:!0,radius:10,density:.002});const t=body[body.length-1];Composite.add(engine.world,t);const o=Vector.mult(Vector.normalise(e.velocity),-Math.max(40,e.speed));Matter.Body.setVelocity(t,o),simulation.ephemera.push({count:120,do(){if(this.count--,this.count<0){simulation.removeEphemera(this),Matter.Composite.remove(engine.world,t);for(let e=0;e<body.length;e++)if(body[e]===t){body.splice(e,1);break}}}}),Matter.Composite.remove(engine.world,e),e.alive=!1}},l.drawField=function(){if(l.holdingTarget?(ctx.fillStyle="rgba(110,170,200,"+l.energy*(.05+.05*Math.random())+")",ctx.strokeStyle="rgba(110, 200, 235, "+(.3+.08*Math.random())+")"):(ctx.fillStyle="rgba(110,170,200,"+(.02+l.energy*(.15+.15*Math.random()))+")",ctx.strokeStyle="rgba(110, 200, 235, "+(.6+.2*Math.random())+")"),2!=l.fieldMode){const e=l.angle2,t=l.fieldRange;ctx.beginPath(),ctx.arc(l.pos.x,l.pos.y,t,e-Math.PI*l.fieldArc,e+Math.PI*l.fieldArc,!1),ctx.lineWidth=2,ctx.stroke();let o=13;2==l.fieldMode&&(o=30);let i=.75*Math.PI*l.fieldArc,s=e+i,a=l.pos.x+.6*t*Math.cos(s),r=l.pos.y+.6*t*Math.sin(s);ctx.quadraticCurveTo(a,r,l.pos.x+o*Math.cos(e),l.pos.y+o*Math.sin(e)),s=e-i,a=l.pos.x+.6*t*Math.cos(s),r=l.pos.y+.6*t*Math.sin(s),ctx.quadraticCurveTo(a,r,l.pos.x+1*t*Math.cos(e-Math.PI*l.fieldArc),l.pos.y+1*t*Math.sin(e-Math.PI*l.fieldArc)),ctx.fill();let n=e+1.7*Math.PI*l.fieldArc*(Math.random()-.5);ctx.beginPath(),o=15,ctx.moveTo(l.pos.x+o*Math.cos(e),l.pos.y+o*Math.sin(e)),ctx.lineTo(l.pos.x+t*Math.cos(n),l.pos.y+t*Math.sin(n)),ctx.strokeStyle="rgba(0,0,0,0.6)",ctx.lineWidth=1,ctx.stroke()}else{ctx.beginPath();const e=Math.cos(.022*l.cycle),t=l.angle2;ctx.arc(l.pos.x,l.pos.y,l.fieldRange,t-Math.PI*l.fieldArc,t+Math.PI*l.fieldArc,!1),ctx.lineWidth=2.5-1.5*e,ctx.stroke();const o=.57+.04*e,i=(1-1.2*o)*Math.PI*l.fieldArc;let s=t+i,a=l.pos.x+o*l.fieldRange*Math.cos(s),r=l.pos.y+o*l.fieldRange*Math.sin(s);ctx.quadraticCurveTo(a,r,l.pos.x+30*Math.cos(t),l.pos.y+30*Math.sin(t)),s=t-i,a=l.pos.x+o*l.fieldRange*Math.cos(s),r=l.pos.y+o*l.fieldRange*Math.sin(s),ctx.quadraticCurveTo(a,r,l.pos.x+1*l.fieldRange*Math.cos(t-Math.PI*l.fieldArc),l.pos.y+1*l.fieldRange*Math.sin(t-Math.PI*l.fieldArc)),ctx.fill()}},l.lookForBlock=function(){const e={targetIndex:null,targetRange:150};for(let t=0,o=body.length;t<o;++t)if(0===Matter.Query.ray(map,body[t].position,l.pos).length){const o=Vector.magnitude(Vector.sub(body[t].position,l.pos)),i=l.lookingAt(body[t]);o<e.targetRange+30&&i&&!body[t].isNotHoldable&&(e.targetRange=o,e.targetIndex=t)}if(body[e.targetIndex]){l.holdingTarget=body[e.targetIndex],ctx.beginPath();let t=l.holdingTarget.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e+=1)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.fillStyle="rgba(190,215,230,"+(.3+.7*Math.random())+")",ctx.fill(),ctx.globalAlpha=.2,l.drawHold(l.holdingTarget),ctx.globalAlpha=1}else l.holdingTarget=null},l.pickUp=function(){l.isHolding=!0,totalMomentum=Vector.add(Vector.mult(l.velocity,l.mass),Vector.mult(l.holdingTarget.velocity,l.holdingTarget.mass)),Matter.Body.setVelocity(l,Vector.mult(totalMomentum,1/(l.defaultMass+l.holdingTarget.mass))),l.definePlayerMass(l.defaultMass+l.holdingTarget.mass*l.holdingMassScale),l.holdingTarget.collisionFilter.category=0,l.holdingTarget.collisionFilter.mask=0},l.calculateFieldThreshold=function(){l.fieldThreshold=Math.cos(l.fieldArc*Math.PI)},l.lookingAt=function(e){const t=Vector.normalise(Vector.sub(e.position,l.pos)),o={x:Math.cos(l.angle2),y:Math.sin(l.angle2)};return Vector.dot(o,t)>l.fieldThreshold},l.grabPowerUp=function(){l.fireCDcycle<l.cycle&&(l.fireCDcycle=l.cycle-1);for(let e=0,t=powerUp.length;e<t;++e){if(l.tech.isEnergyNoAmmo&&"ammo"===powerUp[e].name)continue;const t=l.pos.x-powerUp[e].position.x,o=l.pos.y-powerUp[e].position.y,i=t*t+o*o+10;if(i<l.grabPowerUpRange2&&(l.lookingAt(powerUp[e])||i<1e4)&&0===Matter.Query.ray(map,powerUp[e].position,l.pos).length&&(l.tech.isHealAttract&&"heal"===powerUp[e].name||(powerUp[e].force.x+=t/Math.sqrt(i)*.04*powerUp[e].mass,powerUp[e].force.y+=o/Math.sqrt(i)*.04*powerUp[e].mass-powerUp[e].mass*simulation.g,Matter.Body.setVelocity(powerUp[e],{x:.11*powerUp[e].velocity.x,y:.11*powerUp[e].velocity.y})),i<5e3&&!simulation.isChoosing&&("heal"!==powerUp[e].name||l.maxHealth-l.health>.01||l.tech.isOverHeal)))return powerUps.onPickUp(powerUp[e]),Matter.Body.setVelocity(l,{x:l.velocity.x+powerUp[e].velocity.x/l.mass*4*powerUp[e].mass,y:l.velocity.y+powerUp[e].velocity.y/l.mass*4*powerUp[e].mass}),Matter.Composite.remove(engine.world,powerUp[e]),void powerUp.splice(e,1)}},l.grabPowerUpEasy=function(){for(let e=0,t=powerUp.length;e<t;++e){if(l.tech.isEnergyNoAmmo&&"ammo"===powerUp[e].name)continue;const t=l.pos.x-powerUp[e].position.x,o=l.pos.y-powerUp[e].position.y,i=t*t+o*o+10;if(i<l.grabPowerUpRange2&&0===Matter.Query.ray(map,powerUp[e].position,l.pos).length&&(l.tech.isHealAttract&&"heal"===powerUp[e].name||(powerUp[e].force.x+=t/Math.sqrt(i)*.05*powerUp[e].mass,powerUp[e].force.y+=o/Math.sqrt(i)*.05*powerUp[e].mass-powerUp[e].mass*simulation.g,Matter.Body.setVelocity(powerUp[e],{x:.11*powerUp[e].velocity.x,y:.11*powerUp[e].velocity.y})),i<2e4&&!simulation.isChoosing&&("heal"!==powerUp[e].name||l.maxHealth-l.health>.01||l.tech.isOverHeal)))return powerUps.onPickUp(powerUp[e]),Matter.Body.setVelocity(l,{x:l.velocity.x+powerUp[e].velocity.x/l.mass*4*powerUp[e].mass,y:l.velocity.y+powerUp[e].velocity.y/l.mass*4*powerUp[e].mass}),Matter.Composite.remove(engine.world,powerUp[e]),void powerUp.splice(e,1)}},l.drop=function(){l.isHolding&&(l.fieldCDcycle=l.cycle+15,l.isHolding=!1,l.throwCharge=0,l.definePlayerMass()),l.holdingTarget&&(l.holdingTarget.collisionFilter.category=cat.body,l.holdingTarget.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet,l.holdingTarget=null)},l.definePlayerMass=function(e=m.defaultMass){Matter.Body.setMass(l,e),l.setMovement(),l.yOffWhen.stand=Math.max(l.yOffWhen.crouch,Math.min(49,49-6*(e-5))),l.onGround&&!l.crouch&&(l.yOffGoal=l.yOffWhen.stand)},l.setHoldDefaults=function(){l.energy<l.maxEnergy&&(l.energy=l.maxEnergy),l.fieldMeterColor="#0cf",l.eyeFillColor=l.fieldMeterColor,l.fieldShieldingScale=1,l.fieldBlockCD=10,l.fieldDamage=1,l.fieldHarmReduction=1,l.isSneakAttack=!1,l.duplicateChance=0,l.grabPowerUpRange2=2e5,l.blockingRecoil=4,l.fieldRange=155,l.fieldFire=!1,l.fieldCDcycle=0,l.isCloak=!1,l.airSpeedLimit=125,l.fieldFx=1,l.fieldJump=1,l.throwCharge=0,l.setMovement(),l.drop(),l.holdingMassScale=.5,l.fieldArc=.2,l.calculateFieldThreshold(),l.isTimeDilated=!1,l.hole={isOn:!1,isReady:!1,pos1:{x:0,y:0},pos2:{x:0,y:0}}},l.regenEnergy=function(){l.immuneCycle<l.cycle&&l.fieldCDcycle<l.cycle&&(l.energy+=l.fieldRegen*level.isReducedRegen),l.energy<0&&(l.energy=0)},l.setHoldDefaults(),l.harmonic3Phase=function(){const e=(.75+.3*Math.sin(l.cycle/23))*l.fieldRange*l.harmonicRadius,t=(.68+.37*Math.sin(l.cycle/37))*l.fieldRange*l.harmonicRadius,o=(.7+.35*Math.sin(l.cycle/47))*l.fieldRange*l.harmonicRadius,i=Math.max(e,t,o);ctx.fillStyle="rgba(110,170,200,"+Math.min(.55,.04+.7*l.energy*(.1+.11*Math.random()))+")",ctx.beginPath(),ctx.arc(l.pos.x,l.pos.y,e,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(l.pos.x,l.pos.y,t,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(l.pos.x,l.pos.y,o,0,2*Math.PI),ctx.fill();let s=[...mob];for(let e=0,t=mob.length;e<t;++e)Vector.magnitude(Vector.sub(mob[e].position,l.pos))-(s[e]==player?l.radius:s[e].radius)<i&&!s[e].isUnblockable&&s[e].id!=l.id&&(this.drainCD>l.cycle?l.pushMass(s[e],0):(l.pushMass(s[e]),this.drainCD=l.cycle+15));if(Vector.magnitude(Vector.sub(player.position,l.position))-l.radius<i){const e=Vector.normalise(Vector.sub(l.position,player.position)),t=Math.sqrt(Math.min(12,Math.max(.15,player.mass)));Matter.Body.setVelocity(player,{x:l.velocity.x-15*e.x/t,y:l.velocity.y-15*e.y/t})}},l.harmonicRadius=1,l.harmonicAtomic=function(){const e=.0031*simulation.cycle,t=.023*simulation.cycle,o=l.fieldRange*l.harmonicRadius;ctx.lineWidth=1,ctx.strokeStyle="rgba(110,170,200,0.8)",ctx.fillStyle="rgba(110,170,200,"+Math.min(.6,.7*l.energy*(.11+.1*Math.random())*(3/l.tech.harmonics))+")";for(let i=0;i<l.tech.harmonics;i++)ctx.beginPath(),ctx.ellipse(l.pos.x,l.pos.y,o*Math.abs(Math.sin(t+i/l.tech.harmonics*Math.PI)),o,e+i/l.tech.harmonics*Math.PI,0,2*Math.PI),ctx.fill(),ctx.stroke();if(Vector.magnitude(Vector.sub(player.position,l.position))-l.radius<o){const e=Vector.normalise(Vector.sub(l.position,player.position)),t=Math.sqrt(Math.min(12,Math.max(.15,player.mass)));Matter.Body.setVelocity(player,{x:l.velocity.x-15*e.x/t,y:l.velocity.y-15*e.y/t})}let i=[...mob];for(let e=0,t=i.length;e<t;++e)Vector.magnitude(Vector.sub(i[e].position,l.pos))-(i[e]==player?l.radius:i[e].radius)<o&&!i[e].isUnblockable&&i[e].id!=l.id&&(this.drainCD>l.cycle?l.pushMass(i[e],0):(l.pushMass(i[e]),this.drainCD=l.cycle+15))},l.perfectPush=function(e=!1){if(l.fieldCDcycle<l.cycle){for(let t=0,o=mob.length;t<o;++t)if(Vector.magnitude(Vector.sub(mob[t].position,l.fieldPosition))-mob[t].radius<l.fieldRange&&!mob[t].isUnblockable&&mob[t].id!=l.id&&Vector.dot({x:Math.cos(l.fieldAngle),y:Math.sin(l.fieldAngle)},Vector.normalise(Vector.sub(mob[t].position,l.fieldPosition)))>l.fieldThreshold&&0===Matter.Query.ray(map,mob[t].position,l.fieldPosition).length){const o=Vector.normalise(Vector.sub(l.fieldPosition,mob[t].position));if(l.fieldCDcycle=l.cycle+l.fieldBlockCD+(mob[t].isShielded?10:0),!mob[t].isInvulnerable&&bullet.length<250)for(let e=0;e<l.coupling;e++)if(.1*l.coupling-e>Math.random()){const e=l.fieldAngle+4*l.fieldArc*(Math.random()-.5),t=l.fieldRange*(.6+.3*Math.random());b2.iceIX(6+6*Math.random(),e,Vector.add(l.fieldPosition,{x:t*Math.cos(e),y:t*Math.sin(e)}),l.id)}if(l.tech.blockDmg){if(Matter.Body.setVelocity(mob[t],{x:.5*mob[t].velocity.x,y:.5*mob[t].velocity.y}),mob[t].isShielded)for(let e=0,o=mob.length;e<o;e++)mob[e].id===mob[t].shieldID&&mob[e].damage(l.tech.blockDmg*(l.tech.isBlockRadiation?6:2),!0);else l.tech.isBlockRadiation?mob[t].isMobBullet?mob[t].damage(3*l.tech.blockDmg,!0):mobs.statusDoT(mob[t],.42*l.tech.blockDmg,180):mob[t].damage(l.tech.blockDmg,!0);const e=40;ctx.beginPath();for(let t=0,i=.5*l.tech.blockDmg;t<i;t++){let t=l.fieldPosition.x-20*o.x,i=l.fieldPosition.y-20*o.y;ctx.moveTo(t,i);for(let l=0;l<8;l++)t+=e*(-o.x+1.5*(Math.random()-.5)),i+=e*(-o.y+1.5*(Math.random()-.5)),ctx.lineTo(t,i)}ctx.lineWidth=3,ctx.strokeStyle="#f0f",ctx.stroke()}else if(e){ctx.lineWidth=2,ctx.fillStyle=`rgba(110,150,220, ${.2+.4*Math.random()})`,ctx.strokeStyle="#000";const e=mob[t].vertices.length-1,o=mob[t].radius;ctx.beginPath(),ctx.moveTo(mob[t].vertices[e].x+o*(Math.random()-.5),mob[t].vertices[e].y+o*(Math.random()-.5));for(let i=0;i<e;i++)ctx.lineTo(mob[t].vertices[i].x+o*(Math.random()-.5),mob[t].vertices[i].y+o*(Math.random()-.5));ctx.lineTo(mob[t].vertices[e].x+o*(Math.random()-.5),mob[t].vertices[e].y+o*(Math.random()-.5)),ctx.fill(),ctx.stroke()}else{const e=15,o=mob[t].vertices.length-1;ctx.lineWidth=1,ctx.fillStyle=`rgba(110,150,220, ${.2+.4*Math.random()})`,ctx.strokeStyle="#000",ctx.beginPath(),ctx.moveTo(l.fieldPosition.x+e*Math.cos(l.fieldAngle),l.fieldPosition.y+e*Math.sin(l.fieldAngle)),ctx.lineTo(mob[t].vertices[o].x,mob[t].vertices[o].y),ctx.lineTo(mob[t].vertices[0].x,mob[t].vertices[0].y),ctx.fill(),ctx.stroke();for(let i=0;i<o;i++)ctx.beginPath(),ctx.moveTo(l.fieldPosition.x+e*Math.cos(l.fieldAngle),l.fieldPosition.y+e*Math.sin(l.fieldAngle)),ctx.lineTo(mob[t].vertices[i].x,mob[t].vertices[i].y),ctx.lineTo(mob[t].vertices[i+1].x,mob[t].vertices[i+1].y),ctx.fill(),ctx.stroke()}l.bulletsToBlocks(mob[t]),l.tech.isStunField&&mobs.statusStun(mob[t],l.tech.isStunField);const i=Math.sqrt(Math.max(1,mob[t].mass));if(Matter.Body.setVelocity(mob[t],{x:l.velocity.x-30*o.x/i,y:l.velocity.y-30*o.y/i}),mob[t].isUnstable&&(l.fieldCDcycle<l.cycle+10&&(l.fieldCDcycle=l.cycle+6),mob[t].death()),!e&&mob[t].isDropPowerUp&&l.speed<12){const e=Math.sqrt(Math.min(10,Math.max(.2,mob[t].mass)));Matter.Body.setVelocity(l,{x:.9*l.velocity.x+.6*o.x*e,y:.9*l.velocity.y+.6*o.y*e})}}if(Vector.magnitude(Vector.sub(player.position,l.fieldPosition))-m.radius<l.fieldRange&&Vector.dot({x:Math.cos(l.fieldAngle),y:Math.sin(l.fieldAngle)},Vector.normalise(Vector.sub(player.position,l.fieldPosition)))>l.fieldThreshold&&0===Matter.Query.ray(map,player.position,l.fieldPosition).length){const t=Vector.normalise(Vector.sub(l.fieldPosition,player.position));if(l.fieldCDcycle=l.cycle+l.fieldBlockCD,!player.isInvulnerable&&bullet.length<250)for(let e=0;e<l.coupling;e++)if(.1*l.coupling-e>Math.random()){const e=l.fieldAngle+4*l.fieldArc*(Math.random()-.5),t=l.fieldRange*(.6+.3*Math.random());b2.iceIX(6+6*Math.random(),e,Vector.add(l.fieldPosition,{x:t*Math.cos(e),y:t*Math.sin(e)}),l.id)}if(l.tech.blockDmg){Matter.Body.setVelocity(player,{x:.5*player.velocity.x,y:.5*player.velocity.y});const e=40;ctx.beginPath();for(let o=0,i=.5*l.tech.blockDmg;o<i;o++){let o=l.fieldPosition.x-20*t.x,i=l.fieldPosition.y-20*t.y;ctx.moveTo(o,i);for(let l=0;l<8;l++)o+=e*(-t.x+1.5*(Math.random()-.5)),i+=e*(-t.y+1.5*(Math.random()-.5)),ctx.lineTo(o,i)}ctx.lineWidth=3,ctx.strokeStyle="#f0f",ctx.stroke()}else if(e){ctx.lineWidth=2,ctx.fillStyle=`rgba(110,150,220, ${.2+.4*Math.random()})`,ctx.strokeStyle="#000";const e=player.vertices.length-1,t=m.radius;ctx.beginPath(),ctx.moveTo(player.vertices[e].x+t*(Math.random()-.5),player.vertices[e].y+t*(Math.random()-.5));for(let o=0;o<e;o++)ctx.lineTo(player.vertices[o].x+t*(Math.random()-.5),player.vertices[o].y+t*(Math.random()-.5));ctx.lineTo(player.vertices[e].x+t*(Math.random()-.5),player.vertices[e].y+t*(Math.random()-.5)),ctx.fill(),ctx.stroke()}else{const e=15,t=player.vertices.length-1;ctx.lineWidth=1,ctx.fillStyle=`rgba(110,150,220, ${.2+.4*Math.random()})`,ctx.strokeStyle="#000",ctx.beginPath(),ctx.moveTo(l.fieldPosition.x+e*Math.cos(l.fieldAngle),l.fieldPosition.y+e*Math.sin(l.fieldAngle)),ctx.lineTo(player.vertices[t].x,player.vertices[t].y),ctx.lineTo(player.vertices[0].x,player.vertices[0].y),ctx.fill(),ctx.stroke();for(let o=0;o<t;o++)ctx.beginPath(),ctx.moveTo(l.fieldPosition.x+e*Math.cos(l.fieldAngle),l.fieldPosition.y+e*Math.sin(l.fieldAngle)),ctx.lineTo(player.vertices[o].x,player.vertices[o].y),ctx.lineTo(player.vertices[o+1].x,player.vertices[o+1].y),ctx.fill(),ctx.stroke()}const o=Math.sqrt(Math.max(1,player.mass));if(Matter.Body.setVelocity(player,{x:player.velocity.x-30*t.x/o,y:player.velocity.y-30*t.y/o}),!e&&l.isDropPowerUp&&l.speed<12){const e=Math.sqrt(Math.min(10,Math.max(.2,l.mass)));Matter.Body.setVelocity(l,{x:.9*l.velocity.x+.6*t.x*e,y:.9*l.velocity.y+.6*t.y*e})}}}},l.drawCloak=function(){if(l.fieldDrawRadius<1)return;l.fieldPhase+=.007;const e=.15*Math.sin(.5*l.fieldPhase);ctx.save(),ctx.beginPath(),ctx.ellipse(l.pos.x,l.pos.y,l.fieldDrawRadius*(1-e),l.fieldDrawRadius*(1+e),l.fieldPhase,0,2*Math.PI),ctx.globalCompositeOperation="destination-out",ctx.fillStyle="#fff",ctx.fill(),ctx.restore()},l.timeStop=function(){function e(e){for(let t=0,o=e.length;t<o;++t)e[t].id!=l.id&&(e[t].isSleeping||(e[t].storeVelocity=e[t].velocity,e[t].storeAngularVelocity=e[t].angularVelocity),Matter.Sleeping.set(e[t],!0))}ctx.globalCompositeOperation="saturation",ctx.fillStyle="#ccc",ctx.fillRect(-5e4,-5e4,1e5,1e5),ctx.globalCompositeOperation="source-over",l.isTimeDilated=!0,e(mob),e(body),e(bullet),simulation.cycle--},l.wakeCheck=function(){if(l.isTimeDilated){function e(e){for(let t=0,o=e.length;t<o;++t)Matter.Sleeping.set(e[t],!1),e[t].storeVelocity&&(Matter.Body.setVelocity(e[t],{x:e[t].storeVelocity.x,y:e[t].storeVelocity.y}),Matter.Body.setAngularVelocity(e[t],e[t].storeAngularVelocity))}l.isTimeDilated=!1,e(mob),e(body),e(bullet),e(player);for(let t=0,o=cons.length;t<o;t++)0===cons[t].stiffness&&(cons[t].stiffness=cons[t].storeStiffness)}},l.lastAngle=0,l.wasExtruderOn=!1,l.isExtruderOn=!1,l.didExtruderDrain=!1,l.canExtruderFire=!0,l.extruder=function(){if(l.energy>.0012&&l.canExtruderFire){l.energy<0&&(l.fieldCDcycle=l.cycle+120,l.energy=0),l.isExtruderOn=!0;const e=8+12*l.tech.isPlasmaRange,t=bullet.length,o=Vector.add(l.pos,l.velocity);bullet[t]=Bodies.polygon(o.x+20*Math.cos(l.angle2),o.y+20*Math.sin(l.angle2),4,.01,{cycle:-.5,isWave:!0,endCycle:simulation.cycle+40,inertia:1/0,frictionAir:0,isInHole:!0,minDmgSpeed:0,dmg:2.7,classType:"bullet",isBranch:!1,restitution:0,collisionFilter:{category:0,mask:0},beforeDmg(){},onEnd(){},do(){if(this.endCycle<simulation.cycle+1&&(this.isWave=!1),Matter.Query.point(map,this.position).length)this.isBranch=!0,this.do=()=>{this.endCycle<simulation.cycle+1&&(this.isWave=!1)};else for(let e=0,t=mob.length;e<t;e++){const t=Vector.magnitudeSquared(Vector.sub(this.position,mob[e].position)),o=mob[e].radius+l.tech.extruderRange/2;if(t<o*o&&mob[e].id!=l.id){mob[e].speed>2&&(mob[e].isBoss||mob[e].isShielded?Matter.Body.setVelocity(mob[e],{x:.95*mob[e].velocity.x,y:.95*mob[e].velocity.y}):Matter.Body.setVelocity(mob[e],{x:.25*mob[e].velocity.x,y:.25*mob[e].velocity.y}));let t=this.dmg/Math.min(10,mob[e].mass);mob[e].damage(t)}}this.cycle++;const e=(l.crouch?6:12)*Math.cos(.09*simulation.cycle),t=Vector.mult(i,e*Math.cos(.36*this.cycle)),o=Vector.mult(l.velocity,.4);Matter.Body.setPosition(this,Vector.add(o,Vector.add(this.position,t)))}}),Composite.add(engine.world,bullet[t]),Matter.Body.setVelocity(bullet[t],{x:e*Math.cos(l.angle2),y:e*Math.sin(l.angle2)});const i=Vector.normalise(Vector.perp(bullet[t].velocity));(180-Math.abs(Math.abs(l.lastAngle-l.angle2)-180)>.13||!l.wasExtruderOn)&&(bullet[t].isBranch=!0,bullet[t].do=function(){this.endCycle<simulation.cycle+1&&(this.isWave=!1)}),l.lastAngle=l.angle2}else l.canExtruderFire=!1},l.plasma=function(){const e=75e-5;if(l.energy>e){l.energy-=e,l.energy<0&&(l.fieldCDcycle=l.cycle+120,l.energy=0);let t=l.tech.isPlasmaRange*(120+(l.crouch?400:300)*Math.sqrt(Math.random()));const o=[{x:l.pos.x+20*Math.cos(l.angle2),y:l.pos.y+20*Math.sin(l.angle2)},{x:l.pos.x+t*Math.cos(l.angle2),y:l.pos.y+t*Math.sin(l.angle2)}];let i={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const s=mob.filter((e=>e.collisionFilter.group!==-l.id));if(i=vertexCollision(o[0],o[1],[s,map,body,[player]]),i.dist2!=1/0)if(o[o.length-1]={x:i.x,y:i.y},i.who.alive){const e=.9;if(i.who.damage(e),i.who.speed>3){const e=Vector.mult(Vector.normalise(Vector.sub(l.pos,o[1])),-.005*Math.min(5,i.who.mass));Matter.Body.applyForce(i.who,o[1],e),Matter.Body.setVelocity(i.who,{x:.4*i.who.velocity.x,y:.4*i.who.velocity.y})}else{const e=Vector.mult(Vector.normalise(Vector.sub(l.pos,o[1])),-.01*Math.min(5,i.who.mass));Matter.Body.applyForce(i.who,o[1],e),Matter.Body.setVelocity(i.who,{x:.7*i.who.velocity.x,y:.7*i.who.velocity.y})}simulation.drawList.push({x:o[1].x,y:o[1].y,radius:Math.sqrt(2e3*e*i.who.damageReduction),color:"rgba(255,0,255,0.2)",time:4*simulation.drawTime})}else if(!i.who.isStatic){const e=Vector.mult(Vector.normalise(Vector.sub(l.pos,o[1])),-.007*Math.sqrt(Math.sqrt(i.who.mass)));if(Matter.Body.applyForce(i.who,o[1],e),i.who==player)if(simulation.drawList.push({x:o[1].x,y:o[1].y,radius:Math.sqrt(2e3),color:"rgba(255,0,255,0.2)",time:4*simulation.drawTime}),i.who.speed>3){const e=Vector.mult(Vector.normalise(Vector.sub(l.pos,o[1])),-.005*Math.min(5,i.who.mass));Matter.Body.applyForce(i.who,o[1],e),Matter.Body.setVelocity(i.who,{x:.4*i.who.velocity.x,y:.4*i.who.velocity.y})}else{const e=Vector.mult(Vector.normalise(Vector.sub(l.pos,o[1])),-.01*Math.min(5,i.who.mass));Matter.Body.applyForce(i.who,o[1],e),Matter.Body.setVelocity(i.who,{x:.7*i.who.velocity.x,y:.7*i.who.velocity.y})}}ctx.strokeStyle="rgba(255,0,255,0.1)",ctx.lineWidth=14,ctx.beginPath(),ctx.moveTo(o[0].x,o[0].y),ctx.lineTo(o[1].x,o[1].y),ctx.stroke(),ctx.strokeStyle="#f0f",ctx.lineWidth=2,ctx.stroke();const a=Math.cos(l.angle2),r=Math.sin(l.angle2);let n=l.pos.x+20*a,c=l.pos.y+20*r;ctx.beginPath(),ctx.moveTo(n,c);const h=Vector.magnitude(Vector.sub(o[0],o[1]))/10;for(let e=0;e<8;e++)n+=h*(a+1.5*(Math.random()-.5)),c+=h*(r+1.5*(Math.random()-.5)),ctx.lineTo(n,c);ctx.lineWidth=2*Math.random(),ctx.stroke()}},l.endoThermic=function(e){if(l.tech.isEndothermic){const t=10*e;if(Math.random()<t)for(let e=0;e<t;e++)b2.iceIX(1,l.angle2+2*Math.PI*Math.random(),{x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},l.id)}},l.printBlock=function(){const e=Math.floor(4+6*Math.random()*Math.random());body[body.length]=Matter.Bodies.polygon(l.pos.x,l.pos.y,e,8,{friction:.05,frictionAir:.001,collisionFilter:{category:0,mask:0},classType:"body",isPrinted:!0,radius:10,density:.002});const t=body[body.length-1];Composite.add(engine.world,t),l.throwCharge=4,l.holdingTarget=t,l.isHolding=!0,l.endoThermic(.4)},l.fieldPosition={x:l.pos.x,y:l.pos.y},l.fieldAngle=l.angle2,l.fieldDrawRadius=0,l.oldField=0,l.fieldPhase=0,l.sneakAttackCycle=0,l.enterCloakCycle=0,l.lastFieldPosition={x:l.mouse.x,y:l.mouse.y},l.fieldRadius=0,l.fieldOn=!1,l.pilotWaveCollider=null,l.fieldMass=1,l.drain=1,l.isRewindMode=!1,l.isRewinding=!1,l.isTimeDilated=!1,l.molecularMode=0,l.do=function(){if(this.cycle++,l.pos.x=this.position.x,l.pos.y=a.position.y-this.yOff,l.Vx=this.velocity.x,l.Vy=this.velocity.y,this.force.y+=this.mass*simulation.g,!l.isCloak){l.draw();const d=.3*m.radius,y=2*m.radius,u=l.position.x-y/2,p=l.pos.y-50;ctx.fillStyle="rgba(100, 100, 100, 0.3)",ctx.fillRect(u,p,y,d),ctx.fillStyle="rgba(255,0,0,0.7)",ctx.fillRect(u,p,y*(l.health/l.maxHealth),d),l.crosshair.x=h(l.crosshair.x,l.mouse.x,.2),l.crosshair.y=h(l.crosshair.y,l.mouse.y,.2);const g=10;ctx.beginPath(),ctx.moveTo(l.crosshair.x-g,l.crosshair.y),ctx.lineTo(l.crosshair.x+g,l.crosshair.y),ctx.moveTo(l.crosshair.x,l.crosshair.y-g),ctx.lineTo(l.crosshair.x,l.crosshair.y+g),ctx.lineWidth=2,ctx.strokeStyle="#000000",ctx.stroke(),l.lastTextPos.x=h(l.lastTextPos.x,l.position.x,.5),l.lastTextPos.y=h(l.lastTextPos.y,l.pos.y-70,.5),ctx.fillStyle="#000",ctx.font="30px Arial",ctx.textAlign="center",ctx.fillText(l.username,l.lastTextPos.x,l.lastTextPos.y)}if(l.history.splice(simulation.cycle%600,1,{position:{x:l.position.x,y:l.position.y},velocity:{x:l.velocity.x,y:l.velocity.y},yOff:l.yOff,angle:l.angle2,health:l.health,energy:l.energy,activeGun:l.activeGun}),l.onGround?l.groundControl():l.airControl(),0==l.fieldMode)l.grabPowerUpRange2=2e5,l.isHolding?(l.drawHold(l.holdingTarget),l.holding(),l.throwBlockDefault()):l.inputField&&l.fieldCDcycle<l.cycle?(l.energy>l.fieldRegen&&(l.energy-=l.fieldRegen),l.grabPowerUp(),l.lookForBlock(),l.energy>l.minEnergyToDeflect&&(l.drawField(),l.pushMobsFacing())):l.holdingTarget&&l.fieldCDcycle<l.cycle?l.pickUp():l.holdingTarget=null;else if(1==l.fieldMode)l.blockingRecoil=1,l.grabPowerUpRange2=2e5,l.fieldRange=185,l.fieldShieldingScale=1.6*Math.pow(.5,l.tech.harmonics-2),l.isHolding?(l.drawHold(l.holdingTarget),l.holding(),l.throwBlockDefault()):l.inputField&&l.fieldCDcycle<l.cycle?(l.energy>l.fieldRegen&&(l.energy-=l.fieldRegen),l.grabPowerUp(),l.lookForBlock()):l.holdingTarget&&l.fieldCDcycle<l.cycle?l.pickUp():l.holdingTarget=null,l.energy>l.minEnergyToDeflect&&l.fieldCDcycle<l.cycle&&(l.tech.isStandingWaveExpand&&(l.inputField?l.harmonicRadius=.99*l.harmonicRadius+.04:l.harmonicRadius=.994*l.harmonicRadius+.006),simulation.isTimeSkipping||(2===l.tech.harmonics?l.harmonicShield=l.harmonic3Phase:l.harmonicShield=l.harmonicAtomic,l.harmonicShield()));else if(2==l.fieldMode){l.fieldShieldingScale=0,l.fieldBlockCD=3,l.grabPowerUpRange2=1e7;const f=Math.sin(.022*l.cycle);if(l.fieldRange=180+12*f+100*l.tech.isBigField,l.fieldArc=.35+.045*f+.065*l.tech.isBigField,l.calculateFieldThreshold(),l.isHolding)l.drawHold(l.holdingTarget),l.holding(),l.throwBlockDefault();else if(l.inputField){const x=.5+.7*(Math.PI/2-Math.min(Math.PI/2,Math.abs(l.angle2+Math.PI/2)));if(l.velocity.y>1){l.force.y-=x*(l.tech.isBigField?.95:.5)*l.mass*simulation.g;const V=7e-4*x*l.mass;l.velocity.x>.5?l.force.x+=V:l.velocity.x<-.5&&(l.force.x-=V),Matter.Body.setVelocity(l,{x:l.velocity.x,y:.98*l.velocity.y})}l.energy>l.fieldRegen&&(l.energy-=l.fieldRegen),l.grabPowerUp(),l.lookForBlock(),l.fieldPosition={x:l.pos.x,y:l.pos.y},l.fieldAngle=l.angle2,l.holdingTarget?(ctx.fillStyle=`rgba(110,150,220, ${.06+.03*Math.random()})`,ctx.strokeStyle=`rgba(110,150,220, ${.35+.05*Math.random()})`):(ctx.fillStyle=`rgba(110,150,220, ${.27+.2*Math.random()-.1*f})`,ctx.strokeStyle=`rgba(110,150,220, ${.4+.5*Math.random()})`),ctx.beginPath(),ctx.arc(l.pos.x,l.pos.y,l.fieldRange,l.angle2-Math.PI*l.fieldArc,l.angle2+Math.PI*l.fieldArc,!1),ctx.lineWidth=2.5-1.5*f,ctx.stroke();const M=.57+.04*f,P=(1-1.2*M)*Math.PI*l.fieldArc;let w=l.angle2+P,v=l.pos.x+M*l.fieldRange*Math.cos(w),B=l.pos.y+M*l.fieldRange*Math.sin(w);ctx.quadraticCurveTo(v,B,l.pos.x+30*Math.cos(l.angle2),l.pos.y+30*Math.sin(l.angle2)),w=l.angle2-P,v=l.pos.x+M*l.fieldRange*Math.cos(w),B=l.pos.y+M*l.fieldRange*Math.sin(w),ctx.quadraticCurveTo(v,B,l.pos.x+1*l.fieldRange*Math.cos(l.angle2-Math.PI*l.fieldArc),l.pos.y+1*l.fieldRange*Math.sin(l.angle2-Math.PI*l.fieldArc)),ctx.fill(),l.perfectPush()}else if(l.holdingTarget&&l.fieldCDcycle<l.cycle)l.pickUp();else if(l.holdingTarget=null,!l.inputField){ctx.fillStyle=`rgba(110,150,220, ${.27+.2*Math.random()-.1*f})`,ctx.strokeStyle=`rgba(110,180,255, ${.4+.5*Math.random()})`,ctx.beginPath(),ctx.arc(l.fieldPosition.x,l.fieldPosition.y,l.fieldRange,l.fieldAngle-Math.PI*l.fieldArc,l.fieldAngle+Math.PI*l.fieldArc,!1),ctx.lineWidth=2.5-1.5*f,ctx.stroke();const k=.8+.06*f,C=(1-1.2*k)*Math.PI*l.fieldArc;let D=l.fieldAngle+C;ctx.quadraticCurveTo(l.fieldPosition.x+k*l.fieldRange*Math.cos(D),l.fieldPosition.y+k*l.fieldRange*Math.sin(D),l.fieldPosition.x+1*l.fieldRange*Math.cos(l.fieldAngle-Math.PI*l.fieldArc),l.fieldPosition.y+1*l.fieldRange*Math.sin(l.fieldAngle-Math.PI*l.fieldArc)),ctx.fill(),l.perfectPush(!0)}if(l.tech.isPerfectBrake){const T=200+140*f+150*l.energy;for(let S=0;S<mob.length;S++){if(Vector.magnitude(Vector.sub(l.pos,mob[S].position))<T&&mob[S].id!=l.id){const R=mob[S].isShielded?8:4;mob[S].speed>R&&Vector.dot(mob[S].velocity,Vector.sub(l.pos,mob[S].position))>0&&Matter.Body.setVelocity(mob[S],Vector.mult(Vector.normalise(mob[S].velocity),R))}}Vector.magnitude(Vector.sub(l.pos,mob[i].position))<T&&player.speed>cap&&Vector.dot(player.velocity,Vector.sub(l.pos,player.position))>0&&Matter.Body.setVelocity(player,Vector.mult(Vector.normalise(player.velocity),cap)),ctx.beginPath(),ctx.arc(l.pos.x,l.pos.y,T,0,2*Math.PI),ctx.fillStyle="hsla(200,50%,61%,0.08)",ctx.fill()}}else if(3==l.fieldMode)if(l.holdingMassScale=.01,l.grabPowerUpRange2=2e5,l.airSpeedLimit=125,l.FxAir=.016,l.isHolding)l.drawHold(l.holdingTarget),l.holding(),l.throwBlockDefault();else if(l.inputField){if(l.energy>l.fieldRegen&&l.tech.negativeMassCost>0&&(l.energy-=l.fieldRegen),l.grabPowerUp(),l.lookForBlock(),l.energy>0&&l.fieldCDcycle<l.cycle){if(l.tech.isFlyFaster){function e(e,t,o=1.06){for(let i=0,s=e.length;i<s;++i)sub=Vector.sub(e[i].position,l.pos),dist=Vector.magnitude(sub),dist<t&&(e[i].force.y-=e[i].mass*(simulation.g*o),l.inputLeft?e[i].force.x-=l.FxAir*e[i].mass/10:l.inputRight&&(e[i].force.x+=l.FxAir*e[i].mass/10))}l.airSpeedLimit=1e3,l.FxAir=.01,l.inputDown?(l.force.y+=.5*l.mass*simulation.g,this.fieldDrawRadius=.97*this.fieldDrawRadius+15,e(powerUp,this.fieldDrawRadius,0),e(body,this.fieldDrawRadius,0)):l.inputUp?(l.energy-=5*l.tech.negativeMassCost,this.fieldDrawRadius=.97*this.fieldDrawRadius+33,l.force.y-=2.25*l.mass*simulation.g,e(powerUp,this.fieldDrawRadius,1.8),e(body,this.fieldDrawRadius,1.8)):(l.energy-=l.tech.negativeMassCost,this.fieldDrawRadius=.97*this.fieldDrawRadius+24,l.force.y-=1.07*l.mass*simulation.g,e(powerUp,this.fieldDrawRadius),e(body,this.fieldDrawRadius))}else{function t(e,t,o=1.06){for(let i=0,s=e.length;i<s;++i)sub=Vector.sub(e[i].position,l.pos),dist=Vector.magnitude(sub),dist<t&&(e[i].force.y-=e[i].mass*(simulation.g*o),l.inputLeft?e[i].force.x-=l.FxAir*e[i].mass/10:l.inputRight&&(e[i].force.x+=l.FxAir*e[i].mass/10))}l.airSpeedLimit=400,l.FxAir=.005,l.inputDown?(l.force.y-=.5*l.mass*simulation.g,this.fieldDrawRadius=.97*this.fieldDrawRadius+12,t(powerUp,this.fieldDrawRadius,.7),t(body,this.fieldDrawRadius,.7)):l.inputUp?(l.energy-=5*l.tech.negativeMassCost,this.fieldDrawRadius=.97*this.fieldDrawRadius+25.5,l.force.y-=1.45*l.mass*simulation.g,t(powerUp,this.fieldDrawRadius,1.38),t(body,this.fieldDrawRadius,1.38)):(l.energy-=l.tech.negativeMassCost,this.fieldDrawRadius=.97*this.fieldDrawRadius+19.5,l.force.y-=1.07*l.mass*simulation.g,t(powerUp,this.fieldDrawRadius),t(body,this.fieldDrawRadius))}l.energy<0&&(l.fieldCDcycle=l.cycle+120,l.energy=0),l.inputDown||l.inputUp||l.inputLeft||l.inputRight,Matter.Body.setVelocity(l,{x:.99*l.velocity.x,y:.98*l.velocity.y}),simulation.isTimeSkipping||(ctx.beginPath(),ctx.arc(l.pos.x,l.pos.y,this.fieldDrawRadius,0,2*Math.PI),ctx.fillStyle="#f5f5ff",ctx.globalCompositeOperation="difference",ctx.fill(),ctx.globalCompositeOperation="source-over")}}else l.holdingTarget&&l.fieldCDcycle<l.cycle?(l.pickUp(),this.fieldDrawRadius=0):(l.holdingTarget=null,this.fieldDrawRadius=0);else if(4==l.fieldMode){if(l.energy>l.maxEnergy-.02&&l.fieldCDcycle<l.cycle&&!l.inputField&&bullet.length<300&&l.cycle%2)if(0===l.molecularMode)if(l.tech.isSporeFlea){const U=.18+.02*(Math.max(bullet.length,130)-130);if(l.energy>U){l.energy-=U;const F=l.crouch?20+8*Math.random():10+3*Math.random();b2.flea({x:l.pos.x+35*Math.cos(l.angle2),y:l.pos.y+35*Math.sin(l.angle2)},{x:F*Math.cos(l.angle2),y:F*Math.sin(l.angle2)},6+3*Math.random()+10*l.tech.wormSize*Math.random(),l.id),l.endoThermic(U)}}else if(l.tech.isSporeWorm){const A=.18+.02*(Math.max(bullet.length,130)-130);if(l.energy>A){l.energy-=A,b2.worm({x:l.pos.x+35*Math.cos(l.angle2),y:l.pos.y+35*Math.sin(l.angle2)},l.tech.isSporeFlea,l.id);const I=2+1*Math.random();Matter.Body.setVelocity(bullet[bullet.length-1],{x:I*Math.cos(l.angle2),y:I*Math.sin(l.angle2)}),l.endoThermic(A)}}else{const L=.095+.01*(Math.max(bullet.length,130)-130);for(let O=0,E=5;O<E&&l.energy>3*L;O++){l.energy-=L;const H=Vector.rotate({x:1,y:0},6.28*Math.random());b2.spore(Vector.add(l.pos,Vector.mult(H,25)),Vector.mult(H,10),l.id),l.endoThermic(L)}}else if(1===l.molecularMode){const W=.33;l.energy-=W;const Q={x:Math.cos(l.angle2),y:Math.sin(l.angle2)},_=Vector.mult(Vector.perp(Q),.08);b2.missile({x:l.pos.x+30*Q.x,y:l.pos.y+30*Q.y},l.angle2,-15,1,l.id),bullet[bullet.length-1].force.x+=_.x*(Math.random()-.5),bullet[bullet.length-1].force.y+=.005+_.y*(Math.random()-.5),l.endoThermic(W)}else if(2===l.molecularMode){const G=.04;l.energy-=G,b2.iceIX(1,l.angle2+2*Math.PI*Math.random(),{x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},l.id),l.endoThermic(G)}else if(3===l.molecularMode)if(l.tech.isDroneRadioactive){const N=.8+.01*(Math.max(bullet.length,50)-50);l.energy>N&&(l.energy-=N,b2.droneRadioactive({x:l.pos.x+30*Math.cos(l.angle2)+10*(Math.random()-.5),y:l.pos.y+30*Math.sin(l.angle2)+10*(Math.random()-.5)},25,l.id),l.endoThermic(N))}else{const z=(.45+.006*(Math.max(bullet.length,100)-100))*l.tech.droneEnergyReduction;l.energy>z&&(l.energy-=z,b2.drone({x:l.pos.x+30*Math.cos(l.angle2)+20*(Math.random()-.5),y:l.pos.y+30*Math.sin(l.angle2)+20*(Math.random()-.5)},1,l.id),l.endoThermic(z))}if(l.isHolding){if(l.drawHold(l.holdingTarget),l.holding(),l.tech.isPrinter&&l.holdingTarget.isPrinted&&l.inputField){l.holdingTarget.radius+=Math.min(1.1,1.3/l.holdingTarget.mass);const $=l.holdingTarget.radius*(1+.12*Math.sin(.11*l.cycle)),j=l.holdingTarget.radius*(1+.12*Math.cos(.11*l.cycle));let X=.01*l.cycle%(2*Math.PI),J=[];for(let K=0,Y=l.holdingTarget.vertices.length;K<Y;K++)X+=2*Math.PI/Y,J.push({x:l.holdingTarget.position.x+$*Math.cos(X),y:l.holdingTarget.position.y+j*Math.sin(X)});Matter.Body.setVertices(l.holdingTarget,J),l.definePlayerMass(l.defaultMass+l.holdingTarget.mass*l.holdingMassScale)}l.throwBlockDefault()}else l.inputField&&l.fieldCDcycle<l.cycle?(l.energy>l.fieldRegen&&(l.energy-=l.fieldRegen),l.grabPowerUp(),l.lookForBlock(),l.tech.isPrinter&&l.inputDown?l.printBlock():l.energy>l.minEnergyToDeflect&&(l.drawField(),l.pushMobsFacing())):l.holdingTarget&&l.fieldCDcycle<l.cycle?l.pickUp():l.holdingTarget=null}else if(5==l.fieldMode)if(l.tech.isPlasmaBall){if(l.plasmaBall||(l.plasmaBall=Bodies.circle(l.pos.x+10*Math.cos(l.angle2),l.pos.y+10*Math.sin(l.angle2),1,{isSensor:!0,frictionAir:0,alpha:.7,isAttached:!1,isOn:!1,drain:.0018,radiusLimit:10,damage:.7,effectRadius:10,setPositionToNose(){const e={x:l.pos.x+27*Math.cos(l.angle2),y:l.pos.y+27*Math.sin(l.angle2)};l.plasmaBall.effectRadius=2*l.plasmaBall.circleRadius,Matter.Body.setPosition(this,Vector.add(e,Vector.mult(Vector.normalise(Vector.sub(e,l.pos)),this.effectRadius)))},fire(){l.energy>.06&&(l.energy-=.06),this.isAttached=!1;const e=5+Math.min(15,80/this.mass);Matter.Body.setVelocity(this,{x:.4*l.velocity.x+e*Math.cos(l.angle2),y:e*Math.sin(l.angle2)}),l.plasmaBall.setPositionToNose()},scale(e){this.circleRadius>this.radiusLimit&&Matter.Body.scale(l.plasmaBall,e,e)},reset(){const e=1/this.circleRadius;Matter.Body.scale(this,e,e),this.alpha=.7,this.isOn=!1},do(){if(this.isOn){this.effectRadius=2*l.plasmaBall.circleRadius*(.6+.4*l.tech.isPlasmaRange),Matter.Query.collides(this,map).length>0&&(this.isAttached?this.scale(Math.max(.9,.99-.1/this.circleRadius)):(l.plasmaBall.explode(),Matter.Body.setVelocity(this,{x:0,y:0}),this.reset()));const e=this.damage*(l.tech.isControlPlasma&&!this.isAttached?2:1),t=[],o=150+1600*l.tech.plasmaDischarge+1.3*this.effectRadius;for(let i=0,s=mob.length;i<s;i++)if(mob[i].alive&&(!mob[i].isBadTarget||mob[i].isMobBullet||mob[i].id!=l.id)&&!mob[i].isInvulnerable){const l=Vector.magnitude(Vector.sub(this.position,mob[i].position));l<this.effectRadius+mob[i].radius?(mob[i].damage(e),mob[i].speed>5?Matter.Body.setVelocity(mob[i],{x:.6*mob[i].velocity.x,y:.6*mob[i].velocity.y}):Matter.Body.setVelocity(mob[i],{x:.93*mob[i].velocity.x,y:.93*mob[i].velocity.y})):l<o+mob[i].radius&&0===Matter.Query.ray(map,mob[i].position,this.position).length&&t.push(mob[i])}Vector.magnitude(Vector.sub(this.position,player.position))<this.effectRadius+m.radius&&(player.speed>5?Matter.Body.setVelocity(player,{x:.6*player.velocity.x,y:.6*player.velocity.y}):Matter.Body.setVelocity(player,{x:.93*player.velocity.x,y:.93*player.velocity.y}));for(let o=0;o<t.length;o++)if(l.tech.plasmaDischarge>Math.random()){const o=t[Math.floor(Math.random()*t.length)];o.damage(4*e);const i=Vector.sub(o.position,this.position),l=Vector.normalise(i);let s=12;const a=Vector.magnitude(i)/(s+2);let r=this.position.x,n=this.position.y;ctx.beginPath(),ctx.moveTo(r,n);for(let e=0;e<s;e++)r+=a*(l.x+(Math.random()-.5)),n+=a*(l.y+(Math.random()-.5)),ctx.lineTo(r,n);ctx.lineTo(o.position.x,o.position.y),ctx.strokeStyle="#88f",ctx.lineWidth=6+3*Math.random(),ctx.stroke(),o.damageReduction&&simulation.drawList.push({x:o.position.x,y:o.position.y,radius:15,color:"rgba(150,150,255,0.4)",time:15})}const i=this.effectRadius*(.99+.02*Math.random())+3*Math.random(),s=ctx.createRadialGradient(this.position.x,this.position.y,0,this.position.x,this.position.y,i),a=this.alpha+.15*Math.random(),r=.75+.1*Math.random();if(s.addColorStop(0,`rgba(255,255,255,${a})`),s.addColorStop(r,`rgba(255,245,255,${a})`),s.addColorStop(r+.1,`rgba(255,200,255,${a})`),s.addColorStop(1,`rgba(255,75,255,${a})`),ctx.fillStyle=s,ctx.beginPath(),ctx.arc(this.position.x,this.position.y,i,0,2*Math.PI),ctx.fill(),l.tech.isControlPlasma){this.isAttached||(ctx.strokeStyle="rgb(255, 0, 212)",ctx.lineWidth=Math.max(2,.04*this.effectRadius),ctx.stroke());const e=Vector.normalise(Vector.sub(simulation.mouseInGame,this.position)),t=Vector.magnitude(this.velocity),o=Vector.mult(e,.008*Math.pow(t,1.8));Matter.Body.setVelocity(this,Vector.add(o,this.velocity)),Matter.Body.setVelocity(this,Vector.mult(Vector.normalise(this.velocity),t))}ctx.beginPath();const n=Vector.rotate({x:1,y:0},6.28*Math.random());let c=Vector.add(this.position,Vector.mult(n,.98*i));ctx.moveTo(c.x,c.y);const h=Vector.normalise(Vector.sub(this.position,c));for(let e=0,t=7;e<t;e++){const e=Vector.rotate(Vector.mult(h,17*Math.random()),2*(Math.random()-.5));c=Vector.add(c,e),ctx.lineTo(c.x,c.y)}ctx.strokeStyle="#88f",ctx.lineWidth=.5+2*Math.random(),ctx.stroke()}},explode(){simulation.ephemera.push({vertices:this.vertices,position:{x:l.plasmaBall.position.x,y:l.plasmaBall.position.y},radius:l.plasmaBall.effectRadius,alpha:1,do(){this.radius*=1.05,this.alpha-=.05,this.alpha<0&&simulation.removeEphemera(this);const e=this.radius*(.99+.02*Math.random())+3*Math.random(),t=ctx.createRadialGradient(this.position.x,this.position.y,0,this.position.x,this.position.y,e),o=this.alpha+.15*Math.random(),i=.75+.1*Math.random();t.addColorStop(0,`rgba(255,255,255,${o})`),t.addColorStop(i,`rgba(255,245,255,${o})`),t.addColorStop(i+.1,`rgba(255,200,255,${o})`),t.addColorStop(1,`rgba(255,75,255,${o})`),ctx.fillStyle=t,ctx.beginPath(),ctx.arc(this.position.x,this.position.y,e,0,2*Math.PI),ctx.fill();const s=l.plasmaBall.damage;for(let e=0,t=mob.length;e<t;e++)if(mob[e].alive&&(!mob[e].isBadTarget||mob[e].isMobBullet)&&!mob[e].isInvulnerable){Vector.magnitude(Vector.sub(this.position,mob[e].position))<this.radius+mob[e].radius&&mob[e].damage(s)}}})}}),Composite.add(engine.world,l.plasmaBall)),l.isHolding)l.drawHold(l.holdingTarget),l.holding(),l.throwBlockDefault();else if(l.inputField){if(l.tech.isPlasmaBoost&&powerUps.boost.endCycle<simulation.cycle+60&&(powerUps.boost.endCycle=simulation.cycle+60),l.energy>l.fieldRegen&&(l.energy-=l.fieldRegen),l.grabPowerUp(),l.lookForBlock(),l.fieldCDcycle<l.cycle)if(l.plasmaBall.isAttached)if(l.energy>l.plasmaBall.drain){if(l.tech.isCapacitor){l.energy-=2*l.plasmaBall.drain;const ee=1+48*Math.pow(Math.max(1,l.plasmaBall.circleRadius),-1.8);Matter.Body.scale(l.plasmaBall,ee,ee)}else{l.energy-=l.plasmaBall.drain;const te=1+16*Math.pow(Math.max(1,l.plasmaBall.circleRadius),-1.8);Matter.Body.scale(l.plasmaBall,te,te)}if(l.energy>l.maxEnergy){l.energy-=2*l.plasmaBall.drain;const oe=1+16*Math.pow(Math.max(1,l.plasmaBall.circleRadius),-1.8);Matter.Body.scale(l.plasmaBall,oe,oe)}l.plasmaBall.setPositionToNose();const Z=l.velocity.y>0?Math.max(.5,1-.006*l.velocity.y*l.velocity.y):Math.max(.997,1-.001*Math.abs(l.velocity.y));Matter.Body.setVelocity(l,{x:Math.max(.95,1-.002*Math.abs(l.velocity.x))*l.velocity.x,y:Z*l.velocity.y}),l.velocity.y>5?l.force.y-=.9*l.mass*simulation.g:l.force.y-=.5*l.mass*simulation.g}else l.plasmaBall.fire();else l.plasmaBall.isOn?(l.plasmaBall.explode(),l.plasmaBall.reset()):(l.plasmaBall.isAttached=!0,l.plasmaBall.isOn=!0,l.plasmaBall.alpha=.7,l.plasmaBall.setPositionToNose())}else l.holdingTarget&&l.fieldCDcycle<l.cycle?(l.pickUp(),l.plasmaBall.isAttached&&l.plasmaBall.fire()):(l.holdingTarget=null,l.plasmaBall.isAttached&&l.plasmaBall.fire());l.plasmaBall.do()}else if(l.tech.isExtruder){l.isExtruderOn=!1,l.isHolding?(l.drawHold(l.holdingTarget),l.holding(),l.throwBlockDefault()):l.inputField&&l.fieldCDcycle<l.cycle?(l.tech.isPlasmaBoost&&powerUps.boost.endCycle<simulation.cycle+60&&(powerUps.boost.endCycle=simulation.cycle+60),l.energy>l.fieldRegen&&(l.energy-=l.fieldRegen),l.grabPowerUp(),l.lookForBlock(),l.extruder()):l.holdingTarget&&l.fieldCDcycle<l.cycle?l.pickUp():l.holdingTarget=null,l.inputField?l.wasExtruderOn=!0:(l.wasExtruderOn=!1,l.canExtruderFire=!0),ctx.beginPath();for(let ie=1,le=bullet.length;ie<le;ie++)bullet[ie].isWave&&(bullet[ie].isBranch||bullet[ie-1].isBranch?ctx.moveTo(bullet[ie].position.x,bullet[ie].position.y):ctx.lineTo(bullet[ie].position.x,bullet[ie].position.y));l.wasExtruderOn&&l.isExtruderOn&&ctx.lineTo(l.pos.x+15*Math.cos(l.angle2),l.pos.y+15*Math.sin(l.angle2)),ctx.lineWidth=4,ctx.strokeStyle="#f07",ctx.stroke(),ctx.lineWidth=l.tech.extruderRange,ctx.strokeStyle="rgba(255,0,110,0.06)",ctx.stroke()}else l.isHolding?(l.drawHold(l.holdingTarget),l.holding(),l.throwBlockDefault()):l.inputField&&l.fieldCDcycle<l.cycle?(l.tech.isPlasmaBoost&&powerUps.boost.endCycle<simulation.cycle+60&&(powerUps.boost.endCycle=simulation.cycle+60),l.energy>l.fieldRegen&&(l.energy-=l.fieldRegen),l.grabPowerUp(),l.lookForBlock(),l.plasma()):l.holdingTarget&&l.fieldCDcycle<l.cycle?l.pickUp():l.holdingTarget=null;else if(6==l.fieldMode)if(l.isRewindMode){if(l.inputField&&l.grabPowerUp(),l.isHolding)l.drawHold(l.holdingTarget),l.holding(),l.throwBlock(),l.wakeCheck();else if(l.inputField&&l.fieldCDcycle<l.cycle){const se=.002*l.rewindDrain;if(l.rewindDrain*=1.0015,0===this.rewindCount&&l.lookForBlock(),!l.holdingTarget){l.energy>se?l.timeStop():(l.fieldCDcycle=l.cycle+120,l.energy=0,l.wakeCheck(),l.wakeCheck()),this.isRewinding=!0,this.rewindCount+=2;let ae=l.history[(simulation.cycle-this.rewindCount)%600];if(this.rewindCount>599||l.energy<se)this.rewindCount=0,l.resetHistory(),l.fireCDcycle<l.cycle+60&&(l.fieldCDcycle=l.cycle+60),l.immuneCycle=l.cycle;else{ctx.globalCompositeOperation="saturation",ctx.fillStyle="#ccc",ctx.fillRect(-1e5,-1e5,2e5,2e5),ctx.globalCompositeOperation="source-over",l.energy-=se,l.immuneCycle<l.cycle+5&&(l.immuneCycle=l.cycle+5),Matter.Body.setPosition(l,ae.position),Matter.Body.setVelocity(l,{x:ae.velocity.x,y:ae.velocity.y}),l.yOff=ae.yOff,l.yOff<48?l.doCrouch():l.undoCrouch(),ctx.beginPath(),ctx.moveTo(l.pos.x,l.pos.y);const re=this.rewindCount/600;ctx.arc(l.pos.x,l.pos.y,30,3*Math.PI/2,2*Math.PI*(1-re)+3*Math.PI/2),ctx.lineTo(l.pos.x,l.pos.y),ctx.fillStyle=`rgba(0,150,150,${re})`,ctx.fill(),l.grabPowerUpEasy()}}}else l.holdingTarget&&l.fieldCDcycle<l.cycle?(l.pickUp(),this.rewindCount=0,l.wakeCheck()):l.tech.isTimeStop&&l.speed<1&&l.onGround&&!l.inputFire?(l.timeStop(),this.rewindCount=0):(l.holdingTarget=null,this.rewindCount=0,l.wakeCheck());l.inputField&&l.fieldCDcycle<l.cycle||(l.rewindDrain>1&&(l.rewindDrain/=1.0005),this.isRewinding&&(this.isRewinding=!1,l.resetHistory()))}else if(l.isHolding)l.wakeCheck(),l.drawHold(l.holdingTarget),l.holding(),l.throwBlockDefault();else if(l.inputField&&l.fieldCDcycle<l.cycle){const ne=.0026;l.energy>ne&&(l.energy-=ne),l.grabPowerUp(),l.lookForBlock(),l.energy>ne?l.timeStop():(l.fieldCDcycle=l.cycle+120,l.energy=0,l.wakeCheck(),l.wakeCheck())}else l.tech.isTimeStop&&l.speed<1&&l.onGround&&l.fireCDcycle<l.cycle&&!l.inputFire?l.timeStop():l.holdingTarget&&l.fieldCDcycle<l.cycle?(l.wakeCheck(),l.pickUp()):(l.wakeCheck(),l.holdingTarget=null);else if(7==l.fieldMode){if(l.isSneakAttack=!0,l.isHolding?(l.drawHold(l.holdingTarget),l.holding(),l.throwBlockDefault()):l.inputField&&l.fieldCDcycle<l.cycle?(l.energy>l.fieldRegen&&(l.energy-=l.fieldRegen),l.grabPowerUp(),l.lookForBlock()):l.holdingTarget&&l.fieldCDcycle<l.cycle?l.pickUp():l.holdingTarget=null,l.energy<.05&&l.fireCDcycle<l.cycle&&!l.inputFire&&(l.fireCDcycle=l.cycle),l.fireCDcycle+10<l.cycle&&!l.inputFire)l.isCloak||(l.isCloak=!0,l.enterCloakCycle=l.cycle);else if(l.isCloak){if(l.sneakAttackCycle=l.cycle,l.isCloak=!1,l.tech.isIntangible)for(let ce=0;ce<bullet.length;ce++)bullet[ce].botType&&"orbit"!==bullet[ce].botType&&(bullet[ce].collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet|cat.mobShield);if(l.tech.isCloakStun){const he=1.25*l.fieldDrawRadius;for(let de=0,ye=mob.length;de<ye;++de)Vector.magnitude(Vector.sub(mob[de].position,l.pos))<he&&0===Matter.Query.ray(map,mob[de].position,l.pos).length&&!mob[de].isBadTarget&&(isMobsAround=!0,mobs.statusStun(mob[de],120))}}if(l.isCloak?(l.fieldRange=.85*l.fieldRange,l.fieldDrawRadius=1.1*l.fieldRange,l.drawCloak()):l.fieldRange<4e3&&(l.fieldRange+=90,l.fieldDrawRadius=l.fieldRange),l.tech.isIntangible&&(l.isCloak?l.collisionFilter.mask=cat.map:l.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob),l.isSneakAttack&&l.sneakAttackCycle+Math.min(100,.66*(l.cycle-l.enterCloakCycle))>l.cycle){const me=.5*(l.sneakAttackCycle+Math.min(100,.66*(l.cycle-l.enterCloakCycle))-l.cycle);ctx.beginPath(),ctx.arc(l.pos.x,l.pos.y,32,0,2*Math.PI),ctx.strokeStyle="rgba(180,30,70,0.5)",ctx.lineWidth=Math.max(Math.min(10,me),3),ctx.stroke()}}else if(8==l.fieldMode){let ue=l.tech.isNoPilotCost?!l.inputField:l.inputField;if(l.tech.isPrinter)if(l.inputField&&l.fieldCDcycle<l.cycle&&l.inputDown&&!l.isHolding&&l.printBlock(),l.isHolding){if(l.drawHold(l.holdingTarget),l.holding(),l.tech.isPrinter&&l.holdingTarget.isPrinted&&l.inputField){l.holdingTarget.radius+=Math.min(1.1,1.3/l.holdingTarget.mass);const pe=l.holdingTarget.radius*(1+.12*Math.sin(.11*l.cycle)),ge=l.holdingTarget.radius*(1+.12*Math.cos(.11*l.cycle));let fe=.01*l.cycle%(2*Math.PI),xe=[];for(let be=0,Me=l.holdingTarget.vertices.length;be<Me;be++)fe+=2*Math.PI/Me,xe.push({x:l.holdingTarget.position.x+pe*Math.cos(fe),y:l.holdingTarget.position.y+ge*Math.sin(fe)});Matter.Body.setVertices(l.holdingTarget,xe),l.definePlayerMass(l.defaultMass+l.holdingTarget.mass*l.holdingMassScale)}l.throwBlock()}else l.holdingTarget=null;if(ue)if(l.fieldCDcycle<l.cycle){l.fieldOn||(l.fieldOn=!0,Matter.Body.setPosition(l.pilotWaveCollider,l.pos),l.fieldPosition.x=l.pos.x,l.fieldPosition.y=l.pos.y);const Pe=1.2,we=Vector.sub(l.mouse,l.pilotWaveCollider.position),ve=Vector.magnitude(we),Be=Math.max(1.5,Math.pow(l.fieldMass,.3)),Ve=17e-8/Be*Math.pow(ve,2);let ke=Vector.mult(Vector.normalise(we),Ve);const Ce=.17/Be;Vector.magnitude(ke)>Ce&&(ke=Vector.mult(Vector.normalise(ke),Ce)),l.pilotWaveCollider.force=ke,Matter.Query.ray(map,l.fieldPosition,l.pilotWaveCollider.position).length&&(Matter.Body.setVelocity(l.pilotWaveCollider,Vector.mult(l.pilotWaveCollider.velocity,.6)),l.fieldRadius*=.6),l.fieldPosition.x=l.pilotWaveCollider.position.x,l.fieldPosition.y=l.pilotWaveCollider.position.y;for(let Ue=0,Fe=powerUp.length;Ue<Fe;++Ue){if(l.tech.isEnergyNoAmmo&&"ammo"===powerUp[Ue].name)continue;const Ae=l.fieldPosition.x-powerUp[Ue].position.x,Ie=l.fieldPosition.y-powerUp[Ue].position.y,Le=Ae*Ae+Ie*Ie+200,Oe=Pe*l.fieldRadius;if(Le<Oe*Oe&&!simulation.isChoosing&&(l.tech.isOverHeal||"heal"!==powerUp[Ue].name||l.maxHealth-l.health>.01)){simulation.ephemera.push({count:5,PposX:powerUp[Ue].position.x,PposY:powerUp[Ue].position.y,size:powerUp[Ue].size,color:powerUp[Ue].color,do(){this.count--,this.count<0&&simulation.removeEphemera(this),ctx.beginPath(),ctx.arc(this.PposX,this.PposY,this.size*(this.count+2)/7,0,2*Math.PI),ctx.fillStyle=this.color,ctx.fill()}}),powerUps.onPickUp(powerUp[Ue]),Matter.Composite.remove(engine.world,powerUp[Ue]),powerUp.splice(Ue,1);break}}let De,Te,Se;Matter.Query.ray(map,l.fieldPosition,player.position).length?(De=0,Te=.995,Se=1.5*l.fieldRegen*l.drain):(De=Math.max(50,250-2*l.pilotWaveCollider.speed),Te=.97,Se=l.fieldRegen*l.drain),l.tech.isNoPilotCost&&(Se=0),l.fieldRadius=l.fieldRadius*Te+De*(1-Te);const Re=Math.max(0,l.pilotWaveCollider.speed-l.pilotWaveCollider.lastSpeed);if(l.pilotWaveCollider.lastSpeed=l.pilotWaveCollider.speed,l.energy>=Se){l.energy-=Se,l.fieldMass=1;for(let We=0,Qe=body.length;We<Qe;++We)if(Vector.magnitude(Vector.sub(body[We].position,l.fieldPosition))<l.fieldRadius&&!body[We].isNotHoldable){const _e=l.drain*Re*body[We].mass*95e-6;if(!(l.energy>_e)){l.fieldCDcycle=l.cycle+60,l.fieldOn=!1,l.fieldRadius=0;break}{l.energy-=_e,Matter.Body.setVelocity(body[We],l.pilotWaveCollider.velocity),Matter.Body.setAngularVelocity(body[We],.8*body[We].angularVelocity),l.fieldMass+=body[We].mass;const Ge=Vector.sub(l.fieldPosition,body[We].position),Ne=Vector.mult(Vector.normalise(Ge),1e-4*body[We].mass*Vector.magnitude(Ge));if(body[We].force.x+=Ne.x,body[We].force.y+=Ne.y-body[We].mass*simulation.g,l.standingOn===body[We]&&l.onGround){l.walk_cycle-=l.flipLegs*l.Vx,l.stepSize=0,Matter.Body.setAngularVelocity(body[We],0*body[We].angularVelocity);const ze=10,$e=Math.max(-ze,Math.min(l.pilotWaveCollider.velocity.x-player.velocity.x,ze));Matter.Body.setVelocity(l,{x:player.velocity.x+$e,y:player.velocity.y})}"string"==typeof body[We].id&&sendBlockUpdate(body[We],!0)}}for(let je=0,Xe=bullet.length;je<Xe;++je)if(!bullet[je].botType&&bullet[je].speed<30&&Vector.magnitude(Vector.sub(bullet[je].position,l.fieldPosition))<l.fieldRadius&&!bullet[je].isNotHoldable){const Je=l.drain*Re*bullet[je].mass*95e-6;if(l.energy>Je){Matter.Body.setVelocity(bullet[je],l.pilotWaveCollider.velocity),Matter.Body.setAngularVelocity(bullet[je],.99*bullet[je].angularVelocity);const Ke=Vector.sub(l.fieldPosition,bullet[je].position),Ye=Vector.mult(Vector.normalise(Ke),1e-4*bullet[je].mass*Vector.magnitude(Ke));bullet[je].force.x+=Ye.x,bullet[je].force.y+=Ye.y-bullet[je].mass*simulation.g}}ctx.beginPath();const Ee=.008*l.cycle;l.fieldPhase+=.2;const He=1+.06*Math.sin(l.fieldPhase),qe=1-.06*Math.sin(l.fieldPhase);ctx.beginPath(),ctx.ellipse(l.fieldPosition.x,l.fieldPosition.y,Pe*l.fieldRadius*He,Pe*l.fieldRadius*qe,Ee,0,2*Math.PI),ctx.globalCompositeOperation="exclusion",ctx.fillStyle="#fff",ctx.fill(),ctx.globalCompositeOperation="source-over",ctx.beginPath(),ctx.ellipse(l.fieldPosition.x,l.fieldPosition.y,Pe*l.fieldRadius*He,Pe*l.fieldRadius*qe,Ee,0,2*Math.PI*l.energy/l.maxEnergy),De||l.cycle%5?ctx.strokeStyle="#000":ctx.strokeStyle="#fff",ctx.lineWidth=4,ctx.stroke()}else l.fieldCDcycle=l.cycle+60,l.fieldOn=!1,l.fieldRadius=0}else l.grabPowerUp();else l.fieldOn=!1,l.fieldRadius=0;l.inputField&&l.grabPowerUp()}else if(9==l.fieldMode){if(l.hole.isOn){l.fieldRange=.97*l.fieldRange+.03*(50+10*Math.sin(.025*simulation.cycle));const Ze=l.fieldRange+30,et=Vector.add(Vector.mult(l.hole.unit,Ze),l.hole.pos1),tt=Vector.add(Vector.mult(l.hole.unit,-Ze),l.hole.pos1),ot=Vector.add(Vector.mult(l.hole.unit,Ze),l.hole.pos2),it=Vector.add(Vector.mult(l.hole.unit,-Ze),l.hole.pos2);ctx.beginPath(),ctx.moveTo(et.x,et.y),ctx.bezierCurveTo(l.hole.pos1.x,l.hole.pos1.y,l.hole.pos2.x,l.hole.pos2.y,ot.x,ot.y),ctx.lineTo(it.x,it.y),ctx.bezierCurveTo(l.hole.pos2.x,l.hole.pos2.y,l.hole.pos1.x,l.hole.pos1.y,tt.x,tt.y),ctx.fillStyle=`rgba(255,255,255,${200/l.fieldRange/l.fieldRange})`,ctx.fill(),ctx.beginPath(),ctx.ellipse(l.hole.pos1.x,l.hole.pos1.y,l.fieldRange,Ze,l.hole.angle,0,2*Math.PI),ctx.ellipse(l.hole.pos2.x,l.hole.pos2.y,l.fieldRange,Ze,l.hole.angle,0,2*Math.PI),ctx.fillStyle=`rgba(255,255,255,${32/l.fieldRange})`,ctx.fill();for(let nt=0,ct=powerUp.length;nt<ct;++nt){if(l.tech.isEnergyNoAmmo&&"ammo"===powerUp[nt].name)continue;const ht=l.hole.pos1.x-powerUp[nt].position.x,dt=l.hole.pos1.y-powerUp[nt].position.y,yt=l.hole.pos2.x-powerUp[nt].position.x,mt=l.hole.pos2.y-powerUp[nt].position.y;let ut,pt,gt;if(ht*ht+dt*dt<yt*yt+mt*mt?(ut=ht,pt=dt):(ut=yt,pt=mt),gt=ut*ut+pt*pt,gt<6e5&&(powerUp[nt].force.x+=ut/gt*4*powerUp[nt].mass,powerUp[nt].force.y+=pt/gt*4*powerUp[nt].mass-powerUp[nt].mass*simulation.g,Matter.Body.setVelocity(powerUp[nt],{x:.05*powerUp[nt].velocity.x,y:.05*powerUp[nt].velocity.y}),gt<1e3&&!simulation.isChoosing)){simulation.ephemera.push({count:5,PposX:powerUp[nt].position.x,PposY:powerUp[nt].position.y,size:powerUp[nt].size,color:powerUp[nt].color,do(){this.count--,this.count<0&&simulation.removeEphemera(this),ctx.beginPath(),ctx.arc(this.PposX,this.PposY,Math.max(1,this.size*(this.count+1)/7),0,2*Math.PI),ctx.fillStyle=this.color,ctx.fill()}}),l.fieldRange*=.8,powerUps.onPickUp(powerUp[nt]),Matter.Composite.remove(engine.world,powerUp[nt]),powerUp.splice(nt,1);break}}const lt=500,st=100,at=.97,rt=.9;for(let ft=0,xt=body.length;ft<xt;ft++)if(!body[ft].isNotHoldable){const bt=Vector.magnitude(Vector.sub(l.hole.pos1,body[ft].position)),Mt=Vector.magnitude(Vector.sub(l.hole.pos2,body[ft].position));if(bt<Mt){if(bt<lt){const Pt=Vector.mult(Vector.normalise(Vector.sub(l.hole.pos1,body[ft].position)),1),wt=Vector.mult(body[ft].velocity,rt);if(Matter.Body.setVelocity(body[ft],Vector.add(wt,Pt)),Vector.magnitude(Vector.sub(l.hole.pos1,body[ft].position))<st&&(Matter.Body.scale(body[ft],at,at),body[ft].mass<.05)){if(Matter.Composite.remove(engine.world,body[ft]),body.splice(ft,1),l.fieldRange*=.8,(0===l.fieldMode||9===l.fieldMode)&&l.immuneCycle<l.cycle&&(l.energy+=.02*l.coupling*level.isReducedRegen),l.tech.isWormholeWorms)for(let vt=0,Bt=1+Math.floor(4*Math.random());vt<Bt;vt++)b2.worm(Vector.add(l.hole.pos2,Vector.rotate({x:.4*l.fieldRange,y:0},2*Math.PI*Math.random())),l.id),Matter.Body.setVelocity(bullet[bullet.length-1],Vector.mult(Vector.rotate(l.hole.unit,Math.PI/2),-10));break}}}else if(Mt<lt){const Vt=Vector.mult(Vector.normalise(Vector.sub(l.hole.pos2,body[ft].position)),1),kt=Vector.mult(body[ft].velocity,rt);if(Matter.Body.setVelocity(body[ft],Vector.add(kt,Vt)),Vector.magnitude(Vector.sub(l.hole.pos2,body[ft].position))<st&&(Matter.Body.scale(body[ft],at,at),body[ft].mass<.05)){if(Matter.Composite.remove(engine.world,body[ft]),body.splice(ft,1),l.fieldRange*=.8,(0===l.fieldMode||9===l.fieldMode)&&l.immuneCycle<l.cycle&&(l.energy+=.02*l.coupling*level.isReducedRegen),0!==l.fieldMode&&9!==l.fieldMode||(l.energy+=.02*l.coupling*level.isReducedRegen),l.tech.isWormholeWorms)for(let Ct=0,Dt=1+Math.floor(4*Math.random());Ct<Dt;Ct++)b2.worm(Vector.add(l.hole.pos2,Vector.rotate({x:.4*l.fieldRange,y:0},2*Math.PI*Math.random())),l.id),Matter.Body.setVelocity(bullet[bullet.length-1],Vector.mult(Vector.rotate(l.hole.unit,Math.PI/2),-10));break}}}if(l.tech.isWormHoleBullets){for(let Tt=0,St=bullet.length;Tt<St;++Tt)bullet[Tt].botType||bullet[Tt].isInHole||(Vector.magnitude(Vector.sub(l.hole.pos1,bullet[Tt].position))<l.fieldRange?(Matter.Body.setPosition(bullet[Tt],Vector.add(l.hole.pos2,Vector.sub(l.hole.pos1,bullet[Tt].position))),l.fieldRange+=5,bullet[Tt].isInHole=!0):Vector.magnitude(Vector.sub(l.hole.pos2,bullet[Tt].position))<l.fieldRange&&(Matter.Body.setPosition(bullet[Tt],Vector.add(l.hole.pos1,Vector.sub(l.hole.pos2,bullet[Tt].position))),l.fieldRange+=5,bullet[Tt].isInHole=!0));for(let Rt=0,Ut=mob.length;Rt<Ut;Rt++)if(mob[Rt].id!=l.id){if(Vector.magnitude(Vector.sub(l.hole.pos1,mob[Rt].position))<200){const Ft=Vector.mult(Vector.normalise(Vector.sub(l.hole.pos1,mob[Rt].position)),-.07);Matter.Body.setVelocity(mob[Rt],Vector.add(mob[Rt].velocity,Ft))}if(Vector.magnitude(Vector.sub(l.hole.pos2,mob[Rt].position))<200){const At=Vector.mult(Vector.normalise(Vector.sub(l.hole.pos2,mob[Rt].position)),-.07);Matter.Body.setVelocity(mob[Rt],Vector.add(mob[Rt].velocity,At))}}}}if(l.fieldCDcycle<l.cycle){const It=40,Lt=Vector.add(Vector.mult(Vector.normalise(Vector.sub(l.mouse,l.pos)),25),l.mouse),Ot=Vector.sub(l.mouse,l.pos);if(l.inputField){if(l.tech.isWormHolePause){function s(e){for(let t=0,o=e.length;t<o;++t)e[t].isSleeping||(e[t].storeVelocity=e[t].velocity,e[t].storeAngularVelocity=e[t].angularVelocity),Matter.Sleeping.set(e[t],!0)}l.immuneCycle<l.cycle+1&&(l.immuneCycle=l.cycle+1),l.isTimeDilated=!0,s(mob),s(body),s(bullet),simulation.cycle--,Matter.Body.setVelocity(l,{x:0,y:-55*l.mass*simulation.g}),l.force.x=0,l.force.y=0}l.grabPowerUp(),this.drain=l.tech.isFreeWormHole?.02:.16;const Et=Vector.perp(Vector.normalise(Ot)),Ht={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)};l.fieldRange=.97*l.fieldRange+.03*(50+10*Math.sin(.025*simulation.cycle));const qt=Vector.add(Vector.mult(Et,1.5*l.fieldRange),l.mouse),Wt=Vector.add(Vector.mult(Et,-1.5*l.fieldRange),l.mouse);ctx.beginPath(),ctx.moveTo(Ht.x,Ht.y),ctx.bezierCurveTo(Ht.x,Ht.y,l.mouse.x,l.mouse.y,qt.x,qt.y),ctx.moveTo(Ht.x,Ht.y),ctx.bezierCurveTo(Ht.x,Ht.y,l.mouse.x,l.mouse.y,Wt.x,Wt.y),l.energy>this.drain&&(l.tech.isWormholeMapIgnore||0===Matter.Query.ray(map,l.pos,Lt).length)&&0===Matter.Query.region(map,{min:{x:l.mouse.x-It,y:l.mouse.y-It},max:{x:l.mouse.x+It,y:l.mouse.y+It}}).length?(l.hole.isReady=!0,ctx.lineWidth=1,ctx.strokeStyle="#000",ctx.stroke()):(l.hole.isReady=!1,ctx.lineWidth=1,ctx.strokeStyle="#000",ctx.lineDashOffset=30*Math.random(),ctx.setLineDash([20,40]),ctx.stroke(),ctx.setLineDash([]))}else if(l.hole.isReady&&l.energy>this.drain&&(l.tech.isWormholeMapIgnore||0===Matter.Query.ray(map,l.pos,Lt).length)&&0===Matter.Query.region(map,{min:{x:l.mouse.x-It,y:l.mouse.y-It},max:{x:l.mouse.x+It,y:l.mouse.y+It}}).length){l.energy-=this.drain,l.hole.isReady=!1,l.fieldRange=0,Matter.Body.setPosition(l,l.mouse),l.buttonCD_jump=0;const Qt=Vector.mult(Vector.normalise(Ot),15);if(Matter.Body.setVelocity(l,{x:Qt.x,y:Qt.y-5}),l.immuneCycle<l.cycle+5&&(l.immuneCycle=l.cycle+5),l.hole.isOn=!0,l.hole.angle=Math.atan2(Ot.y,Ot.x),l.hole.unit=Vector.perp(Vector.normalise(Ot)),l.tech.isWormholeDamage){who=Matter.Query.ray(mob,l.pos,l.mouse,100);for(let _t=0;_t<who.length;_t++)who[_t].body.alive&&who[_t].id!=l.id&&(mobs.statusDoT(who[_t].body,1,420),mobs.statusStun(who[_t].body,360))}if(l.tech.isNewWormHoleDamage){const Gt=1.5;l.damageDone*=Gt,simulation.ephemera.push({count:300,do(){this.count--,this.count<0&&(simulation.removeEphemera(this),l.damageDone/=Gt)}})}}}}else if(10==l.fieldMode)if(l.isHolding)l.drawHold(l.holdingTarget),l.holding(),l.throwBlock();else if(l.inputField)l.holdingTarget=null,l.fieldCDcycle<l.cycle&&(l.fieldCDcycle<l.cycle+15&&(l.fieldCDcycle=l.cycle+15),l.energy>.02&&(l.energy-=.02),b2.grapple({x:l.pos.x+40*Math.cos(l.angle2),y:l.pos.y+40*Math.sin(l.angle2)},l.angle2,l.id),l.fieldCDcycle<l.cycle+20&&(l.fieldCDcycle=l.cycle+20)),l.grabPowerUp();else if(l.holdingTarget=null,l.tech.isHookDefense&&l.energy>.15&&l.fieldCDcycle<l.cycle){const Nt=300;for(let zt=0;zt<mob.length;zt++)if(!mob[zt].isBadTarget&&mob[zt].id!=l.id&&!mob[zt].isInvulnerable&&Vector.magnitude(Vector.sub(l.pos,mob[zt].position))<Nt&&0===Matter.Query.ray(map,l.pos,mob[zt].position).length){l.energy-=.1,l.fieldCDcycle<l.cycle+20&&(l.fieldCDcycle=l.cycle+20);const $t=Math.atan2(mob[zt].position.y-l.position.y,mob[zt].position.x-l.position.x);b2.harpoon(l.pos,mob[zt],$t,.75,!0,20,!1,void 0,l.id),bullet[bullet.length-1].drain=0;const jt=6;for(let Xt=jt-1;Xt>0;Xt--)b2.harpoon(l.pos,mob[zt],$t+2*Xt*Math.PI/jt,.75,!0,10,!1,void 0,l.id),bullet[bullet.length-1].drain=0;break}ctx.beginPath(),ctx.arc(l.pos.x,l.pos.y,Nt,0,2*Math.PI),ctx.strokeStyle="#000",ctx.lineWidth=.25,ctx.setLineDash([10,30]),ctx.stroke(),ctx.setLineDash([])}if(l.fieldMode!=l.oldField&&(l.oldField=l.fieldMode,l.setHoldDefaults(),5==l.fieldMode&&(l.isExtruderOn=!1,l.plasmaBall&&(l.plasmaBall.reset(),Matter.Composite.remove(engine.world,l.plasmaBall)),l.plasmaBall=Bodies.circle(l.pos.x+10*Math.cos(l.angle2),l.pos.y+10*Math.sin(l.angle2),1,{isSensor:!0,frictionAir:0,alpha:.7,isAttached:!1,isOn:!1,drain:.0018,radiusLimit:10,damage:.7,effectRadius:10,setPositionToNose(){const e={x:l.pos.x+27*Math.cos(l.angle2),y:l.pos.y+27*Math.sin(l.angle2)};l.plasmaBall.effectRadius=2*l.plasmaBall.circleRadius,Matter.Body.setPosition(this,Vector.add(e,Vector.mult(Vector.normalise(Vector.sub(e,l.pos)),this.effectRadius)))},fire(){l.energy>.06&&(l.energy-=.06),this.isAttached=!1;const e=5+Math.min(15,80/this.mass);Matter.Body.setVelocity(this,{x:.4*l.velocity.x+e*Math.cos(l.angle2),y:e*Math.sin(l.angle2)}),l.plasmaBall.setPositionToNose()},scale(e){this.circleRadius>this.radiusLimit&&Matter.Body.scale(l.plasmaBall,e,e)},reset(){const e=1/this.circleRadius;Matter.Body.scale(this,e,e),this.alpha=.7,this.isOn=!1},do(){if(this.isOn){this.effectRadius=2*l.plasmaBall.circleRadius*(.6+.4*l.tech.isPlasmaRange),Matter.Query.collides(this,map).length>0&&(this.isAttached?this.scale(Math.max(.9,.99-.1/this.circleRadius)):(l.plasmaBall.explode(),Matter.Body.setVelocity(this,{x:0,y:0}),this.reset()));const e=this.damage*(l.tech.isControlPlasma&&!this.isAttached?2:1),t=[],o=150+1600*l.tech.plasmaDischarge+1.3*this.effectRadius;for(let i=0,s=mob.length;i<s;i++)if(mob[i].alive&&(!mob[i].isBadTarget||mob[i].isMobBullet||mob[i].id!=l.id)&&!mob[i].isInvulnerable){const l=Vector.magnitude(Vector.sub(this.position,mob[i].position));l<this.effectRadius+mob[i].radius?(mob[i].damage(e),mob[i].speed>5?Matter.Body.setVelocity(mob[i],{x:.6*mob[i].velocity.x,y:.6*mob[i].velocity.y}):Matter.Body.setVelocity(mob[i],{x:.93*mob[i].velocity.x,y:.93*mob[i].velocity.y})):l<o+mob[i].radius&&0===Matter.Query.ray(map,mob[i].position,this.position).length&&t.push(mob[i])}Vector.magnitude(Vector.sub(this.position,player.position))<this.effectRadius+m.radius&&(player.speed>5?Matter.Body.setVelocity(player,{x:.6*player.velocity.x,y:.6*player.velocity.y}):Matter.Body.setVelocity(player,{x:.93*player.velocity.x,y:.93*player.velocity.y}));for(let o=0;o<t.length;o++)if(l.tech.plasmaDischarge>Math.random()){const o=t[Math.floor(Math.random()*t.length)];o.damage(4*e);const i=Vector.sub(o.position,this.position),l=Vector.normalise(i);let s=12;const a=Vector.magnitude(i)/(s+2);let r=this.position.x,n=this.position.y;ctx.beginPath(),ctx.moveTo(r,n);for(let e=0;e<s;e++)r+=a*(l.x+(Math.random()-.5)),n+=a*(l.y+(Math.random()-.5)),ctx.lineTo(r,n);ctx.lineTo(o.position.x,o.position.y),ctx.strokeStyle="#88f",ctx.lineWidth=6+3*Math.random(),ctx.stroke(),o.damageReduction&&simulation.drawList.push({x:o.position.x,y:o.position.y,radius:15,color:"rgba(150,150,255,0.4)",time:15})}const i=this.effectRadius*(.99+.02*Math.random())+3*Math.random(),s=ctx.createRadialGradient(this.position.x,this.position.y,0,this.position.x,this.position.y,i),a=this.alpha+.15*Math.random(),r=.75+.1*Math.random();if(s.addColorStop(0,`rgba(255,255,255,${a})`),s.addColorStop(r,`rgba(255,245,255,${a})`),s.addColorStop(r+.1,`rgba(255,200,255,${a})`),s.addColorStop(1,`rgba(255,75,255,${a})`),ctx.fillStyle=s,ctx.beginPath(),ctx.arc(this.position.x,this.position.y,i,0,2*Math.PI),ctx.fill(),l.tech.isControlPlasma){this.isAttached||(ctx.strokeStyle="rgb(255, 0, 212)",ctx.lineWidth=Math.max(2,.04*this.effectRadius),ctx.stroke());const e=Vector.normalise(Vector.sub(simulation.mouseInGame,this.position)),t=Vector.magnitude(this.velocity),o=Vector.mult(e,.008*Math.pow(t,1.8));Matter.Body.setVelocity(this,Vector.add(o,this.velocity)),Matter.Body.setVelocity(this,Vector.mult(Vector.normalise(this.velocity),t))}ctx.beginPath();const n=Vector.rotate({x:1,y:0},6.28*Math.random());let c=Vector.add(this.position,Vector.mult(n,.98*i));ctx.moveTo(c.x,c.y);const h=Vector.normalise(Vector.sub(this.position,c));for(let e=0,t=7;e<t;e++){const e=Vector.rotate(Vector.mult(h,17*Math.random()),2*(Math.random()-.5));c=Vector.add(c,e),ctx.lineTo(c.x,c.y)}ctx.strokeStyle="#88f",ctx.lineWidth=.5+2*Math.random(),ctx.stroke()}},explode(){simulation.ephemera.push({vertices:this.vertices,position:{x:l.plasmaBall.position.x,y:l.plasmaBall.position.y},radius:l.plasmaBall.effectRadius,alpha:1,do(){this.radius*=1.05,this.alpha-=.05,this.alpha<0&&simulation.removeEphemera(this);const e=this.radius*(.99+.02*Math.random())+3*Math.random(),t=ctx.createRadialGradient(this.position.x,this.position.y,0,this.position.x,this.position.y,e),o=this.alpha+.15*Math.random(),i=.75+.1*Math.random();t.addColorStop(0,`rgba(255,255,255,${o})`),t.addColorStop(i,`rgba(255,245,255,${o})`),t.addColorStop(i+.1,`rgba(255,200,255,${o})`),t.addColorStop(1,`rgba(255,75,255,${o})`),ctx.fillStyle=t,ctx.beginPath(),ctx.arc(this.position.x,this.position.y,e,0,2*Math.PI),ctx.fill();const s=l.plasmaBall.damage;for(let e=0,t=mob.length;e<t;e++)if(mob[e].alive&&(!mob[e].isBadTarget||mob[e].isMobBullet)&&!mob[e].isInvulnerable){Vector.magnitude(Vector.sub(this.position,mob[e].position))<this.radius+mob[e].radius&&mob[e].damage(s)}}})}}),Composite.add(engine.world,l.plasmaBall)),6==l.fieldMode&&(l.fieldFx=1.25,l.rewindDrain=1,l.grabPowerUpRange2=2e5),8==l.fieldMode?(l.drop(),l.pilotWaveCollider=Matter.Bodies.polygon(l.pos.x,l.pos.y,8,35,{friction:0,frictionAir:.12,collisionFilter:{category:cat.player,mask:cat.map},classType:"field",lastSpeed:0}),Composite.add(engine.world,l.pilotWaveCollider)):l.pilotWaveCollider&&(Matter.Composite.remove(engine.world,l.pilotWaveCollider),l.pilotWaveCollider=null),9==l.fieldMode&&(l.fieldRange=0),10==l.fieldMode&&(l.grabPowerUpRange2=3e5)),l.inputFire&&(!l.inputField||6==l.fieldMode||3==l.fieldMode||7==l.fieldMode||8==l.fieldMode||10==l.fieldMode)&&l.cycle>=l.fireCDcycle)if(l.drop(),0==l.gunType&&l.cycle>=l.nextFireCycle)if(l.tech.nailRecoil)if(l.tech.isRivets){l.nextFireCycle+1<l.cycle&&(l.startingHoldCycle=l.cycle);const Jt=Math.max(25-.14*(l.cycle-l.startingHoldCycle),5);l.nextFireCycle=l.cycle+Jt*l.fireCDscale,l.fireCDcycle=l.cycle+Math.floor(Jt*l.fireCDscale);const Kt=bullet.length,Yt=8*l.tech.bulletSize;bullet[Kt]=Bodies.rectangle(l.pos.x+35*Math.cos(l.angle2),l.pos.y+35*Math.sin(l.angle2),5*Yt,Yt,b2.fireAttributes(l.angle2,l.id)),bullet[Kt].dmg=l.tech.isNailRadiation?0:2.75,Matter.Body.setDensity(bullet[Kt],.002),Composite.add(engine.world,bullet[Kt]);const Zt=l.crouch?62:52;if(Matter.Body.setVelocity(bullet[Kt],{x:Zt*Math.cos(l.angle2),y:Zt*Math.sin(l.angle2)}),bullet[Kt].endCycle=simulation.cycle+180,bullet[Kt].beforeDmg=function(e){l.tech.isIncendiary&&(this.endCycle=0,b.explosion(this.position,100+20*(Math.random()-.5))),l.tech.isNailCrit?!e.shield&&Vector.dot(Vector.normalise(Vector.sub(e.position,this.position)),Vector.normalise(this.velocity))>.97-1/e.radius&&b.explosion(this.position,300+40*Math.random()):l.tech.isCritKill&&b.crit(e,this),l.tech.isNailRadiation&&mobs.statusDoT(e,7*(l.tech.isFastRadiation?.7:.24),l.tech.isSlowRadiation?360:l.tech.isFastRadiation?60:180),this.speed>4&&l.tech.fragments&&(b2.targetedNail(this.position,1.25*l.tech.fragments*l.tech.bulletSize,40+10*Math.random(),1200,1.4,l.id),this.endCycle=0)},bullet[Kt].minDmgSpeed=10,bullet[Kt].frictionAir=.006,bullet[Kt].rotateToVelocity=function(){if(this.speed>7){const e={x:Math.cos(this.angle),y:Math.sin(this.angle)},t=.002*this.mass;Vector.cross(Vector.normalise(this.velocity),e)<0?this.torque+=t:this.torque-=t}},l.tech.isIncendiary?bullet[Kt].do=function(){this.force.y+=8e-4*this.mass,this.rotateToVelocity(),Matter.Query.collides(this,map).length&&(this.endCycle=0,b.explosion(this.position,100+20*(Math.random()-.5)))}:bullet[Kt].do=function(){this.force.y+=8e-4*this.mass,this.rotateToVelocity()},l.muzzleFlash(),l.onGround)if(l.crouch){const eo=.03;l.force.x-=eo*Math.cos(l.angle2),l.force.y-=eo*Math.sin(l.angle2),Matter.Body.setVelocity(l,{x:.4*l.velocity.x,y:.4*l.velocity.y})}else{const to=.1;l.force.x-=to*Math.cos(l.angle2),l.force.y-=to*Math.sin(l.angle2),Matter.Body.setVelocity(l,{x:.7*l.velocity.x,y:.7*l.velocity.y})}else l.force.x-=.2*Math.cos(l.angle2)*Math.min(1,3/(.1+Math.abs(l.velocity.x))),l.force.y-=.02*Math.sin(l.angle2)}else{l.nextFireCycle+1<l.cycle&&(l.startingHoldCycle=l.cycle);const oo=Math.max(11-.06*(l.cycle-l.startingHoldCycle),.99);if(l.nextFireCycle=l.cycle+oo*l.fireCDscale,l.fireCDcycle=l.cycle+Math.floor(oo*l.fireCDscale),l.baseFire(l.angle2+(Math.random()-.5)*(l.crouch?.04:.13)/oo,45+6*Math.random()),l.onGround)if(l.crouch){const io=.006;l.force.x-=io*Math.cos(l.angle2),l.force.y-=io*Math.sin(l.angle2),Matter.Body.setVelocity(l,{x:.5*l.velocity.x,y:.5*l.velocity.y})}else{const lo=.03;l.force.x-=lo*Math.cos(l.angle2),l.force.y-=lo*Math.sin(l.angle2),Matter.Body.setVelocity(l,{x:.8*l.velocity.x,y:.8*l.velocity.y})}else l.force.x-=.06*Math.cos(l.angle2)*Math.min(1,3/(.1+Math.abs(l.velocity.x))),l.force.y-=.006*Math.sin(l.angle2)}else if(l.tech.isRivets){l.fireCDcycle=l.cycle+Math.floor((l.crouch?22:14)*l.fireCDscale);const so=bullet.length,ao=8*l.tech.bulletSize;bullet[so]=Bodies.rectangle(l.pos.x+35*Math.cos(l.angle2),l.pos.y+35*Math.sin(l.angle2),5*ao,ao,b2.fireAttributes(l.angle2,l.id)),bullet[so].dmg=l.tech.isNailRadiation?0:2.75,Matter.Body.setDensity(bullet[so],.002),Composite.add(engine.world,bullet[so]);const ro=l.crouch?60:44;if(Matter.Body.setVelocity(bullet[so],{x:ro*Math.cos(l.angle2),y:ro*Math.sin(l.angle2)}),bullet[so].endCycle=simulation.cycle+180,bullet[so].beforeDmg=function(e){l.tech.isIncendiary&&(this.endCycle=0,b.explosion(this.position,100+20*(Math.random()-.5))),l.tech.isNailCrit?!e.shield&&Vector.dot(Vector.normalise(Vector.sub(e.position,this.position)),Vector.normalise(this.velocity))>.97-1/e.radius&&b.explosion(this.position,300+40*Math.random()):l.tech.isCritKill&&b.crit(e,this),l.tech.isNailRadiation&&mobs.statusDoT(e,7*(l.tech.isFastRadiation?.7:.24),l.tech.isSlowRadiation?360:l.tech.isFastRadiation?60:180),this.speed>4&&l.tech.fragments&&(b2.targetedNail(this.position,1.25*l.tech.fragments*l.tech.bulletSize,40+10*Math.random(),1200,1.4,l.id),this.endCycle=0)},bullet[so].minDmgSpeed=10,bullet[so].frictionAir=.006,bullet[so].rotateToVelocity=function(){if(this.speed>7){const e={x:Math.cos(this.angle),y:Math.sin(this.angle)},t=.002*this.mass;Vector.cross(Vector.normalise(this.velocity),e)<0?this.torque+=t:this.torque-=t}},l.tech.isIncendiary?bullet[so].do=function(){this.force.y+=8e-4*this.mass,this.rotateToVelocity(),Matter.Query.collides(this,map).length&&(this.endCycle=0,b.explosion(this.position,300+40*Math.random()))}:bullet[so].do=function(){this.force.y+=8e-4*this.mass,this.rotateToVelocity()},l.muzzleFlash(),l.onGround)if(l.crouch){const no=.01;l.force.x-=no*Math.cos(l.angle2),l.force.y-=no*Math.sin(l.angle2)}else{const co=.02;l.force.x-=co*Math.cos(l.angle2),l.force.y-=co*Math.sin(l.angle2)}else{const ho=.01;l.force.x-=ho*Math.cos(l.angle2),l.force.y-=ho*Math.sin(l.angle2)*.5}}else if(l.tech.isNeedles)if(l.crouch){function r(){simulation.paused||l.isTimeDilated?requestAnimationFrame(r):(yo++,yo%2&&b2.needle(l.angle2,l.id),yo<7&&l.alive&&requestAnimationFrame(r))}l.fireCDcycle=l.cycle+30*l.fireCDscale,b2.needle(l.angle2,l.id);let yo=-1;requestAnimationFrame(r)}else{function r(){simulation.paused||l.isTimeDilated?requestAnimationFrame(r):(mo++,mo%2&&b2.needle(l.angle2,l.id),mo<3&&l.alive&&requestAnimationFrame(r))}l.fireCDcycle=l.cycle+22*l.fireCDscale,b2.needle(l.angle2,l.id);let mo=-1;requestAnimationFrame(r)}else if(l.tech.nailInstantFireRate)l.fireCDcycle=l.cycle+Math.floor(1*l.fireCDscale),l.baseFire(l.angle2+(Math.random()-.5)*(Math.random()-.5)*(l.crouch?1.15:2)/2);else{l.nextFireCycle+1<l.cycle&&(l.startingHoldCycle=l.cycle);const uo=Math.max(11-.06*(l.cycle-l.startingHoldCycle),1);l.nextFireCycle=l.cycle+Math.floor(uo*l.fireCDscale);let po=30+6*Math.random(),go=l.angle2+(Math.random()-.5)*(Math.random()-.5)*(l.crouch?1.15:2)/2;b2.nail({x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},{x:.8*l.velocity.x+po*Math.cos(go),y:.5*l.velocity.y+po*Math.sin(go)},1,l.id)}else if(1==l.gunType){let fo,xo;const bo=function(){l.crouch?(xo=.65,l.fireCDcycle=l.cycle+Math.floor((73+36*l.tech.shotgunExtraShots)*l.fireCDscale),l.tech.isShotgunImmune&&l.immuneCycle<l.cycle+Math.floor(60*l.fireCDscale)&&(l.immuneCycle=l.cycle+Math.floor(60*l.fireCDscale)),fo=.01):(l.fireCDcycle=l.cycle+Math.floor((56+28*l.tech.shotgunExtraShots)*l.fireCDscale),l.tech.isShotgunImmune&&l.immuneCycle<l.cycle+Math.floor(47*l.fireCDscale)&&(l.immuneCycle=l.cycle+Math.floor(47*l.fireCDscale)),xo=1.3,fo=.1),l.tech.isShotgunReversed?(l.force.x+=1.5*fo*Math.cos(l.angle2),l.force.y+=1.5*fo*Math.sin(l.angle2)-3*l.mass*simulation.g):l.tech.isShotgunRecoil?(l.fireCDcycle-=56*l.fireCDscale*.66,l.force.x-=2*fo*Math.cos(l.angle2),l.force.y-=2*fo*Math.sin(l.angle2)):(l.force.x-=fo*Math.cos(l.angle2),l.force.y-=fo*Math.sin(l.angle2)*.5)},Mo=e=>{for(let t=0;t<e;t++){const e=bullet.length,t=l.angle2+(Math.random()-.5)*xo;bullet[e]=Bodies.rectangle(l.pos.x,l.pos.y,22,22,b2.fireAttributes(t,!0,l.id)),Composite.add(engine.world,bullet[e]);const o=52+8*Math.random();Matter.Body.setVelocity(bullet[e],{x:o*Math.cos(t),y:o*Math.sin(t)}),bullet[e].endCycle=simulation.cycle+40*l.tech.bulletsLastLonger,bullet[e].minDmgSpeed=15,l.tech.isShotgunReversed&&Matter.Body.setDensity(bullet[e],.0015),bullet[e].frictionAir=.034,bullet[e].remoteBullet=!0,bullet[e].do=function(){const e=1-.034/l.tech.bulletsLastLonger;Matter.Body.scale(this,e,e)}}},Po=function(){if(l.tech.isRivets){const e=bullet.length;bullet[e]=Bodies.rectangle(l.pos.x+35*Math.cos(l.angle2),l.pos.y+35*Math.sin(l.angle2),56*l.tech.bulletSize,25*l.tech.bulletSize,b.fireAttributes(l.angle2)),bullet[e].remoteBullet=!0,Matter.Body.setDensity(bullet[e],.005*(l.tech.isShotgunReversed?1.5:1)),Composite.add(engine.world,bullet[e]);const t=l.crouch?50:43;Matter.Body.setVelocity(bullet[e],{x:t*Math.cos(l.angle2),y:t*Math.sin(l.angle2)}),l.tech.isIncendiary?(bullet[e].endCycle=simulation.cycle+60,bullet[e].onEnd=function(){b.explosion(this.position,400+60*(Math.random()-.5))},bullet[e].beforeDmg=function(){this.endCycle=0}):bullet[e].endCycle=simulation.cycle+180,bullet[e].minDmgSpeed=7,bullet[e].frictionAir=.004,bullet[e].turnMag=.04*Math.pow(l.tech.bulletSize,3.75),bullet[e].do=function(){if(this.force.y+=.002*this.mass,this.speed>6){const e={x:Math.cos(this.angle),y:Math.sin(this.angle)};Vector.cross(Vector.normalise(this.velocity),e)<0?this.torque+=this.turnMag:this.torque-=this.turnMag}l.tech.isIncendiary&&Matter.Query.collides(this,map).length&&(this.endCycle=0)},bullet[e].beforeDmg=function(e){this.speed>4&&(l.tech.fragments&&(b2.targetedNail(this.position,6*l.tech.fragments*l.tech.bulletSize,40+10*Math.random(),1200,1.4,l.id),this.endCycle=0),l.tech.isIncendiary&&(this.endCycle=0),l.tech.isCritKill&&b.crit(e,this))},Mo(12)}else if(l.tech.isIncendiary){xo*=.15;const e=Math.floor(l.crouch?8:5),t=9,o=(l.crouch?.3:.8)/t;let i=l.angle2-o*t/2;for(let s=0;s<t;s++){i+=o;const t=bullet.length;bullet[t]=Bodies.rectangle(l.pos.x+50*Math.cos(l.angle2),l.pos.y+50*Math.sin(l.angle2),17,4,b2.fireAttributes(i,!0,l.id)),bullet[t].remoteBullet=!0;const s=e+4*Math.random();bullet[t].endCycle=2*s*l.tech.bulletsLastLonger+simulation.cycle;const a=25*s/e,r=i+(Math.random()-.5)*xo;Matter.Body.setVelocity(bullet[t],{x:a*Math.cos(r),y:a*Math.sin(r)}),bullet[t].onEnd=function(){b.explosion(this.position,180*(l.tech.isShotgunReversed?1.4:1)+30*(Math.random()-.5))},bullet[t].beforeDmg=function(){this.endCycle=0},bullet[t].do=function(){Matter.Query.collides(this,map).length&&(this.endCycle=0)},Composite.add(engine.world,bullet[t])}}else if(l.tech.isNailShot){xo*=.65;const e=2*(l.tech.isShotgunReversed?1.5:1);if(l.crouch)for(let t=0;t<17;t++){speed=38+15*Math.random();const t=l.angle2+(Math.random()-.5)*xo,o={x:l.pos.x+35*Math.cos(l.angle2)+15*(Math.random()-.5),y:l.pos.y+35*Math.sin(l.angle2)+15*(Math.random()-.5)};b2.nail(o,{x:speed*Math.cos(t),y:speed*Math.sin(t)},e,l.id)}else for(let t=0;t<17;t++){speed=38+15*Math.random();const t=l.angle2+(Math.random()-.5)*xo,o={x:l.pos.x+35*Math.cos(l.angle2)+15*(Math.random()-.5),y:l.pos.y+35*Math.sin(l.angle2)+15*(Math.random()-.5)};b2.nail(o,{x:speed*Math.cos(t),y:speed*Math.sin(t)},e,l.id)}}else if(l.tech.isSporeFlea){const e={x:l.pos.x+35*Math.cos(l.angle2),y:l.pos.y+35*Math.sin(l.angle2)},t=2*(l.tech.isShotgunReversed?1.5:1);for(let o=0;o<t;o++){const t=l.angle2+.2*(Math.random()-.5),o=l.crouch?35*(1+.05*Math.random()):30*(1+.15*Math.random());b.flea(e,{x:o*Math.cos(t),y:o*Math.sin(t)}),bullet[bullet.length-1].setDamage()}Mo(10)}else if(l.tech.isSporeWorm){const e={x:l.pos.x+35*Math.cos(l.angle2),y:l.pos.y+35*Math.sin(l.angle2)},t=l.crouch?.02:.07,o=3*(l.tech.isShotgunReversed?1.5:1);let i=l.angle2-(o-1)*t*.5;for(let s=0;s<o;s++){b.worm(e);const o=(30+10*l.crouch)*(1+.2*Math.random());Matter.Body.setVelocity(bullet[bullet.length-1],{x:.5*l.velocity.x+o*Math.cos(i),y:.5*l.velocity.y+o*Math.sin(i)}),i+=t}Mo(7)}else if(l.tech.isIceShot){const e=l.crouch?.7:1.2;for(let t=0,o=10*(l.tech.isShotgunReversed?1.5:1);t<o;t++)b2.iceIX(23+10*Math.random(),l.angle2+e*(Math.random()-.5),{x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},l.id);Mo(10)}else if(l.tech.isFoamShot){const e=l.crouch?.15:.4,t={x:l.pos.x+25*Math.cos(l.angle2),y:l.pos.y+25*Math.sin(l.angle2)},o=16*(l.tech.isShotgunReversed?1.5:1);for(let i=0;i<o;i++){const o=13+4*Math.random(),i=l.angle2+e*(Math.random()-.5);b.foam(t,{x:.6*l.velocity.x+o*Math.cos(i),y:.5*l.velocity.y+o*Math.sin(i)},8+7*Math.random())}}else if(l.tech.isNeedles){const e=9*(l.tech.isShotgunReversed?1.5:1),t=l.crouch?.03:.05;let o=l.angle2-(e-1)*t*.5;for(let i=0;i<e;i++)b2.needle(o,l.id),o+=t}else Mo(16)};if(bo(),l.muzzleFlash(35),Po(),l.tech.shotgunExtraShots){const wo=Math.ceil(7*l.fireCDscale);let vo=l.tech.shotgunExtraShots*wo;function r(){vo--,vo%wo||(bo(),l.muzzleFlash(35),Po()),vo>0&&requestAnimationFrame(r)}requestAnimationFrame(r)}}else if(2==l.gunType)if(l.tech.oneSuperBall){l.fireCDcycle=l.cycle+Math.floor((l.crouch?27:19)*l.fireCDscale);const Bo=l.crouch?43:36;b2.superBall({x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},{x:Bo*Math.cos(l.angle2),y:Bo*Math.sin(l.angle2)},21*l.tech.bulletSize,l.id)}else if(l.tech.superBallDelay){l.fireCDcycle=l.cycle+Math.floor((l.crouch?23:15)*l.fireCDscale);const Vo=5+Math.floor(l.tech.extraSuperBalls*Math.random()),ko=l.crouch?43:36,Co=Math.floor((l.crouch?18:12)*l.fireCDscale);function r(){Do++,b2.superBall({x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},{x:ko*Math.cos(l.angle2),y:ko*Math.sin(l.angle2)},11*l.tech.bulletSize,l.id),Do<Vo&&l.alive&&requestAnimationFrame(r),l.fireCDcycle=l.cycle+Co}l.fireCDcycle=l.cycle+Co;let Do=0;requestAnimationFrame(r)}else{l.fireCDcycle=l.cycle+Math.floor((l.crouch?23:15)*l.fireCDscale);const To=l.crouch?.08:.13,So=3+Math.floor(l.tech.extraSuperBalls*Math.random()),Ro=l.crouch?43:36;if(l.tech.isBulletTeleport)for(let Uo=0;Uo<So;Uo++)b2.superBall({x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},{x:Ro*Math.cos(l.angle2),y:Ro*Math.sin(l.angle2)},11*l.tech.bulletSize,l.id);else{let Fo=l.angle2-To*(So-1)/2;for(let Ao=0;Ao<So;Ao++)b2.superBall({x:l.pos.x+30*Math.cos(Fo),y:l.pos.y+30*Math.sin(Fo)},{x:Ro*Math.cos(Fo),y:Ro*Math.sin(Fo)},11*l.tech.bulletSize,l.id),Fo+=To}}else if(3==l.gunType)if(l.tech.isLongitudinal)if(l.tech.is360Longitudinal)l.fireCDcycle=l.cycle+Math.floor((l.crouch?4:8)*l.fireCDscale),l.waves.push({position:{x:l.pos.x,y:l.pos.y},radius:25,resonanceCount:0});else{l.fireCDcycle=l.cycle+Math.floor((l.crouch?4:8)*l.fireCDscale);const Io=(l.crouch?.0785:.275)*(l.tech.isBulletTeleport?Math.random()-.5+.66:1),Lo=l.angle2+.3*l.tech.isBulletTeleport*(Math.random()-.5);l.waves.push({position:{x:l.pos.x+25*Math.cos(l.angle2),y:l.pos.y+25*Math.sin(l.angle2)},angle:Lo-Io,unit1:{x:Math.cos(Lo-Io),y:Math.sin(Lo-Io)},unit2:{x:Math.cos(Lo+Io),y:Math.sin(Lo+Io)},arc:2*Io,radius:25,resonanceCount:0})}else{totalCycles=Math.floor(122.5*l.tech.waveReflections*l.tech.bulletsLastLonger/Math.sqrt(.5*l.tech.waveReflections));const Oo=bullet.length;bullet[Oo]=Bodies.polygon(l.pos.x+25*Math.cos(l.angle2),l.pos.y+25*Math.sin(l.angle2),5,4,{angle:l.angle2,cycle:-.5,endCycle:simulation.cycle+totalCycles,inertia:1/0,frictionAir:0,slow:0,amplitude:(l.crouch?6:12)*(this.wavePacketCycle%2?-1:1)*Math.sin(.088*this.wavePacketCycle)*Math.sin(.04*this.wavePacketCycle),minDmgSpeed:0,dmg:l.tech.waveBeamDamage*l.tech.wavePacketDamage*(l.tech.isBulletTeleport?1.43:1)*(l.tech.isInfiniteWaveAmmo?.75:1),dmgCoolDown:0,classType:"bullet",collisionFilter:{category:0,mask:0},beforeDmg(){},onEnd(){},do(){},query(){let e=1;if(Matter.Query.point(map,this.position).length)e=Eo;else{let t=Matter.Query.point(body,this.position);t.length&&(e=Ho,Matter.Body.setPosition(this,Vector.add(this.position,t[0].velocity)))}if(e!==this.slow&&(this.slow=e,Matter.Body.setVelocity(this,Vector.mult(Vector.normalise(this.velocity),l.tech.waveBeamSpeed*e))),this.dmgCoolDown<1){q=Matter.Query.point(mob,this.position);for(let e=0;e<q.length;e++){this.dmgCoolDown=5+Math.floor(8*Math.random()*l.fireCDscale);let t=this.dmg;q[e].id!=l.id&&(q[e].damage(t),q[e].alive&&(q[e].foundPlayer(),Matter.Body.setVelocity(q[e],Vector.mult(q[e].velocity,.9))),q[e].damageReduction&&simulation.drawList.push({x:this.position.x,y:this.position.y,radius:40*Math.log(t+1.1)*q[e].damageReduction+3,color:"rgba(0,0,0,0.4)",time:simulation.drawTime}))}}else this.dmgCoolDown--},wiggle(){this.cycle++;const e=Vector.mult(qo,this.amplitude*Math.cos(this.cycle*l.tech.waveFrequency));Matter.Body.setPosition(this,Vector.add(this.position,e))}}),l.tech.isBulletTeleport&&(bullet[Oo].wiggle=function(){this.cycle++;const e=Vector.mult(qo,this.amplitude*Math.cos(this.cycle*l.tech.waveFrequency));if(Math.random()<.005)if(Math.random()<.33){const t=500*Math.random();Matter.Body.setPosition(this,Vector.add({x:t*(Math.random()-.5),y:t*(Math.random()-.5)},Vector.add(this.position,e)))}else{const t=Vector.mult(this.velocity,50*(Math.random()-.5));Matter.Body.setPosition(this,Vector.add(t,Vector.add(this.position,e)))}else Matter.Body.setPosition(this,Vector.add(this.position,e))});let Eo=.13,Ho=.3;l.tech.isPhaseVelocity&&(Eo=3.5,Ho=2,bullet[Oo].dmg*=1.5),l.tech.waveReflections?(bullet[Oo].reflectCycle=totalCycles/l.tech.waveReflections,bullet[Oo].do=function(){this.query(),this.cycle>this.reflectCycle&&(this.reflectCycle+=totalCycles/l.tech.waveReflections,Matter.Body.setVelocity(this,Vector.mult(this.velocity,-1))),this.wiggle()}):bullet[Oo].do=function(){this.query(),this.wiggle()},bullet[Oo].remoteBullet=!0,Composite.add(engine.world,bullet[Oo]),Matter.Body.setVelocity(bullet[Oo],{x:l.tech.waveBeamSpeed*Math.cos(l.angle2),y:l.tech.waveBeamSpeed*Math.sin(l.angle2)});const qo=Vector.normalise(Vector.perp(bullet[Oo].velocity));l.wavePacketCycle++}else if(4==l.gunType){const Wo=Math.pow(.86,l.tech.missileCount);l.fireCDcycle=l.cycle+l.tech.missileFireCD*l.fireCDscale/Wo;const Qo={x:Math.cos(l.angle2),y:Math.sin(l.angle2)};if(l.tech.missileCount>1){const _o=Vector.mult(Vector.perp(Qo),.2*Wo/Math.sqrt(l.tech.missileCount)),Go=Math.sqrt(Wo),No=4;let zo=0;const $o=()=>{l.crouch?(b2.missile({x:l.pos.x+30*Qo.x,y:l.pos.y+30*Qo.y},l.angle2,20,Go,l.id),bullet[bullet.length-1].force.x+=.5*_o.x*(Math.random()-.5),bullet[bullet.length-1].force.y+=.004+.5*_o.y*(Math.random()-.5)):(b2.missile({x:l.pos.x+30*Qo.x,y:l.pos.y+30*Qo.y},l.angle2,-15,Go,l.id),bullet[bullet.length-1].force.x+=_o.x*(Math.random()-.5),bullet[bullet.length-1].force.y+=.005+_o.y*(Math.random()-.5))},jo=()=>{simulation.paused&&l.alive?requestAnimationFrame(jo):(zo++,zo%No||$o(),zo<l.tech.missileCount*No&&l.alive&&requestAnimationFrame(jo))};requestAnimationFrame(jo)}else l.crouch?b2.missile({x:l.pos.x+40*Qo.x,y:l.pos.y+40*Qo.y},l.angle2,25,1,l.id):(b2.missile({x:l.pos.x+40*Qo.x,y:l.pos.y+40*Qo.y},l.angle2,-12,1,l.id),bullet[bullet.length-1].force.y+=.04*(Math.random()-.2))}else if(5==l.gunType){const Xo=Math.pow(.93,l.tech.missileCount);l.fireCDcycle=l.cycle+Math.floor((l.crouch?35:27)*l.fireCDscale/Xo);const Jo={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},Ko=l.crouch?.12:.2;let Yo=l.angle2-Ko*(l.tech.missileCount-1)/2;for(let Zo=0;Zo<l.tech.missileCount;Zo++)b2.grenade(Jo,Yo,Xo,l.id),Yo+=Ko}else if(6==l.gunType){const ei=bullet.length,ti=l.angle2;bullet[ei]=Bodies.polygon(l.pos.x+30*Math.cos(l.angle2),l.pos.y+30*Math.sin(l.angle2),20,4.5,b2.fireAttributes(ti,!1,l.id)),b2.fireProps(l.crouch?40:20,l.crouch?24:18,ti,ei,l.id),Matter.Body.setDensity(bullet[ei],1e-6),bullet[ei].collisionFilter.group=-l.id,bullet[ei].remoteBullet=!0,bullet[ei].endCycle=simulation.cycle+480+Math.max(0,120-2*bullet.length),bullet[ei].frictionAir=0,bullet[ei].friction=.5,bullet[ei].radius=4.5,bullet[ei].maxRadius=30,bullet[ei].restitution=.3,bullet[ei].minDmgSpeed=0,bullet[ei].totalSpores=8+2*l.tech.isSporeFreeze+5*l.tech.isSporeColony,bullet[ei].stuck=function(){},bullet[ei].beforeDmg=function(){},Matter.Body.setMass(bullet[ei],bullet[ei].mass/8.9269321149),bullet[ei].do=function(){function e(e){e.collisionFilter.mask=0,Matter.Body.setVelocity(e,{x:0,y:0}),e.do=e.grow}const t=mob.filter((e=>e.id!==o)),i=Matter.Query.collides(this,t);if(i.length)i[0].bodyA.id!=l.id&&(e(this),this.stuckTo=i[0].bodyA,l.tech.isZombieMobs&&(this.stuckTo.isSoonZombie=!0),this.stuckTo.isVerticesChange?this.stuckToRelativePosition={x:0,y:0}:this.stuckToRelativePosition=Vector.rotate(Vector.sub(this.position,this.stuckTo.position),-this.stuckTo.angle),this.stuck=function(){if(this.stuckTo&&this.stuckTo.alive){const e=Vector.rotate(this.stuckToRelativePosition,this.stuckTo.angle);Matter.Body.setPosition(this,Vector.add(Vector.add(e,this.stuckTo.velocity),this.stuckTo.position)),Matter.Body.setVelocity(this,this.stuckTo.velocity)}else this.collisionFilter.mask=cat.map,this.stuck=function(){this.force.y+=6e-4*this.mass}});else{const t=Matter.Query.collides(this,body);t.length?(t[0].bodyA.isNonStick?this.do=this.grow:(e(this),this.stuckTo=t[0].bodyA,this.stuckToRelativePosition=Vector.rotate(Vector.sub(this.position,this.stuckTo.position),-this.stuckTo.angle)),this.stuck=function(){if(this.stuckTo){const e=Vector.rotate(this.stuckToRelativePosition,this.stuckTo.angle);Matter.Body.setPosition(this,Vector.add(Vector.add(e,this.stuckTo.velocity),this.stuckTo.position))}else this.force.y+=7e-4*this.mass}):Matter.Query.collides(this,map).length?e(this):this.force.y+=7e-4*this.mass;const o=Matter.Query.collides(this,[player]).filter((e=>e.bodyA!==playerHead&&e.bodyB!==playerHead));o.length?(o[0].bodyA.isNonStick?this.do=this.grow:(e(this),o[0].bodyA.alive=!0,this.stuckTo=o[0].bodyA,this.stuckToRelativePosition=Vector.rotate(Vector.sub(this.position,this.stuckTo.position),-this.stuckTo.angle)),this.stuck=function(){if(this.stuckTo){const e=Vector.rotate(this.stuckToRelativePosition,this.stuckTo.angle);Matter.Body.setPosition(this,Vector.add(Vector.add(e,this.stuckTo.velocity),this.stuckTo.position))}else this.force.y+=7e-4*this.mass}):Matter.Query.collides(this,map).length?e(this):(this.force.y+=7e-5*this.mass,l.mouse.x)}ctx.fillStyle="rgba(0,200,125,0.16)",ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.maxRadius,0,2*Math.PI),ctx.fill()},bullet[ei].grow=function(){this.stuck();let e=1.01;if(!l.tech.isSporeGrowth||simulation.cycle%40)this.stuckTo&&this.stuckTo.alive&&(e=1.03),Matter.Body.scale(this,e,e),this.radius*=e,this.radius>this.maxRadius&&(this.endCycle=0);else{if(l.tech.isSporeFlea){if(!(simulation.cycle%80)){const e=10+5*Math.random(),t=2*Math.PI*Math.random();b.flea(this.position,{x:e*Math.cos(t),y:e*Math.sin(t)})}}else l.tech.isSporeWorm?simulation.cycle%80||b.worm(this.position):b2.spore(this.position,null,l.id);e=.96,this.stuckTo&&this.stuckTo.alive&&(e=.9),Matter.Body.scale(this,e,e),this.radius*=e}ctx.fillStyle="rgba(0,200,125,0.16)",ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.maxRadius,0,2*Math.PI),ctx.fill()},bullet[ei].onEnd=function(){let e=0;const t=[()=>{b2.spore(this.position,null,l.id)},()=>{e++,b2.worm(this.position,l.tech.isSporeFreeze,l.id)},()=>{e++;const t=10+5*Math.random(),o=2*Math.PI*Math.random();b2.flea(this.position,{x:t*Math.cos(o),y:t*Math.sin(o)},6+3*Math.random()+10*l.tech.wormSize*Math.random(),l.id)},()=>{b2.drone(this.position,1,l.id)},()=>{b2.iceIX(1,2*Math.random()*Math.PI,this.position,l.id)},()=>{e++,b2.missile(this.position,-Math.PI/2+.5*(Math.random()-.5),0,1,l.id)},()=>{b2.targetedNail(this.position,1,39+6*Math.random(),1200,1.4,l.id)},()=>{const e=2*Math.PI*Math.random();b2.superBall(this.position,{x:36*Math.cos(e),y:36*Math.sin(e)},11*l.tech.bulletSize,l.id)}];for(len=this.totalSpores;e<len;e++)l.tech.isSporeColony&&Math.random()<.33?t[Math.floor(Math.random()*t.length)]():l.tech.isSporeFlea?t[2]():l.tech.isSporeWorm?t[1]():t[0]();l.tech.isStun&&b.AoEStunEffect(this.position,600,270+120*Math.random())}}else if(7==l.gunType)l.tech.isDroneRadioactive?l.crouch?(b2.droneRadioactive({x:l.pos.x+30*Math.cos(l.angle2)+10*(Math.random()-.5),y:l.pos.y+30*Math.sin(l.angle2)+10*(Math.random()-.5)},45,l.id),l.fireCDcycle=l.cycle+Math.floor(45*l.fireCDscale)):(b2.droneRadioactive({x:l.pos.x+30*Math.cos(l.angle2)+10*(Math.random()-.5),y:l.pos.y+30*Math.sin(l.angle2)+10*(Math.random()-.5)},10,l.id),l.fireCDcycle=l.cycle+Math.floor(25*l.fireCDscale)):l.crouch?(b2.drone({x:l.pos.x+30*Math.cos(l.angle2)+5*(Math.random()-.5),y:l.pos.y+30*Math.sin(l.angle2)+5*(Math.random()-.5)},50,l.id),l.fireCDcycle=l.cycle+Math.floor(4*l.fireCDscale)):(b2.drone({x:l.pos.x+30*Math.cos(l.angle2)+10*(Math.random()-.5),y:l.pos.y+30*Math.sin(l.angle2)+10*(Math.random()-.5)},15,l.id),l.fireCDcycle=l.cycle+Math.floor(3*l.fireCDscale));else if(8==l.gunType)if(l.tech.isFoamPressure){const oi=l.crouch?.04*(Math.random()-.5)+.09*Math.sin(.12*l.cycle):.23*(Math.random()-.5)+.15*Math.sin(.12*l.cycle),ii=5+8*Math.random()+12*(l.tech.isAmmoFoamSize&&this.ammo<300),li=(l.crouch?1.2:1)*Math.max(2,14-.25*ii),si=l.angle2+.15*(Math.random()-.5),ai={x:.7*l.velocity.x+li*Math.cos(si),y:.5*l.velocity.y+li*Math.sin(si)},ri={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)};b2.foam(ri,Vector.rotate(ai,oi),ii,l.id),l.applyKnock(ai),l.fireCDcycle=l.cycle+Math.floor(1.5*l.fireCDscale),this.charge+=1+l.tech.isCapacitor}else{const ni=l.crouch?.04*(Math.random()-.5)+.09*Math.sin(.12*l.cycle):.23*(Math.random()-.5)+.15*Math.sin(.12*l.cycle),ci=5+8*Math.random()+12*(l.tech.isAmmoFoamSize&&this.ammo<300),hi=(l.crouch?1.2:1)*Math.max(2,14-.25*ci),di=l.angle2+.15*(Math.random()-.5),yi={x:.7*l.velocity.x+hi*Math.cos(di),y:.5*l.velocity.y+hi*Math.sin(di)},mi={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)};b2.foam(mi,Vector.rotate(yi,ni),ci,l.id),l.applyKnock(yi),l.fireCDcycle=l.cycle+Math.floor(1.5*l.fireCDscale)}else if(9==l.gunType)if(l.tech.isRailGun)l.fireCDcycle=l.cycle+10,this.charge+=1e-5;else{const ui={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},pi={distance:1e4,target:null},gi=l.tech.isLargeHarpoon?1+.1*Math.sqrt(this.ammo):1,fi=6.5*(l.tech.isFilament?1+.013*Math.min(110,this.ammo):1)*Math.sqrt(gi);if(l.tech.extraHarpoons&&!l.crouch){const bi=.2;let Mi=l.angle2-bi*l.tech.extraHarpoons/2;const Pi={x:Math.cos(Mi),y:Math.sin(Mi)},wi=450*(l.tech.isFilament?1+.012*Math.min(110,this.ammo):1);let vi=0;const Bi=[...mob];m.alive&&Bi.push(player);for(let Vi=0,ki=Bi.length;Vi<ki;++Vi){const Ci=Bi[Vi];if((Ci==player?m.alive:Ci.alive)&&!Ci.isBadTarget&&!Ci.shield&&0===Matter.Query.ray(map,l.pos,Ci.position).length&&!Ci.isInvulnerable&&Ci.id!==l.id){const Di=Vector.dot(Pi,Vector.normalise(Vector.sub(Ci.position,l.pos)));if(Vector.magnitude(Vector.sub(ui,Ci.position))<wi&&Di>.9&&this.ammo>0&&(b2.harpoon(ui,Ci,Mi,gi,!0,fi,!0,.1,l.id),Mi+=bi,vi++,vi>l.tech.extraHarpoons))break}}if(vi<l.tech.extraHarpoons+1){const Ti=l.tech.extraHarpoons-vi,Si=1;let Ri=l.angle2-bi*l.tech.extraHarpoons/2,Ui=-1,Fi=()=>{simulation.paused?requestAnimationFrame(Fi):(Ui++,!(Ui%Si)&&this.ammo>0&&(b2.harpoon({x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},null,Ri,gi,!0,fi,!0,.1,l.id),Ri+=bi),Ui<Ti*Si&&l.alive&&requestAnimationFrame(Fi))};requestAnimationFrame(Fi)}}else{const Ai={x:Math.cos(l.angle2),y:Math.sin(l.angle2)},Ii=[...mob];m.alive&&Ii.push(player);for(let Li=0,Oi=Ii.length;Li<Oi;++Li){const Ei=Ii[Li];if((Ei==player?m.alive:Ei.alive)&&!Ei.isBadTarget&&0===Matter.Query.ray(map,l.pos,Ei.position).length&&!Ei.isInvulnerable){const Hi=Vector.dot(Ai,Vector.normalise(Vector.sub(Ei.position,l.pos))),qi=Vector.magnitude(Vector.sub(ui,Ei.position));qi<pi.distance&&Hi>.98-Math.min(14e-5*qi,.3)&&(pi.distance=qi,pi.target=Ei)}}l.crouch&&l.onGround?b2.harpoon(ui,null,l.angle2,gi,!0,1.6*fi,!(l.crouch&&l.tech.crouchAmmoCount&&(l.tech.crouchAmmoCount-1)%2),.1,l.id):b2.harpoon(ui,pi.target,l.angle2,gi,!0,fi,!0,.1,l.id)}l.fireCDcycle=l.cycle+5+35*l.fireCDscale*(l.tech.isBreakHarpoon?.5:1)+60*(l.energy<.05)+l.tech.extraHarpoons;const xi=Vector.mult(Vector.normalise(Vector.sub(ui,l.pos)),l.crouch?.015:.035);l.force.x-=xi.x,l.force.y-=xi.y}else if(10==l.gunType)if(l.crouch)if(l.tech.isLaserMine){const Wi=30,Qi={x:Wi*Math.cos(l.angle2),y:Wi*Math.sin(l.angle2)};b2.laserMine(l.pos,Qi,l.id),l.fireCDcycle=l.cycle+Math.floor(65*l.fireCDscale)}else{const _i={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)};let Gi=36;Matter.Query.point(map,_i).length>0&&(Gi=-2),b2.mine(_i,{x:Gi*Math.cos(l.angle2),y:Gi*Math.sin(l.angle2)},0,l.id),l.fireCDcycle=l.cycle+Math.floor(55*l.fireCDscale)}else{const Ni={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)};let zi=23;Matter.Query.point(map,Ni).length>0&&(zi=-2),b2.mine(Ni,{x:zi*Math.cos(l.angle2),y:zi*Math.sin(l.angle2)},0,l.id),l.fireCDcycle=l.cycle+Math.floor(35*l.fireCDscale)}else if(11==l.gunType)if(l.tech.isLaserLens?l.lens():l.stuckOn(),l.tech.isPulseLaser){const $i=Math.min(.9*l.maxEnergy,.01*(l.tech.isCapacitor?10:1)/l.fireCDscale);l.energy>$i&&l.charge<50*l.maxEnergy&&(l.energy-=$i,l.charge+=100*$i)}else if(l.tech.beamCollimator){const ji=l.tech.laserDrain/l.fireCDscale;if(l.energy<ji)l.fireCDcycle=l.cycle+100;else{l.fireCDcycle=l.cycle,l.energy-=ji;const Xi=.037,Ji=l.tech.beamSplitter+1,Ki=2*Math.PI/Ji;for(let Yi=0;Yi<Ji;Yi++){!(Math.sin(l.cycle*Xi+Ki*Yi+Math.PI/2)>0)&&l.cycle%3||(ctx.globalAlpha=.35);const Zi=l.angle2+(l.crouch?.4:1)*Math.sin(l.cycle*Xi+Ki*Yi),el={x:l.pos.x+30*Math.cos(Zi),y:l.pos.y+30*Math.sin(Zi)};b2.laser(el,{x:el.x+5e3*Math.cos(l.angle2),y:el.y+5e3*Math.sin(l.angle2)},l.tech.laserDamage/l.fireCDscale*l.lensDamage,l.tech.laserReflections,!1,1,l.id),ctx.globalAlpha=1}}}else if(l.tech.beamSplitter){const tl=l.tech.laserDrain/l.fireCDscale;if(l.energy<tl)l.fireCDcycle=l.cycle+100;else{l.fireCDcycle=l.cycle,l.energy-=tl;let ol=l.tech.laserDamage/l.fireCDscale*this.lensDamage;const il={x:l.pos.x+20*Math.cos(l.angle2),y:l.pos.y+20*Math.sin(l.angle2)},ll=l.crouch?.15:.35,sl=l.angle2-l.tech.beamSplitter*ll/2;for(let al=0;al<1+l.tech.beamSplitter;al++)b2.laser(il,{x:il.x+3e3*Math.cos(sl+al*ll),y:il.y+3e3*Math.sin(sl+al*ll)},ol,l.tech.laserReflections,!1,1,l.id)}}else if(l.tech.historyLaser)if(drain=l.tech.laserDrain/l.fireCDscale,l.energy<drain)l.fireCDcycle=l.cycle+100;else{l.fireCDcycle=l.cycle,l.energy-=drain;const rl=l.tech.laserDamage/l.fireCDscale*l.lensDamage,nl=Math.ceil(23-l.tech.historyLaser);ctx.beginPath(),b2.laser({x:l.pos.x+20*Math.cos(l.angle2),y:l.pos.y+20*Math.sin(l.angle2)},{x:l.pos.x+3e3*Math.cos(l.angle2),y:l.pos.y+3e3*Math.sin(l.angle2)},rl,l.tech.laserReflections,!1,1,l.id);for(let cl=1,hl=1+l.tech.historyLaser;cl<hl;cl++){const dl=l.history[(simulation.cycle-cl*nl)%600],yl=dl.yOff-24.2859+2*cl;b2.laser({x:dl.position.x+20*Math.cos(dl.angle),y:dl.position.y+20*Math.sin(dl.angle)-yl},{x:dl.position.x+3e3*Math.cos(dl.angle),y:dl.position.y+3e3*Math.sin(dl.angle)-yl},.7*rl,l.tech.laserReflections,!0,1,l.id)}ctx.strokeStyle=l.tech.laserColor,ctx.lineWidth=1,ctx.stroke(),l.tech.isLaserLens&&1!==l.lensDamage&&(ctx.strokeStyle=l.tech.laserColor,ctx.lineWidth=10+2*l.lensDamageOn,ctx.globalAlpha=.2,ctx.stroke(),ctx.globalAlpha=1)}else if(l.tech.isWideLaser){const ml=l.tech.laserDrain/l.fireCDscale;if(l.energy<ml)l.fireCDcycle=l.cycle+100;else{l.fireCDcycle=l.cycle,l.energy-=ml;const ul={x:5e3*Math.cos(l.angle2),y:5e3*Math.sin(l.angle2)},pl={x:7.5*Math.cos(l.angle2+Math.PI/2),y:7.5*Math.sin(l.angle2+Math.PI/2)},gl={x:7.5*Math.cos(l.angle2-Math.PI/2),y:7.5*Math.sin(l.angle2-Math.PI/2)},fl=.7*l.tech.laserDamage/l.fireCDscale*l.lensDamage,xl={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},bl={x:l.pos.x+15*Math.cos(l.angle2),y:l.pos.y+15*Math.sin(l.angle2)};ctx.strokeStyle=l.tech.laserColor,ctx.lineWidth=8,ctx.globalAlpha=.5,ctx.beginPath(),0===Matter.Query.ray(map,bl,xl).length&&0===Matter.Query.ray(body,bl,xl).length&&b2.laser(bl,{x:bl.x+ul.x,y:bl.y+ul.y},fl,0,!0,.3,l.id);for(let Ml=1;Ml<l.tech.wideLaser;Ml++){let Pl=Vector.add(xl,{x:Ml*pl.x,y:Ml*pl.y});0===Matter.Query.ray(map,bl,Pl).length&&0===Matter.Query.ray(body,bl,Pl).length&&(ctx.moveTo(bl.x,bl.y),ctx.lineTo(Pl.x,Pl.y),b2.laser(Pl,{x:Pl.x+ul.x,y:Pl.y+ul.y},fl,0,!0,.3,l.id)),Pl=Vector.add(xl,{x:Ml*gl.x,y:Ml*gl.y}),0===Matter.Query.ray(map,bl,Pl).length&&0===Matter.Query.ray(body,bl,Pl).length&&(ctx.moveTo(bl.x,bl.y),ctx.lineTo(Pl.x,Pl.y),b2.laser(Pl,{x:Pl.x+ul.x,y:Pl.y+ul.y},fl,0,!0,.3,l.id))}ctx.stroke(),l.tech.isLaserLens&&1!==l.lensDamage&&(ctx.lineWidth=20+3*l.lensDamageOn,ctx.globalAlpha=.3,ctx.stroke()),ctx.globalAlpha=1}}else{const wl=l.tech.laserDrain/l.fireCDscale;if(l.energy<wl)l.fireCDcycle=l.cycle+100;else{l.fireCDcycle=l.cycle,l.energy-=wl;const vl={x:l.pos.x+20*Math.cos(l.angle2),y:l.pos.y+20*Math.sin(l.angle2)};b2.laser(vl,{x:vl.x+5e3*Math.cos(l.angle2),y:vl.y+5e3*Math.sin(l.angle2)},l.tech.laserDamage/l.fireCDscale*l.lensDamage,l.tech.laserReflections,!1,1,l.id)}}if(l.tech.isLongitudinal)if(l.tech.is360Longitudinal){if(!l.isTimeDilated){ctx.strokeStyle="rgba(0,0,0,0.6)",ctx.lineWidth=2*l.tech.wavePacketDamage,ctx.beginPath();const Bl=700*Math.sqrt(l.tech.bulletsLastLonger),Vl=2.3*l.tech.wavePacketDamage*l.tech.waveBeamDamage*(l.tech.isBulletTeleport?1.43:1)*(l.tech.isInfiniteWaveAmmo?.75:1);for(let kl=l.waves.length-1;kl>-1;kl--){ctx.moveTo(l.waves[kl].position.x+l.waves[kl].radius,l.waves[kl].position.y),ctx.arc(l.waves[kl].position.x,l.waves[kl].position.y,l.waves[kl].radius,0,2*Math.PI);const Cl=Vector.magnitude(Vector.sub(l.waves[kl].position,player.position));Cl+30>l.waves[kl].radius&&Cl-30<l.waves[kl].radius&&(player.force.x+=.01*(Math.random()-.5)*player.mass,player.force.y+=.01*(Math.random()-.5)*player.mass,Matter.Body.setVelocity(player,{x:.95*player.velocity.x,y:.95*player.velocity.y}),m.takeDamage(Vl/Math.sqrt(30)/100),l.tech.isPhononWave&&l.phononWaveCD<l.cycle&&(l.phononWaveCD=l.cycle+8*(1+l.waves[kl].resonanceCount),l.waves.push({position:player.position,radius:25,resonanceCount:l.waves[kl].resonanceCount+1})));for(let Dl=0,Tl=mob.length;Dl<Tl;Dl++)if(!mob[Dl].isShielded&&!mob[Dl].remotePlayer){const Sl=Vector.magnitude(Vector.sub(l.waves[kl].position,mob[Dl].position)),Rl=mob[Dl].radius+30;if(Sl+Rl>l.waves[kl].radius&&Sl-Rl<l.waves[kl].radius){mob[Dl].isBadTarget||(mob[Dl].force.x+=.01*(Math.random()-.5)*mob[Dl].mass,mob[Dl].force.y+=.01*(Math.random()-.5)*mob[Dl].mass),Matter.Body.setVelocity(mob[Dl],{x:.95*mob[Dl].velocity.x,y:.95*mob[Dl].velocity.y});let Ul=mob[Dl].vertices;const Fl=50+.15*mob[Dl].radius;ctx.moveTo(Ul[0].x+Fl*(Math.random()-.5),Ul[0].y+Fl*(Math.random()-.5));for(let Al=1;Al<Ul.length;Al++)ctx.lineTo(Ul[Al].x+Fl*(Math.random()-.5),Ul[Al].y+Fl*(Math.random()-.5));ctx.lineTo(Ul[0].x+Fl*(Math.random()-.5),Ul[0].y+Fl*(Math.random()-.5)),mob[Dl].damage(Vl/Math.sqrt(mob[Dl].radius)),l.tech.isPhononWave&&l.phononWaveCD<l.cycle&&(l.phononWaveCD=l.cycle+8*(1+l.waves[kl].resonanceCount),l.waves.push({position:mob[Dl].position,radius:25,resonanceCount:l.waves[kl].resonanceCount+1}))}}for(let Il=0,Ll=Math.min(30,body.length);Il<Ll;Il++){const Ol=Vector.magnitude(Vector.sub(l.waves[kl].position,body[Il].position)),El=20;if(Ol+El>l.waves[kl].radius&&Ol-El<l.waves[kl].radius){const Hl=body[Il];Hl.force.x+=.01*(Math.random()-.5)*Hl.mass,Hl.force.y+=(.01*(Math.random()-.5)-.25*simulation.g)*Hl.mass;let ql=Hl.vertices;const Wl=25;ctx.moveTo(ql[0].x+Wl*(Math.random()-.5),ql[0].y+Wl*(Math.random()-.5));for(let Ql=1;Ql<ql.length;Ql++)ctx.lineTo(ql[Ql].x+Wl*(Math.random()-.5),ql[Ql].y+Wl*(Math.random()-.5));ctx.lineTo(ql[0].x+Wl*(Math.random()-.5),ql[0].y+Wl*(Math.random()-.5)),l.tech.isPhononBlock&&!Hl.isNotHoldable&&Hl.speed<5&&Hl.angularSpeed<.1&&(Math.random()<.5&&b.targetedBlock(Hl,50-Math.min(25,3*Hl.mass)),Hl.torque+=.001*Hl.inertia*(Math.random()-.5))}}l.waves[kl].radius+=.9*l.tech.waveBeamSpeed,l.waves[kl].radius>Bl-30*l.waves[kl].resonanceCount&&l.waves.splice(kl,1)}ctx.stroke()}}else if(!l.isTimeDilated){ctx.strokeStyle="rgba(0,0,0,0.6)",ctx.lineWidth=2*l.tech.wavePacketDamage,ctx.beginPath();const _l=1100*l.tech.bulletsLastLonger,Gl=2.3*l.tech.wavePacketDamage*l.tech.waveBeamDamage*(l.tech.isBulletTeleport?1.4:1)*(l.tech.isInfiniteWaveAmmo?.75:1);for(let Nl=l.waves.length-1;Nl>-1;Nl--){const zl=Vector.add(l.waves[Nl].position,Vector.mult(l.waves[Nl].unit1,l.waves[Nl].radius)),$l=Vector.add(l.waves[Nl].position,Vector.mult(l.waves[Nl].unit2,l.waves[Nl].radius));ctx.moveTo(zl.x,zl.y),ctx.arc(l.waves[Nl].position.x,l.waves[Nl].position.y,l.waves[Nl].radius,l.waves[Nl].angle,l.waves[Nl].angle+l.waves[Nl].arc);let jl=Matter.Query.ray(player,zl,$l,50);for(let Jl=0;Jl<jl.length;Jl++){who.force.x+=.01*(Math.random()-.5)*who.mass,who.force.y+=.01*(Math.random()-.5)*who.mass,Matter.Body.setVelocity(who,{x:.95*who.velocity.x,y:.95*who.velocity.y});m.takeDamage(Gl/Math.sqrt(30)/100)}let Xl=Matter.Query.ray(mob,zl,$l,50);for(let Kl=0;Kl<Xl.length;Kl++){const Yl=Xl[Kl].body;if(!Yl.isShielded&&!Yl.remotePlayer){Yl.force.x+=.01*(Math.random()-.5)*Yl.mass,Yl.force.y+=.01*(Math.random()-.5)*Yl.mass,Matter.Body.setVelocity(Yl,{x:.95*Yl.velocity.x,y:.95*Yl.velocity.y});let Zl=Yl.vertices;const es=50+.15*Yl.radius;ctx.moveTo(Zl[0].x+es*(Math.random()-.5),Zl[0].y+es*(Math.random()-.5));for(let ts=1;ts<Zl.length;ts++)ctx.lineTo(Zl[ts].x+es*(Math.random()-.5),Zl[ts].y+es*(Math.random()-.5));if(ctx.lineTo(Zl[0].x+es*(Math.random()-.5),Zl[0].y+es*(Math.random()-.5)),"function"==typeof Yl.damage&&Yl.damage(Gl/Math.sqrt(Yl.radius)),l.tech.isPhononWave&&l.phononWaveCD<l.cycle){l.phononWaveCD=l.cycle+8*(1+l.waves[Nl].resonanceCount);const os=.27;let is,ls,ss=_l-30*l.waves[Nl].resonanceCount;for(let as=0,rs=mob.length;as<rs;as++)Yl===mob[as]||mob[as].isBadTarget||mob[as].isInvulnerable||(ls=Vector.magnitude(Vector.sub(Yl.position,mob[as].position)),ls<ss&&(is=mob[as],ss=ls));if(is){const ns=Vector.normalise(Vector.sub(is.position,Yl.position));var n=Math.atan2(ns.y,ns.x)}else n=2*Math.PI*Math.random();l.waves.push({position:Yl.position,angle:n-os,unit1:{x:Math.cos(n-os),y:Math.sin(n-os)},unit2:{x:Math.cos(n+os),y:Math.sin(n+os)},arc:2*os,radius:25,resonanceCount:l.waves[Nl].resonanceCount+1})}}}Xl=Matter.Query.ray(body,zl,$l,50);for(let cs=0,hs=Math.min(30,Xl.length);cs<hs;cs++){const ds=Xl[cs].body;ds.force.x+=.01*(Math.random()-.5)*ds.mass,ds.force.y+=(.01*(Math.random()-.5)-.25*simulation.g)*ds.mass;let ys=ds.vertices;const ms=25;ctx.moveTo(ys[0].x+ms*(Math.random()-.5),ys[0].y+ms*(Math.random()-.5));for(let us=1;us<ys.length;us++)ctx.lineTo(ys[us].x+ms*(Math.random()-.5),ys[us].y+ms*(Math.random()-.5));ctx.lineTo(ys[0].x+ms*(Math.random()-.5),ys[0].y+ms*(Math.random()-.5)),l.tech.isPhononBlock&&!ds.isNotHoldable&&ds.speed<5&&ds.angularSpeed<.1&&(Math.random()<.5&&b.targetedBlock(ds,50-Math.min(25,3*ds.mass)),ds.torque+=.001*ds.inertia*(Math.random()-.5))}l.waves[Nl].radius+=1.8*l.tech.waveBeamSpeed,l.waves[Nl].radius>_l-30*l.waves[Nl].resonanceCount&&l.waves.splice(Nl,1)}ctx.stroke()}if(this.charge>0&&l.tech.isFoamPressure){ctx.fillStyle="rgba(0,50,50,0.3)",ctx.beginPath();const ps=5*Math.sqrt(this.charge),gs=11+ps;if(ctx.arc(l.pos.x+gs*Math.cos(l.angle2),l.pos.y+gs*Math.sin(l.angle2),ps,0,2*Math.PI),ctx.fill(),this.isDischarge&&l.cycle%2&&!l.isTimeDilated){const fs=(l.crouch?.04:.5)*(Math.random()-.5),xs=5+8*Math.random()+12*(l.tech.isAmmoFoamSize&&this.ammo<300),bs=10*(l.crouch?1.2:1)-.4*xs+Math.min(5,Math.sqrt(this.charge)),Ms=l.angle2+.15*(Math.random()-.5),Ps={x:.7*l.velocity.x+bs*Math.cos(Ms),y:.5*l.velocity.y+bs*Math.sin(Ms)},ws={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)};b2.foam(ws,Vector.rotate(Ps,fs),xs,o),l.applyKnock(Ps),this.charge-=.75,l.fireCDcycle=l.cycle+2}else input.fire||(this.isDischarge=!0)}else l.tech.isFoamPressure&&(this.isDischarge&&(l.fireCDcycle=l.cycle+Math.floor(25*l.fireCDscale)),this.isDischarge=!1);if(l.charge>0&&l.tech.isPulseLaser&&(ctx.beginPath(),ctx.arc(l.pos.x,l.pos.y,4.2*Math.sqrt(l.charge),0,2*Math.PI),ctx.fillStyle=`rgba(255,0,0,${.09*Math.sqrt(l.charge)})`,ctx.fill(),!l.inputFire)){if(l.charge>5)if(l.fireCDcycle=l.cycle+Math.floor(35*l.fireCDscale),l.tech.beamSplitter){const vs=l.crouch?.15:.35,Bs=l.angle2-l.tech.beamSplitter*vs/2;for(let Vs=0;Vs<1+l.tech.beamSplitter;Vs++)b2.pulse(l.charge,Bs+Vs*vs,l.pos,l.id)}else b2.pulse(1.8*l.charge*l.lensDamage,l.angle2,l.pos,l.id);l.charge=0}if(this.charge>0&&l.tech.isRailGun){const ks=l.tech.isRailEnergy?0:.002;if(l.energy<ks)return l.fireCDcycle=l.cycle+120,this.endCycle=0,void(this.charge=0);if(!l.inputFire&&this.charge>.6){const Cs={x:l.pos.x+30*Math.cos(l.angle2),y:l.pos.y+30*Math.sin(l.angle2)},Ds={distance:1e4,target:null},Ts=600+500*this.charge;for(let Fs=0,As=mob.length;Fs<As;++Fs)if(!mob[Fs].isUnblockable&&mob[Fs].id!=l.id){const Is=Vector.sub(mob[Fs].position,l.pos),Ls=Vector.magnitude(Is);if(Ls<Ts+mob[Fs].radius){const Os=100+Math.min(Ts-Ls+mob[Fs].radius,1500),Es=Vector.mult(Vector.normalise(Is),.0015*Math.sqrt(Os)*mob[Fs].mass);mob[Fs].force.x+=Es.x,mob[Fs].force.y+=Es.y;let Hs=(mob[Fs].isDropPowerUp?350:1100)*l.tech.harpoonDensity*this.charge;simulation.drawList.push({x:mob[Fs].position.x,y:mob[Fs].position.y,radius:40*Math.log(Hs+1.1)*mob[Fs].damageReduction+3,color:"rgba(100, 0, 200, 0.4)",time:15}),mob[Fs].damage(Hs)}}for(let qs=0,Ws=body.length;qs<Ws;++qs){const Qs=Vector.sub(body[qs].position,l.pos),_s=Vector.magnitude(Qs);if(_s<Ts){const Gs=Math.min(Ts-_s,500),Ns=Vector.mult(Vector.normalise(Qs),.003*Math.sqrt(Gs)*body[qs].mass);body[qs].force.x+=Ns.x,body[qs].force.y+=Ns.y-body[qs].mass*simulation.g*1.5}}for(let zs=0,$s=powerUp.length;zs<$s;++zs){const js=Vector.sub(powerUp[zs].position,l.pos),Xs=Vector.magnitude(js);if(Xs<Ts){const Js=Math.min(Ts-Xs,500),Ks=Vector.mult(Vector.normalise(js),.002*Math.sqrt(Js)*powerUp[zs].mass);powerUp[zs].force.x+=Ks.x,powerUp[zs].force.y+=Ks.y-powerUp[zs].mass*simulation.g*1.5}}for(let Ys=0,Zs=10+25*this.charge;Ys<Zs;Ys++){const ea=Vector.rotate({x:1,y:0},6.28*Math.random()),ta=Vector.add(l.pos,Vector.mult(ea,Ts*(.6+.3*Math.random())));simulation.drawList.push({x:ta.x,y:ta.y,radius:5+12*Math.random(),color:"rgba(100, 0, 200, 0.1)",time:Math.floor(5+35*Math.random())})}const Ss=Vector.mult(Vector.normalise(Vector.sub(Cs,l.pos)),l.crouch?.03:.06);l.force.x-=Ss.x,l.force.y-=Ss.y;const Rs=l.tech.isLargeHarpoon?1+.07*Math.sqrt(this.ammo):1,Us=.15*this.charge;if(l.tech.extraHarpoons){let oa=0;const ia=.06+.05*!l.crouch;let la=l.angle2-ia*l.tech.extraHarpoons/2;const sa={x:Math.cos(la),y:Math.sin(la)};for(let aa=0,ra=mob.length;aa<ra;++aa)if(mob[aa].alive&&!mob[aa].isBadTarget&&!mob[aa].shield&&0===Matter.Query.ray(map,l.pos,mob[aa].position).length&&!mob[aa].isInvulnerable){const na=Vector.dot(sa,Vector.normalise(Vector.sub(mob[aa].position,l.pos))),ca=Vector.magnitude(Vector.sub(Cs,mob[aa].position));if(na>.95-Math.min(15e-5*ca,.3)&&(b2.harpoon(Cs,l.crouch?null:mob[aa],la,Rs,!1,35,!1,Us,l.id),la+=ia,oa++,oa>l.tech.extraHarpoons))break}if(oa<l.tech.extraHarpoons+1){const ha=l.tech.extraHarpoons+1-oa;for(let da=0;da<ha;da++)b2.harpoon(Cs,null,la,Rs,!1,35,!1,Us,l.id),la+=ia}simulation.updateGunHUD()}else{const ya={x:Math.cos(l.angle2),y:Math.sin(l.angle2)};for(let ma=0,ua=mob.length;ma<ua;++ma)if(mob[ma].alive&&!mob[ma].isBadTarget&&0===Matter.Query.ray(map,l.pos,mob[ma].position).length&&!mob[ma].isInvulnerable){const pa=Vector.dot(ya,Vector.normalise(Vector.sub(mob[ma].position,l.pos))),ga=Vector.magnitude(Vector.sub(Cs,mob[ma].position));ga<Ds.distance&&pa>.98-Math.min(14e-5*ga,.3)&&(Ds.distance=ga,Ds.target=mob[ma])}b2.harpoon(Cs,Ds.target,l.angle2,Rs,!1,35,!1,Us,l.id)}this.charge=0}else{l.tech.isFireMoveLock&&(Matter.Body.setVelocity(player,{x:0,y:-55*l.mass*simulation.g}),l.force.x=0,l.force.y=0),l.fireCDcycle=l.cycle+10;const fa=Math.sqrt(l.fireCDscale)*l.tech.railChargeRate*(l.tech.isCapacitor?.6:1)*(l.crouch?.8:1);let xa=Math.min(.998,.94+.05*fa);this.charge=1-xa+this.charge*xa,l.energy>ks&&(l.energy-=ks);const ba=l.pos.x,Ma=l.pos.y,Pa={x:Math.cos(l.angle2),y:Math.sin(l.angle2)},wa=Vector.perp(Pa);function c(e,t){ctx.moveTo(ba,Ma),ctx.bezierCurveTo(ba+Pa.x*e,Ma+Pa.y*e,ba+Pa.x*e+wa.x*t,Ma+Pa.y*e+wa.y*t,ba+wa.x*t,Ma+wa.y*t),ctx.bezierCurveTo(ba-Pa.x*e+wa.x*t,Ma-Pa.y*e+wa.y*t,ba-Pa.x*e,Ma-Pa.y*e,ba,Ma)}ctx.fillStyle="rgba(50,0,100,0.05)";const va=8*this.charge*l.tech.railChargeRate**3,Ba=6*this.charge*l.tech.railChargeRate**3;for(let Va=3;Va<7;Va++){const ka=va*Va*Va*(.93+.07*Math.random()),Ca=Ba*Va*Va*(.93+.07*Math.random());ctx.beginPath(),c(ka,Ca),c(ka,-Ca),ctx.fill()}}}l.grenadeDo.do(),l.setGrenadeMode()},l.remotePlayer=!0,l.onDamage=function(e){sendDamage(e,l.id)},l.onDeath=function(){delete remotePlayers[l.id]},l.leaveBody=!1,l}level.nextLevel=function(){oldNext(),Math.seed=Math.initialSeed,agreedSeed=Math.seed},setTimeout(validateUsernames,10),pm(b.guns[3],"doLongitudinal",[[/\bwho\.locatePlayer\(\);?/,"if(typeof who.locatePlayer == 'function') who.locatePlayer();"],[/\bwho\.damage\([^)]*\);?/,"if(typeof who.damage == 'function') who.damage(damage / Math.sqrt(who.radius)"]]),window.b2=wrapAllBulletFunctions(b),window.b2.fireAttributes=(e,t=!0,o)=>t?{angle:e,friction:.5,frictionAir:0,dmg:0,classType:"bullet",collisionFilter:{group:-o,category:cat.body,mask:cat.map|cat.body|cat.mob|cat.mobBullet|cat.mobShield|cat.player},minDmgSpeed:10,beforeDmg(){},onEnd(){}}:{inertia:1/0,angle:e,friction:.5,frictionAir:0,dmg:0,classType:"bullet",collisionFilter:{group:-o,category:cat.body,mask:cat.map|cat.body|cat.mob|cat.mobBullet|cat.mobShield|cat.player},minDmgSpeed:10,beforeDmg(){},onEnd(){}},window.b2.fireProps=(e,t,o,i,l)=>{remotePlayers[l].fireCDcycle=remotePlayers[l].cycle+Math.floor(e*remotePlayers[l].fireCDscale),Matter.Body.setVelocity(bullet[i],{x:.5*remotePlayers[l].velocity.x+t*Math.cos(o),y:.5*remotePlayers[l].velocity.y+t*Math.sin(o)}),Composite.add(engine.world,bullet[i])},window.b2.needle=(e,t)=>{const o=bullet.length;bullet[o]=Bodies.rectangle(remotePlayers[t].pos.x+40*Math.cos(remotePlayers[t].angle2),remotePlayers[t].pos.y+40*Math.sin(remotePlayers[t].angle2),75*remotePlayers[t].tech.bulletSize,.75*remotePlayers[t].tech.bulletSize,b2.fireAttributes(e,!0,t)),Matter.Body.setDensity(bullet[o],1e-5),bullet[o].immuneList=[],bullet[o].dmg=6,remotePlayers[t].tech.needleTunnel?(bullet[o].dmg*=1.2,bullet[o].endCycle=simulation.cycle+300,bullet[o].collisionFilter.mask=remotePlayers[t].tech.isShieldPierce?0:cat.mobShield,bullet[o].collisionFilter.group=-t,bullet[o].isInMap=!1,bullet[o].do=function(){const e=Matter.Query.collides(this,mob);if(e.length&&this.speed>20){for(let o=0,i=e.length;o<i;o++)if(who=e[o].bodyA,who&&who.mob){let e=!1;for(let t=0;t<this.immuneList.length;t++)if(this.immuneList[t]===who.id){e=!0;break}if(!e){remotePlayers[t].tech.isNailCrit?!who.shield&&Vector.dot(Vector.normalise(Vector.sub(who.position,this.position)),Vector.normalise(this.velocity))>.97-1/who.radius&&b.explosion(this.position,220+50*Math.random()):remotePlayers[t].tech.isCritKill&&b.crit(who,this),this.immuneList.push(who.id);let e=this.dmg*remotePlayers[t].tech.bulletSize;remotePlayers[t].tech.isNailRadiation&&(mobs.statusDoT(who,(remotePlayers[t].tech.isFastRadiation?6:2)*remotePlayers[t].tech.bulletSize,remotePlayers[t].tech.isSlowRadiation?360:remotePlayers[t].tech.isFastRadiation?60:180),e*=.25),remotePlayers[t].tech.isCrit&&who.isStunned&&(e*=4),who.damage(e,remotePlayers[t].tech.isShieldPierce),who.alive&&who.foundPlayer(),who.damageReduction&&simulation.drawList.push({x:this.position.x,y:this.position.y,radius:40*Math.log(e+1.1)*who.damageReduction+3,color:simulation.playerDmgColor,time:simulation.drawTime})}}}else Matter.Query.collides(this,map).length?(this.isInMap||(this.isInMap=!0,Matter.Body.setVelocity(this,Vector.rotate(this.velocity,.25*(Math.random()-.5))),Matter.Body.setAngle(this,Math.atan2(this.velocity.y,this.velocity.x))),Matter.Body.setPosition(this,Vector.add(this.position,Vector.mult(this.velocity,-.98)))):Matter.Query.collides(this,body).length?(Matter.Body.setAngularVelocity(this,0),Matter.Body.setPosition(this,Vector.add(this.position,Vector.mult(this.velocity,-.94)))):this.speed<30&&(this.force.y+=.001*this.mass)}):(bullet[o].endCycle=simulation.cycle+100,bullet[o].collisionFilter.mask=remotePlayers[t].tech.isShieldPierce?cat.body:cat.body|cat.mobShield,bullet[o].do=function(){const e=Matter.Query.collides(this,mob);if(e.length&&this.speed>20){for(let o=0,i=e.length;o<i;o++)if(who=e[o].bodyA,who&&who.mob){let e=!1;for(let t=0;t<this.immuneList.length;t++)if(this.immuneList[t]===who.id){e=!0;break}if(!e){remotePlayers[t].tech.isNailCrit?!who.shield&&Vector.dot(Vector.normalise(Vector.sub(who.position,this.position)),Vector.normalise(this.velocity))>.97-1/who.radius&&b.explosion(this.position,220+50*Math.random()):remotePlayers[t].tech.isCritKill&&b.crit(who,this),this.immuneList.push(who.id);let e=this.dmg*remotePlayers[t].tech.bulletSize;remotePlayers[t].tech.isNailRadiation&&(mobs.statusDoT(who,(remotePlayers[t].tech.isFastRadiation?6:2)*remotePlayers[t].tech.bulletSize,remotePlayers[t].tech.isSlowRadiation?360:remotePlayers[t].tech.isFastRadiation?60:180),e*=.25),remotePlayers[t].tech.isCrit&&who.isStunned&&(e*=4),who.damage(e,remotePlayers[t].tech.isShieldPierce),who.alive&&who.foundPlayer(),who.damageReduction&&simulation.drawList.push({x:this.position.x,y:this.position.y,radius:40*Math.log(e+1.1)*who.damageReduction+3,color:simulation.playerDmgColor,time:simulation.drawTime})}}}else Matter.Query.collides(this,map).length?(this.collisionFilter.mask=0,Matter.Body.setAngularVelocity(this,0),Matter.Body.setVelocity(this,{x:0,y:0}),this.do=function(){Matter.Query.collides(this,map).length||(this.force.y+=.001*this.mass)},remotePlayers[t].tech.isNeedleIce&&(b2.iceIX(5+5*Math.random(),2*Math.PI*Math.random(),this.position,t),.5<Math.random()&&b2.iceIX(5+5*Math.random(),2*Math.PI*Math.random(),this.position,t))):this.speed<30&&(this.force.y+=.001*this.mass)});Matter.Body.setVelocity(bullet[o],{x:.5*remotePlayers[t].velocity.x+90*Math.cos(e),y:.5*remotePlayers[t].velocity.y+90*Math.sin(e)}),bullet[o].remoteBullet=!0,Composite.add(engine.world,bullet[o])},window.b2.missile=(e,t,o,i=1,l)=>{remotePlayers[l].tech.isMissileBig&&(i*=1.5,remotePlayers[l].tech.isMissileBiggest&&(i*=1.5));const s=bullet.length;bullet[s]=Bodies.rectangle(e.x,e.y,30*i,4*i,{angle:t,friction:.5,frictionAir:.045,dmg:0,classType:"bullet",endCycle:simulation.cycle+Math.floor((230+40*Math.random())*remotePlayers[l].tech.bulletsLastLonger+120*remotePlayers[l].tech.isMissileBiggest+60*remotePlayers[l].tech.isMissileBig),collisionFilter:{category:cat.bullet,mask:cat.map|cat.body|cat.mob|cat.mobBullet|cat.mobShield},minDmgSpeed:10,lookFrequency:Math.floor(10+3*Math.random()),explodeRad:180+60*Math.random(),density:.02,beforeDmg(){Matter.Body.setDensity(this,1e-4),this.tryToLockOn(),this.endCycle=0},onEnd(){remotePlayers[l]&&(b.explosion(this.position,this.explodeRad*i),remotePlayers[l].tech.fragments&&b.targetedNail(this.position,remotePlayers[l].tech.fragments*Math.floor(2+1.5*Math.random())),remotePlayers[l].tech.isMissileFast&&simulation.ephemera.push({count:21,where:this.position,size:this.explodeRad*i,do(){remotePlayers[l].isTimeDilated||(this.count--,this.count<0&&(simulation.removeEphemera(this),b.explosion(this.where,this.size*(remotePlayers[l].tech.isMissile2ndExplode?1.7:.8))))}}))},lockedOn:null,tryToLockOn(){let e=1/0;const t=Vector.add(this.position,Vector.mult(this.velocity,30));this.lockedOn=null;let o=[...mob,player];for(let s=0,a=o.length;s<a;++s)if(o[s]==player&&(o[s].alive=m.alive),o[s].alive&&!o[s].isBadTarget&&0===Matter.Query.ray(map,this.position,o[s].position).length&&!o[s].isInvulnerable&&o[s].id!=l){const l=Vector.magnitude(Vector.sub(t,o[s].position));l<e&&(e=l,this.lockedOn=o[s]),Vector.magnitude(Vector.sub(this.position,o[s].position)<this.explodeRad)&&(this.endCycle=0,"function"==typeof o[s].lockedOn.damage?o[s].lockedOn.damage(2*i):"function"==typeof o[s].lockedOn.takeDamage&&o[s].lockedOn.takeDamage(2*i))}this.lockedOn&&Vector.magnitude(Vector.sub(this.position,this.lockedOn.position))<this.explodeRad&&(this.endCycle=0,"function"==typeof this.lockedOn.damage&&this.lockedOn.damage(4*i))},do(){if(remotePlayers[l]){if(remotePlayers[l].cycle%this.lookFrequency||this.tryToLockOn(),remotePlayers[l].tech.isTargeting&&remotePlayers[l].inputDown){const e={x:Math.cos(this.angle),y:Math.sin(this.angle)},t=Vector.normalise(Vector.sub(this.position,simulation.mouseInGame)),o=Vector.dot(t,e),i=Math.min(.08,1*(1+o));Vector.cross(t,e)>0?Matter.Body.rotate(this,i):Matter.Body.rotate(this,-i),this.frictionAir=Math.min(.1,Math.max(.04,1+o)),ctx.strokeStyle="#000",ctx.lineWidth=1,ctx.strokeRect(simulation.mouseInGame.x-40,simulation.mouseInGame.y-40,80,80)}else if(this.lockedOn){const e={x:Math.cos(this.angle),y:Math.sin(this.angle)},t=Vector.normalise(Vector.sub(this.position,this.lockedOn.position)),o=Vector.dot(t,e),i=Math.min(.08,1*(1+o));Vector.cross(t,e)>0?Matter.Body.rotate(this,i):Matter.Body.rotate(this,-i),this.frictionAir=Math.min(.1,Math.max(.04,1+o))}const e=this.angle;this.force.x+=a*Math.cos(e),this.force.y+=a*Math.sin(e),ctx.beginPath(),ctx.arc(this.position.x-Math.cos(this.angle)*(25*i-3)+4*(Math.random()-.5),this.position.y-Math.sin(this.angle)*(25*i-3)+4*(Math.random()-.5),11*i,0,2*Math.PI),ctx.fillStyle="rgba(255,155,0,0.5)",ctx.fill()}}});const a=.0066*bullet[s].mass*(remotePlayers[l].tech.isMissileBig?remotePlayers[l].tech.isMissileBiggest?.3:.7:1);Matter.Body.setVelocity(bullet[s],{x:.5*remotePlayers[l].velocity.x+o*Math.cos(t),y:.5*remotePlayers[l].velocity.y+o*Math.sin(t)}),Composite.add(engine.world,bullet[s]),bullet[s].remoteBullet=!0,bullet[s].collisionFilter.group=-l,remotePlayers[l].tech.isMissileFast&&simulation.ephemera.push({name:Math.random(),count:40,who:bullet[s],do(){if(!remotePlayers[l].isTimeDilated){const e=.07*this.who.mass;if(this.count--,this.count<0||!this.who)simulation.removeEphemera(this);else if(this.count<3)if(2===this.count&&this.who.tryToLockOn(),this.who.lockedOn){const t=Vector.normalise(Vector.sub(this.who.lockedOn.position,this.who.position)),o=Vector.mult(t,e);this.who.force.x+=o.x,this.who.force.y+=o.y}else{const t={x:Math.cos(this.who.angle),y:Math.sin(this.who.angle)},o=Vector.mult(t,e);this.who.force.x+=o.x,this.who.force.y+=o.y}else Matter.Body.setVelocity(this.who,{x:.7*this.who.velocity.x,y:.7*this.who.velocity.y})}}})},window.b2.spore=(e,t=null,o)=>{const i=bullet.length;if(i<500&&remotePlayers[o]){if(bullet[i]=Bodies.polygon(e.x,e.y,4,4,{inertia:1/0,isFreeze:remotePlayers[o].tech.isSporeFreeze,restitution:.5,angle:2*Math.random()*Math.PI,friction:0,frictionAir:.025,thrust:(remotePlayers[o].tech.isSporeFollow?.0011:5e-4)*(1+.3*(Math.random()-.5)),dmg:remotePlayers[o].tech.isMutualism?20:7,lookFrequency:100+Math.floor(117*Math.random()),classType:"bullet",isSpore:!0,collisionFilter:{group:-o,category:cat.body,mask:cat.map|cat.mob|cat.mobBullet|cat.mobShield|cat.player},endCycle:simulation.cycle+Math.floor((540+Math.floor(420*Math.random()))*remotePlayers[o].tech.bulletsLastLonger),minDmgSpeed:0,playerOffPosition:{x:100*(Math.random()-.5),y:100*(Math.random()-.5)},beforeDmg(e){e.isInvulnerable||(this.endCycle=0,this.isFreeze&&mobs.statusSlow(e,90))},onEnd(){this.lockedOn==player&&simulation.drawList.push({x:this.position.x,y:this.position.y,radius:25*Math.random()+10,color:simulation.playerDmgColor,time:simulation.drawTime})},do(){if(this.lockedOn&&this.lockedOn.alive)this.force=Vector.mult(Vector.normalise(Vector.sub(this.lockedOn.position,this.position)),this.mass*this.thrust),Matter.Query.collides(this,[player]).length&&this.lockedOn==player&&(this.endCycle=0);else{if(!(simulation.cycle%this.lookFrequency)){this.closestTarget=null,this.lockedOn=null;let e=1/0,t=[...mob,player];for(let i=0,l=t.length;i<l;++i)if(!t[i].isBadTarget&&0===Matter.Query.ray(map,this.position,t[i].position).length&&!t[i].isInvulnerable&&t[i].id!=o){const o=Vector.sub(this.position,t[i].position),l=Vector.magnitude(o)*(Math.random()+.5);if(l<e&&(this.closestTarget=t[i].position,e=l,this.lockedOn=t[i],t[i]==player&&(t[i].alive=m.alive),.3>Math.random()))break}}if(remotePlayers[o].tech.isSporeFollow&&null===this.lockedOn){const e=this.position.x-remotePlayers[o].pos.x,t=this.position.y-remotePlayers[o].pos.y;e*e+t*t>1e4&&(this.force=Vector.mult(Vector.normalise(Vector.sub(remotePlayers[o].pos,Vector.add(this.playerOffPosition,this.position))),this.mass*this.thrust))}else this.force.y+=1e-4*this.mass}}}),t)Matter.Body.setVelocity(bullet[i],t);else{const e=4+8*Math.random(),t=2*Math.PI*Math.random();Matter.Body.setVelocity(bullet[i],{x:e*Math.cos(t),y:e*Math.sin(t)})}Composite.add(engine.world,bullet[i]),bullet[i].remoteBullet=!0}},window.b2.pulse=(e,t,o,i)=>{let l,s=5.5*e;const a=[{x:o.x+20*Math.cos(t),y:o.y+20*Math.sin(t)},{x:o.x+5e3*Math.cos(t),y:o.y+5e3*Math.sin(t)}];l={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const r=mob.filter((e=>e.collisionFilter.group!==-i));if(l.who||(l=vertexCollision(a[0],a[1],[r,map,body,[player]]),l.dist2!=1/0&&(a[a.length-1]={x:l.x,y:l.y})),l.who){b.explosion(a[1],s);const e=1.2*s;b.explosion({x:a[1].x+e*(Math.random()-.5),y:a[1].y+e*(Math.random()-.5)},s),b.explosion({x:a[1].x+e*(Math.random()-.5),y:a[1].y+e*(Math.random()-.5)},s)}ctx.beginPath(),ctx.moveTo(a[0].x,a[0].y),ctx.lineTo(a[1].x,a[1].y),e>50&&(ctx.strokeStyle="rgba(255,0,0,0.10)",ctx.lineWidth=70,ctx.stroke()),ctx.strokeStyle="rgba(255,0,0,0.25)",ctx.lineWidth=20,ctx.stroke(),ctx.strokeStyle="#f00",ctx.lineWidth=4,ctx.stroke();const n=Vector.sub(a[1],a[0]),c=Vector.magnitude(n);for(let t=0,o=Math.floor(5e-4*c*e);t<o;t++){const e=Math.random();simulation.drawList.push({x:a[0].x+n.x*e+10*(Math.random()-.5),y:a[0].y+n.y*e+10*(Math.random()-.5),radius:1.5+5*Math.random(),color:"rgba(255,0,0,0.5)",time:Math.floor(9+25*Math.random()*Math.random())})}},window.b2.laser=(e,t,o,i,l,s,a)=>{const r=1-1/(3*i);let n={x:1,y:1,dist2:1/0,who:null,v1:1,v2:1};const c=[{x:e.x,y:e.y},{x:t.x,y:t.y}],h=function(){const e=mob.filter((e=>e.id!==a));n=vertexCollision(c[c.length-2],c[c.length-1],[e,map,body,[player]])},d=function(){if(n.who.alive){if("function"==typeof n.who.locatePlayer&&n.who.locatePlayer(),n.who.damageReduction&&(remotePlayers[a].tech.laserCrit&&!n.who.shield&&Vector.dot(Vector.normalise(Vector.sub(n.who.position,c[c.length-1])),Vector.normalise(Vector.sub(c[c.length-1],c[c.length-2])))>.999-.5/n.who.radius?(o*=1+remotePlayers[a].tech.laserCrit,simulation.drawList.push({x:c[c.length-1].x,y:c[c.length-1].y,radius:Math.sqrt(2500*o*n.who.damageReduction)+5,color:`hsla(${60+283*Math.random()},100%,70%,0.5)`,time:16})):simulation.drawList.push({x:c[c.length-1].x,y:c[c.length-1].y,radius:Math.sqrt(2e3*o*n.who.damageReduction)+2,color:remotePlayers[a].tech.laserColorAlpha,time:simulation.drawTime}),n.who.damage(o)),remotePlayers[a].tech.isLaserPush){const e=c.length-1;Matter.Body.setVelocity(n.who,{x:.97*n.who.velocity.x,y:.97*n.who.velocity.y});const t=Vector.mult(Vector.normalise(Vector.sub(c[e],c[Math.max(0,e-1)])),.003*s*Math.min(6,n.who.mass));Matter.Body.applyForce(n.who,c[e],t)}}else if(remotePlayers[a].tech.isLaserPush&&"body"===n.who.classType){const e=c.length-1;Matter.Body.setVelocity(n.who,{x:.97*n.who.velocity.x,y:.97*n.who.velocity.y});const t=Vector.mult(Vector.normalise(Vector.sub(c[e],c[Math.max(0,e-1)])),.003*s*Math.min(6,n.who.mass));Matter.Body.applyForce(n.who,c[e],t)}if(1==n.who.collisionFilter.category){if(remotePlayers[a].tech.isLaserPush){const e=c.length-1;Matter.Body.setVelocity(n.who,{x:.97*n.who.velocity.x,y:.97*n.who.velocity.y});const t=Vector.mult(Vector.normalise(Vector.sub(c[e],c[Math.max(0,e-1)])),.003*s*Math.min(6,n.who.mass));Matter.Body.applyForce(n.who,c[e],t)}remotePlayers[a].tech.laserCrit&&Vector.dot(Vector.normalise(Vector.sub(n.who.position,c[c.length-1])),Vector.normalise(Vector.sub(c[c.length-1],c[c.length-2])))>.999-.5/n.who.radius?(o*=1+remotePlayers[a].tech.laserCrit,simulation.drawList.push({x:c[c.length-1].x,y:c[c.length-1].y,radius:Math.sqrt(2500*o)+5,color:`hsla(${60+283*Math.random()},100%,70%,0.5)`,time:16})):simulation.drawList.push({x:c[c.length-1].x,y:c[c.length-1].y,radius:Math.sqrt(2e3*o)+2,color:remotePlayers[a].tech.laserColorAlpha,time:simulation.drawTime})}},y=function(){const e=Vector.perp(Vector.normalise(Vector.sub(n.v1,n.v2))),t=Vector.sub(c[c.length-1],c[c.length-2]),o=Vector.mult(e,2*Vector.dot(t,e)),i=Vector.normalise(Vector.sub(t,o));c[c.length]=Vector.add(Vector.mult(i,5e3),c[c.length-1])};let m;h();let u=n.who;if(n.dist2!==1/0){c[c.length-1]={x:n.x,y:n.y},d();for(let e=0;e<i&&(y(),h(),n.dist2!==1/0);e++)if(lastReflection=n,c[c.length-1]={x:n.x,y:n.y},o*=r,d(),e%2){if(m===n.who)break}else if(m=n.who,u===n.who)break}if(l)for(let e=1,t=c.length;e<t;++e)ctx.moveTo(c[e-1].x,c[e-1].y),ctx.lineTo(c[e].x,c[e].y);else if(remotePlayers[a].tech.isLaserLens&&1!==remotePlayers[a].lensDamage){ctx.strokeStyle=remotePlayers[a].tech.laserColor,ctx.lineWidth=2,ctx.lineDashOffset=900*Math.random(),ctx.setLineDash([50+120*Math.random(),50*Math.random()]);for(let e=1,t=c.length;e<t;++e)ctx.beginPath(),ctx.moveTo(c[e-1].x,c[e-1].y),ctx.lineTo(c[e].x,c[e].y),ctx.stroke(),ctx.globalAlpha*=r;ctx.setLineDash([]),ctx.lineWidth=9+2*remotePlayers[a].lensDamageOn,ctx.globalAlpha=.13,ctx.beginPath();for(let e=1,t=c.length;e<t;++e)ctx.moveTo(c[e-1].x,c[e-1].y),ctx.lineTo(c[e].x,c[e].y);ctx.stroke(),ctx.globalAlpha=1}else{ctx.strokeStyle=remotePlayers[a].tech.laserColor,ctx.lineWidth=2,ctx.lineDashOffset=900*Math.random(),ctx.setLineDash([50+120*Math.random(),50*Math.random()]);for(let e=1,t=c.length;e<t;++e)ctx.beginPath(),ctx.moveTo(c[e-1].x,c[e-1].y),ctx.lineTo(c[e].x,c[e].y),ctx.stroke(),ctx.globalAlpha*=r;ctx.setLineDash([]),ctx.globalAlpha=1}},window.b2.delayDrones=(e,t=1,o=0,i)=>{let l=()=>{if(t>0&&(requestAnimationFrame(l),!simulation.paused&&!simulation.isChoosing&&m.alive))if(t--,tech.isDroneRadioactive)b2.droneRadioactive({x:e.x+50*(Math.random()-.5),y:e.y+50*(Math.random()-.5)},0,i);else if(b2.drone({x:e.x+50*(Math.random()-.5),y:e.y+50*(Math.random()-.5)},0,i),tech.isDroneGrab&&o>0){const e=bullet[bullet.length-1];e.isImproved=!0;const t=2.25;e.scale=t,Matter.Body.scale(e,t,t),e.endCycle+=3e3*tech.droneCycleReduction*tech.bulletsLastLonger,o--}};requestAnimationFrame(l)},window.b2.drone=(e,t,o)=>{const i=bullet.length,l=.0015,s=remotePlayers[o].angle2+.2*(Math.random()-.5),a=4.5+3*Math.random();bullet[i]=Bodies.polygon(e.x,e.y,8,a,{angle:s,inertia:1/0,friction:.05,frictionAir:0,restitution:1,density:5e-4,dmg:.34+.12*remotePlayers[o].tech.isDroneTeleport+.15*remotePlayers[o].tech.isDroneFastLook,lookFrequency:55+Math.floor(10*Math.random()),endCycle:simulation.cycle+Math.floor((900+400*Math.random())*remotePlayers[o].tech.bulletsLastLonger*remotePlayers[o].tech.droneCycleReduction)+5*a+Math.max(0,200-bullet.length),classType:"bullet",isDrone:!0,collisionFilter:{group:-o,category:cat.body,mask:cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet|cat.mobShield|cat.player},minDmgSpeed:0,lockedOn:null,deathCycles:110+5*a,isImproved:!1,scale:1,beforeDmg(e){if(e.isInvulnerable){const t=Vector.mult(Vector.normalise(Vector.sub(this.position,e.position)),-20);Matter.Body.setVelocity(this,{x:t.x,y:t.y}),this.lockedOn=null}else{const t=Vector.mult(Vector.normalise(Vector.sub(this.position,e.position)),-20);Matter.Body.setVelocity(this,{x:t.x,y:t.y}),this.lockedOn=null,this.endCycle>simulation.cycle+this.deathCycles&&(this.endCycle-=50+30*this.scale,simulation.cycle+this.deathCycles>this.endCycle&&(this.endCycle=simulation.cycle+this.deathCycles))}},onEnd(){if(remotePlayers[o]&&remotePlayers[o].tech.isDroneRespawn){const e=body.filter((e=>0===Matter.Query.ray(map,this.position,e.position).length&&!e.isNotHoldable&&Vector.magnitude(Vector.sub(this.position,e.position))<70+30*e.mass));if(e.length){const t=e.reduce(((e,t)=>Vector.magnitude(Vector.sub(this.position,e.position))<Vector.magnitude(Vector.sub(this.position,t.position))?e:t));t&&remotePlayers[o].energy>.041&&(remotePlayers[o].energy-=.04,Composite.remove(engine.world,t),body.splice(body.indexOf(t),1),b2.delayDrones(t.position,Math.sqrt(t.mass),o),ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(t.position.x,t.position.y),ctx.strokeStyle="#000",ctx.lineWidth=2,ctx.stroke(),simulation.ephemera.push({count:60,do(){this.count--,this.count<0&&simulation.removeEphemera(this),ctx.beginPath();let e=t.vertices;ctx.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)ctx.lineTo(e[t].x,e[t].y);ctx.lineTo(e[0].x,e[0].y),ctx.lineWidth=2,ctx.strokeStyle=`rgba(0,0,0,${this.count/60})`,ctx.stroke()}}))}}},doRespawning(){Matter.Body.scale(this,.995,.995),this.bodyTarget?this.force=Vector.mult(Vector.normalise(Vector.sub(this.position,this.bodyTarget.position)),-this.mass*l):this.force.y+=.0012*this.mass},doDying(){this.force.y+=.0012*this.mass;Matter.Body.scale(this,.995,.995)},hasExploded:!1,eatPowerUp(e){if(simulation.ephemera.push({count:5,pos:this.position,PposX:powerUp[e].position.x,PposY:powerUp[e].position.y,size:powerUp[e].size,color:powerUp[e].color,do(){this.count--,this.count<0&&simulation.removeEphemera(this),ctx.strokeStyle="#000",ctx.lineWidth=3,ctx.beginPath(),ctx.moveTo(this.pos.x,this.pos.y),ctx.lineTo(this.PposX,this.PposY),ctx.stroke(),ctx.beginPath(),ctx.arc(this.PposX,this.PposY,this.size*(this.count+2)/7,0,2*Math.PI),ctx.fillStyle=this.color,ctx.fill()}}),powerUps.onPickUp(powerUp[e]),Matter.Composite.remove(engine.world,powerUp[e]),powerUp.splice(e,1),remotePlayers[o].tech.isDroneGrab){this.isImproved=!0,this.scale>1&&Matter.Body.scale(this,1/this.scale,1/this.scale);const e=2.25;this.scale=e,Matter.Body.scale(this,e,e),this.endCycle+=3e3*remotePlayers[o].tech.droneCycleReduction*remotePlayers[o].tech.bulletsLastLonger}},do(){if(remotePlayers[o]){if(simulation.cycle+this.deathCycles>this.endCycle)if(remotePlayers[o].tech.isIncendiary&&!this.hasExploded&&(this.hasExploded=!0,b.explosion(this.position,200+110*this.isImproved+60*Math.random())),this.restitution=.2,remotePlayers[o].tech.isDroneRespawn){this.do=this.doRespawning;const e=body.filter((e=>0===Matter.Query.ray(map,this.position,e.position).length&&!e.isNotHoldable));if(e.length){const t=e.reduce(((e,t)=>Vector.magnitude(Vector.sub(this.position,e.position))<Vector.magnitude(Vector.sub(this.position,t.position))?e:t));t&&(this.bodyTarget=t)}}else this.do=this.doDying;if(this.force.y+=2e-4*this.mass,this.lockedOn==player&&Matter.Query.collides(this,[player]).length){const e=Vector.mult(Vector.normalise(Vector.sub(this.position,player.position)),-20);Matter.Body.setVelocity(this,{x:e.x,y:e.y}),this.lockedOn=null,this.endCycle>simulation.cycle+this.deathCycles&&(this.endCycle-=50+30*this.scale,simulation.cycle+this.deathCycles>this.endCycle&&(this.endCycle=simulation.cycle+this.deathCycles))}if(!(simulation.cycle%this.lookFrequency)){if(remotePlayers[o].tech.isExponential)if(Matter.Query.collides(this,map).length>1){const e=.9;Matter.Body.scale(this,e,e),this.scale*=e}else{const e=1.03;Matter.Body.scale(this,e,e),this.scale*=e}this.lockedOn=null;let e=1/0;for(let t=0,i=mob.length;t<i;++t)if(!mob[t].isBadTarget&&0===Matter.Query.ray(map,this.position,mob[t].position).length&&0===Matter.Query.ray(body,this.position,mob[t].position).length&&!mob[t].isInvulnerable&&mob[t].id!=o){const o=Vector.sub(this.position,mob[t].position),i=Vector.magnitude(o);i<e&&(e=i,this.lockedOn=mob[t])}if(0===Matter.Query.ray(map,this.position,player.position).length&&0===Matter.Query.ray(body,this.position,player.position).length){const t=Vector.sub(this.position,player.position),o=Vector.magnitude(t);o<e&&(e=o,this.lockedOn=player)}if(remotePlayers[o].tech.isDroneTeleport&&this.lockedOn){const e=Vector.sub(this.lockedOn.position,this.position),t=Vector.magnitude(e),o=Vector.normalise(e);Matter.Body.setVelocity(this,Vector.mult(o,Math.max(20,1.5*this.speed))),ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),Matter.Body.translate(this,Vector.mult(o,Math.min(350,t-this.lockedOn.radius+10))),ctx.lineTo(this.position.x,this.position.y),ctx.lineWidth=2*a,ctx.strokeStyle="rgba(0,0,0,0.5)",ctx.stroke()}if(!this.isImproved&&!simulation.isChoosing)if(this.lockedOn){for(let e=0,t=powerUp.length;e<t;++e)if(Vector.magnitudeSquared(Vector.sub(this.position,powerUp[e].position))<2e4&&!simulation.isChoosing&&!(remotePlayers[o].health>.94*remotePlayers[o].maxHealth&&!remotePlayers[o].tech.isOverHeal&&!remotePlayers[o].tech.isDroneGrab&&"heal"===powerUp[e].name||remotePlayers[o].tech.isSuperDeterminism&&"field"===powerUp[e].name||(remotePlayers[o].tech.isEnergyNoAmmo||0===b.inventory.length)&&"ammo"===powerUp[e].name)){this.eatPowerUp(e);break}}else{let e=1/0;for(let t=0,i=powerUp.length;t<i;++t)if(!(remotePlayers[o].health>.94*remotePlayers[o].maxHealth&&!remotePlayers[o].tech.isOverHeal&&!remotePlayers[o].tech.isDroneGrab&&"heal"===powerUp[t].name||remotePlayers[o].tech.isSuperDeterminism&&"field"===powerUp[t].name||(remotePlayers[o].tech.isEnergyNoAmmo||0===b.inventory.length)&&"ammo"===powerUp[t].name)){if(Vector.magnitudeSquared(Vector.sub(this.position,powerUp[t].position))<2e4&&!simulation.isChoosing){this.eatPowerUp(t);break}if(0===Matter.Query.ray(map,this.position,powerUp[t].position).length){const o=Vector.sub(this.position,powerUp[t].position),i=Vector.magnitude(o);i<e&&(e=i,this.lockedOn=powerUp[t])}}}}this.lockedOn?this.force=Vector.mult(Vector.normalise(Vector.sub(this.position,this.lockedOn.position)),-this.mass*l):this.force=Vector.mult(Vector.normalise(Vector.sub(this.position,remotePlayers[o].mouse)),-this.mass*l),this.speed>6&&Matter.Body.setVelocity(this,{x:.97*this.velocity.x,y:.97*this.velocity.y})}}}),Composite.add(engine.world,bullet[i]),Matter.Body.setVelocity(bullet[i],{x:t*Math.cos(s),y:t*Math.sin(s)})},window.b2.droneRadioactive=(e,t,o)=>{const i=bullet.length,l=(remotePlayers[o].tech.isFastDrones?.003:.0012)+5e-4*(Math.random()-.5),s=remotePlayers[o].angle2+.4*(Math.random()-.5);bullet[i]=Bodies.polygon(e.x,e.y,8,3,{angle:s,inertia:1/0,friction:0,frictionAir:0,restitution:.4+.199*Math.random(),dmg:0,lookFrequency:120+Math.floor(23*Math.random()),endCycle:simulation.cycle+Math.floor((850+110*Math.random())*remotePlayers[o].tech.bulletsLastLonger/remotePlayers[o].tech.droneRadioDamage)+15+Math.max(0,200-2*bullet.length),classType:"bullet",isDrone:!0,collisionFilter:{category:cat.bullet,mask:cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet|cat.mobShield},minDmgSpeed:0,speedCap:5+2*Math.random(),lockedOn:null,deathCycles:125,isImproved:!1,radioRadius:0,maxRadioRadius:270+Math.floor(90*Math.random()),beforeDmg(){},onEnd(){if(remotePlayers[o]&&remotePlayers[o].tech.isDroneRespawn){const e=body.filter((e=>0===Matter.Query.ray(map,this.position,e.position).length&&!e.isNotHoldable&&Vector.magnitude(Vector.sub(this.position,e.position))<70+30*e.mass));if(e.length){const t=e.reduce(((e,t)=>Vector.magnitude(Vector.sub(this.position,e.position))<Vector.magnitude(Vector.sub(this.position,t.position))?e:t));t&&remotePlayers[o].energy>.091&&(remotePlayers[o].energy-=.09,remotePlayers[o].fieldUpgrades[4].endoThermic(.7),Composite.remove(engine.world,t),body.splice(body.indexOf(t),1),b2.delayDrones(t.position,.5*Math.sqrt(t.mass),o),ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(t.position.x,t.position.y),ctx.strokeStyle="#000",ctx.lineWidth=2,ctx.stroke(),simulation.ephemera.push({count:60,do(){this.count--,this.count<0&&simulation.removeEphemera(this),ctx.beginPath();let e=t.vertices;ctx.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)ctx.lineTo(e[t].x,e[t].y);ctx.lineTo(e[0].x,e[0].y),ctx.lineWidth=2,ctx.strokeStyle=`rgba(0,0,0,${this.count/60})`,ctx.stroke()}}))}}},do(){if(!remotePlayers[o])return;this.radioRadius=.993*this.radioRadius+.007*this.maxRadioRadius;let e=(.12+.04*remotePlayers[o].tech.isFastDrones)*remotePlayers[o].tech.droneRadioDamage*remotePlayers[o].tech.radioactiveDamage;for(let t=0,i=mob.length;t<i;t++)Vector.magnitude(Vector.sub(mob[t].position,this.position))<this.radioRadius+mob[t].radius&&mob[t].id!=o&&(Matter.Query.ray(map,mob[t].position,this.position).length>0&&(e*=.25),mob[t].damage(mob[t].shield?3*e:e),mob[t].locatePlayer());if(ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.radioRadius,0,2*Math.PI),ctx.globalCompositeOperation="lighter",ctx.fillStyle=`rgba(28, 175, 217,${.13+.07*Math.random()})`,ctx.fill(),ctx.globalCompositeOperation="source-over",simulation.cycle+this.deathCycles>this.endCycle){this.force.y+=.0012*this.mass,this.restitution=.2;const e=.995;Matter.Body.scale(this,e,e),this.maxRadioRadius=0,this.radioRadius=.98*this.radioRadius}else{if(this.force.y+=2e-4*this.mass,!(simulation.cycle%this.lookFrequency)){if(remotePlayers[o].tech.isExponential){const e=1.03;Matter.Body.scale(this,e,e),this.scale*=e,this.radioRadius=this.radioRadius*e}this.lockedOn=null;let e=1/0;for(let t=0,i=mob.length;t<i;++t)if(!mob[t].isBadTarget&&0===Matter.Query.ray(map,this.position,mob[t].position).length&&0===Matter.Query.ray(body,this.position,mob[t].position).length&&!mob[t].isInvulnerable&&mob[t].id!=o){const o=Vector.sub(this.position,mob[t].position),i=Vector.magnitude(o);i<e&&(e=i,this.lockedOn=mob[t])}if(0===Matter.Query.ray(map,this.position,player.position).length&&0===Matter.Query.ray(body,this.position,player.position).length){const t=Vector.sub(this.position,player.position),o=Vector.magnitude(t);o<e&&(e=o,this.lockedOn=player)}if(!this.isImproved&&!simulation.isChoosing)if(this.lockedOn){for(let e=0,t=powerUp.length;e<t;++e)if(Vector.magnitudeSquared(Vector.sub(this.position,powerUp[e].position))<2e4&&!(remotePlayers[o].health>.93*remotePlayers[o].maxHealth&&!remotePlayers[o].tech.isDroneGrab&&"heal"===powerUp[e].name||remotePlayers[o].tech.isSuperDeterminism&&"field"===powerUp[e].name||(remotePlayers[o].tech.isEnergyNoAmmo||0===b.inventory.length)&&"ammo"===powerUp[e].name)){if(ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(powerUp[e].position.x,powerUp[e].position.y),ctx.strokeStyle="#000",ctx.lineWidth=4,ctx.stroke(),powerUps.onPickUp(powerUp[e]),Matter.Composite.remove(engine.world,powerUp[e]),powerUp.splice(e,1),remotePlayers[o].tech.isDroneGrab){this.isImproved=!0;const e=2.25;this.scale>1&&Matter.Body.scale(this,1/this.scale,1/this.scale),this.scale=e,Matter.Body.scale(this,e,e),this.endCycle+=1e3*remotePlayers[o].tech.bulletsLastLonger,this.maxRadioRadius*=1.25}break}}else{let e=1/0;for(let t=0,i=powerUp.length;t<i;++t)if(!(remotePlayers[o].health>.93*remotePlayers[o].maxHealth&&!remotePlayers[o].tech.isDroneGrab&&"heal"===powerUp[t].name||remotePlayers[o].tech.isSuperDeterminism&&"field"===powerUp[t].name||(remotePlayers[o].tech.isEnergyNoAmmo||0===b.inventory.length)&&"ammo"===powerUp[t].name)){if(Vector.magnitudeSquared(Vector.sub(this.position,powerUp[t].position))<2e4&&!simulation.isChoosing){if(ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(powerUp[t].position.x,powerUp[t].position.y),ctx.strokeStyle="#000",ctx.lineWidth=4,ctx.stroke(),powerUps.onPickUp(powerUp[t]),Matter.Composite.remove(engine.world,powerUp[t]),powerUp.splice(t,1),remotePlayers[o].tech.isDroneGrab){this.isImproved=!0;const e=2.25;this.scale>1&&Matter.Body.scale(this,1/this.scale,1/this.scale),this.scale=e,Matter.Body.scale(this,e,e),this.endCycle+=1e3*remotePlayers[o].tech.bulletsLastLonger,this.maxRadioRadius*=1.25}break}if(0===Matter.Query.ray(map,this.position,powerUp[t].position).length&&0===Matter.Query.ray(body,this.position,powerUp[t].position).length){const o=Vector.sub(this.position,powerUp[t].position),i=Vector.magnitude(o);i<e&&(e=i,this.lockedOn=powerUp[t])}}}}this.lockedOn?this.force=Vector.mult(Vector.normalise(Vector.sub(this.position,this.lockedOn.position)),-this.mass*l):this.force=Vector.mult(Vector.normalise(Vector.sub(this.position,remotePlayers[o].mouse)),-this.mass*l),this.speed>this.speedCap&&Matter.Body.setVelocity(this,{x:.97*this.velocity.x,y:.97*this.velocity.y})}}}),Composite.add(engine.world,bullet[i]),Matter.Body.setVelocity(bullet[i],{x:t*Math.cos(s),y:t*Math.sin(s)})},window.b2.foam=(e,t,o,i)=>{remotePlayers[i].tech.isFoamCavitation&&Math.random()<.25&&(t=Vector.mult(t,1.35),o=1.2*o+13);const l=bullet.length;bullet[l]=Bodies.polygon(e.x,e.y,20,o,{density:1e-6,inertia:1/0,frictionAir:.003,dmg:0,damage:remotePlayers[i].tech.foamDamage*(remotePlayers[i].tech.isFastFoam?2.8:1)*(remotePlayers[i].tech.isBulletTeleport?1.53:1),scale:1-.006/remotePlayers[i].tech.bulletsLastLonger*(remotePlayers[i].tech.isFastFoam?1.65:1),classType:"bullet",collisionFilter:{category:cat.body,mask:cat.mob|cat.mobBullet|cat.player},minDmgSpeed:0,endCycle:1/0,count:0,radius:o,target:null,targetVertex:null,targetRelativePosition:null,portFrequency:7+Math.floor(5*Math.random()),nextPortCycle:1/0,beforeDmg(e){if(!this.target&&e.alive){if(this.target=e,e.radius<20)this.targetRelativePosition={x:0,y:0};else if(Matter.Query.collides(this,[e]).length>0){const t=Matter.Query.collides(this,[e])[0].normal;this.targetRelativePosition=Vector.rotate(Vector.sub(Vector.sub(this.position,e.position),Vector.mult(t,-this.radius)),-e.angle)}else this.targetRelativePosition=Vector.rotate(Vector.sub(this.position,e.position),-e.angle);this.collisionFilter.category=cat.body,this.collisionFilter.mask=null;let t=1/0,o=null;for(let e=0;e<this.target.vertices.length;e++){const i=Vector.magnitude(Vector.sub(this.position,this.target.vertices[e]));i<t&&(o=e,t=i)}this.targetVertex=o,Matter.Body.setVelocity(this,{x:0,y:0})}},onEnd(){},do(){if(remotePlayers[i]){if(this.count<20){this.count++;const e=1.06;Matter.Body.scale(this,e,e),this.radius*=e}else Matter.Body.scale(this,this.scale,this.scale),this.radius*=this.scale,this.radius<8&&(this.endCycle=0);if(this.target==player){const e=Vector.rotate(this.targetRelativePosition,m.angle);Matter.Body.setPosition(this,Vector.add(Vector.add(e,this.target.velocity),this.target.position)),player.speed>2.5&&Matter.Body.setVelocity(player,Vector.mult(player.velocity,.94))}else if(this.target&&this.target.alive&&this.target.mob){const e=Vector.rotate(this.targetRelativePosition,this.target.angle);if(this.target.isVerticesChange?Matter.Body.setPosition(this,this.target.vertices[this.targetVertex]):Matter.Body.setPosition(this,Vector.add(Vector.add(e,this.target.velocity),this.target.position)),this.target.isBoss?this.target.speed>6.5&&Matter.Body.setVelocity(this.target,Vector.mult(this.target.velocity,.975)):this.target.speed>2.5&&Matter.Body.setVelocity(this.target,Vector.mult(this.target.velocity,.94)),Matter.Body.setAngularVelocity(this.target,.9*this.target.angularVelocity),this.target.isShielded){this.target.damage(this.damage,!0);const e=1-.004/remotePlayers[i].tech.bulletsLastLonger;Matter.Body.scale(this,e,e),this.radius*=e}else this.target.damage(this.damage)}else if(null!==this.target){if(this.collisionFilter.category=cat.body,this.collisionFilter.mask=cat.mob|cat.player,Matter.Body.setVelocity(this,{x:this.target.velocity.x,y:this.target.velocity.y}),remotePlayers[i].tech.isSpawnBulletsOnDeath&&bullet.length<180&&!this.target.mobBullet){let e=[];m.alive&&e.push(player);for(let t=0,o=mob.length;t<o;t++){Vector.magnitudeSquared(Vector.sub(this.position,mob[t].position))<1e6&&e.push(mob[t])}const t=Math.min(.5*this.radius,9),o=bullet.length<80?2:1;for(let l=0;l<o;l++)if(e.length-l>0){const o=Math.floor(Math.random()*e.length),l=6+6*Math.random(),s=Vector.mult(Vector.normalise(Vector.sub(e[o].position,this.position)),l);b2.foam(this.position,Vector.rotate(s,.5*(Math.random()-.5)),t,i)}else b2.foam(this.position,Vector.rotate({x:15+10*Math.random(),y:0},2*Math.PI*Math.random()),t,i)}this.target=null}else if(Matter.Query.point(map,this.position).length>0){const e=.87;Matter.Body.setVelocity(this,{x:this.velocity.x*e,y:this.velocity.y*e});const t=.97;Matter.Body.scale(this,t,t),this.radius*=t}else if(Matter.Query.point(body,this.position).length>0){const e=.94;Matter.Body.setVelocity(this,{x:this.velocity.x*e,y:this.velocity.y*e});const t=.99;Matter.Body.scale(this,t,t),this.radius*=t}else if(!this.target&&m.alive&&Matter.Query.collides(this,[player]).length&&(this.target=player,this.targetRelativePosition=Vector.rotate(Vector.sub(this.position,player.position),-m.angle),Matter.Body.setVelocity(this,{x:0,y:0}),this.collisionFilter.mask=null),this.force.y+=this.mass*remotePlayers[i].tech.foamGravity,remotePlayers[i].tech.isFoamAttract){const e=[...mob];m.alive&&e.push(player);for(let t=0,o=e.length;t<o;t++){const o=e[t],i=Vector.magnitude(Vector.sub(o.position,this.position));if((o.mob?!o.isBadTarget&&o.alive&&!o.isInvulnerable:m.alive)&&i<500&&0===Matter.Query.ray(map,this.position,o.position).length){const e=.001*Math.min(1,200/i);this.force=Vector.mult(Vector.normalise(Vector.sub(o.position,this.position)),this.mass*e);const t=.98;Matter.Body.setVelocity(this,{x:this.velocity.x*t,y:this.velocity.y*t});break}}}if(this.nextPortCycle<simulation.cycle){this.nextPortCycle=simulation.cycle+this.portFrequency;const e=13*Math.sqrt(this.radius)*Math.random();Matter.Body.setPosition(this,Vector.add(this.position,Vector.rotate({x:e,y:0},2*Math.PI*Math.random())))}}}}),remotePlayers[i].tech.isBulletTeleport&&(bullet[l].nextPortCycle=simulation.cycle+bullet[l].portFrequency),Composite.add(engine.world,bullet[l]),bullet[l].remoteBullet=!0,bullet[l].collisionFilter.group=-i,Matter.Body.setVelocity(bullet[l],t)},window.b2.harpoon=(e,t,o=remotePlayers[n].angle2,i=1,l=!1,s=35,a=!0,r=.1,n)=>{const c=bullet.length,h=100*Math.sqrt(i);let d;if(remotePlayers[n].tech.isRebar){const e=remotePlayers[n].tech.isMaul?32:65,t=remotePlayers[n].tech.isMaul?25:5;d=[{x:-e*i,y:t*i,index:0,isInternal:!1},{x:-e*i*1.05,y:0,index:1,isInternal:!1},{x:-e*i,y:-t*i,index:2,isInternal:!1},{x:e*i,y:-t*i,index:3,isInternal:!1},{x:e*i*1.05,y:0,index:4,isInternal:!1},{x:e*i,y:t*i,index:5,isInternal:!1}]}else d=[{x:-40*i,y:2*i,index:0,isInternal:!1},{x:-40*i,y:-2*i,index:1,isInternal:!1},{x:50*i,y:-3*i,index:3,isInternal:!1},{x:30*i,y:2*i,index:4,isInternal:!1}];bullet[c]=Bodies.fromVertices(e.x,e.y,d,{cycle:0,angle:o,friction:1,frictionAir:.4,drain:remotePlayers[n].tech.isRailEnergy?2e-4:.006,turnRate:l?.1:.03,drawStringControlMagnitude:3e3+5e3*Math.random(),drawStringFlip:Math.round(Math.random())?1:-1,dmg:6,classType:"bullet",endCycle:simulation.cycle+2.5*s+40,collisionFilter:{category:cat.body,mask:remotePlayers[n].tech.isShieldPierce?cat.map|cat.body|cat.mob|cat.mobBullet|cat.player:cat.map|cat.body|cat.mob|cat.mobBullet|cat.mobShield|cat.player},minDmgSpeed:4,lookFrequency:Math.floor(7+3*Math.random()),density:remotePlayers[n].tech.harpoonDensity*(remotePlayers[n].tech.isRebar?.6:1),foamSpawned:0,beforeDmg(e){if(remotePlayers[n].tech.isShieldPierce&&e.isShielded&&(e.isShielded=!1,requestAnimationFrame((()=>{e.isShielded=!0}))),remotePlayers[n].tech.fragments&&(b2.targetedNail(this.vertices[2],remotePlayers[n].tech.fragments*Math.floor(2+Math.random())),l||(this.endCycle=0)),e.isBadTarget||(l?this.do=this.returnToPlayer:(this.frictionAir=.01,this.do=()=>{this.force.y+=.003*this.mass,this.draw()})),remotePlayers[n].tech.isFoamBall&&this.foamSpawned<55)for(let e=0,t=Math.min(30,2+3*Math.sqrt(this.mass));e<t;e++){const e=5+9*Math.random(),t={x:Math.max(.5,2-.1*e),y:0};b2.foam(this.position,Vector.rotate(t,6.28*Math.random()),e,n),this.foamSpawned++}if(remotePlayers[n].tech.isHarpoonPowerUp&&simulation.cycle-480<remotePlayers[n].tech.harpoonPowerUpCycle?Matter.Body.setDensity(this,1.8*remotePlayers[n].tech.harpoonDensity):remotePlayers[n].tech.isHarpoonFullHealth&&1===e.health&&(Matter.Body.setDensity(this,2.2*remotePlayers[n].tech.harpoonDensity),simulation.ephemera.push({count:2,vertices:this.vertices,do(){this.count--,this.count<0&&simulation.removeEphemera(this),ctx.beginPath(),ctx.moveTo(this.vertices[0].x,this.vertices[0].y);for(let e=1,t=this.vertices.length;e<t;e+=1)ctx.lineTo(this.vertices[e].x,this.vertices[e].y);ctx.lineTo(this.vertices[0].x,this.vertices[0].y),ctx.lineJoin="miter",ctx.miterLimit=20,ctx.lineWidth=40,ctx.strokeStyle="rgba(255,0,100,0.35)",ctx.stroke(),ctx.lineWidth=10,ctx.strokeStyle="#f07",ctx.stroke(),ctx.lineJoin="round",ctx.miterLimit=5,ctx.fillStyle="#000",ctx.fill()}})),remotePlayers[n].tech.isBreakHarpoon&&Math.random()<.1){remotePlayers[n].tech.isBreakHarpoonGain&&(powerUps.spawn(remotePlayers[n].pos.x,remotePlayers[n].pos.y-50,"research"),powerUps.spawn(remotePlayers[n].pos.x-20,remotePlayers[n].pos.y+15,"research"),powerUps.spawn(remotePlayers[n].pos.x+20,remotePlayers[n].pos.y+15,"boost"),b2.targetedNail(this.position,Math.floor(1+1.5*Math.random()))),this.endCycle+=60,this.frictionAir=.01,Matter.Body.setAngularVelocity(this,.7*(Math.random()-.5));const e=Vector.normalise(this.velocity);Matter.Body.setVelocity(this,Vector.mult(e,Math.min(this.speed,20))),this.do=()=>{this.force.y+=.005*this.mass}}},caughtPowerUp:null,dropCaughtPowerUp(){this.caughtPowerUp&&(this.caughtPowerUp.collisionFilter.category=cat.powerUp,this.caughtPowerUp.collisionFilter.mask=cat.map|cat.powerUp,this.caughtPowerUp=null)},onEnd(){if(!this.caughtPowerUp||simulation.isChoosing||"heal"===this.caughtPowerUp.name&&m.health===m.maxHealth&&!remotePlayers[n].tech.isOverHeal)this.dropCaughtPowerUp();else{let e=null;for(let t=0,o=powerUp.length;t<o;++t)powerUp[t]===this.caughtPowerUp&&(e=t);null!==e?(powerUps.onPickUp(this.caughtPowerUp),Matter.Composite.remove(engine.world,this.caughtPowerUp),powerUp.splice(e,1),remotePlayers[n].tech.isHarpoonPowerUp&&(remotePlayers[n].tech.harpoonPowerUpCycle=simulation.cycle)):this.dropCaughtPowerUp()}},drawDamageAura(){ctx.beginPath(),ctx.moveTo(this.vertices[0].x,this.vertices[0].y);for(let e=1,t=this.vertices.length;e<t;e+=1)ctx.lineTo(this.vertices[e].x,this.vertices[e].y);ctx.lineTo(this.vertices[0].x,this.vertices[0].y),ctx.lineJoin="miter",ctx.miterLimit=20,ctx.lineWidth=15,ctx.strokeStyle="rgba(255,0,100,0.25)",ctx.stroke(),ctx.lineWidth=4,ctx.strokeStyle="#f07",ctx.stroke(),ctx.lineJoin="round",ctx.miterLimit=5,ctx.fillStyle="#000",ctx.fill()},drawString(){ropeIndex=this.vertices.length-1;const e={x:remotePlayers[n].pos.x+30*Math.cos(remotePlayers[n].angle2),y:remotePlayers[n].pos.y+30*Math.sin(remotePlayers[n].angle2)},t=Vector.sub(e,this.vertices[ropeIndex]),o=Vector.mult(Vector.normalise(Vector.perp(t)),this.drawStringFlip*Math.min(80,10+this.drawStringControlMagnitude/(10+Vector.magnitude(t)))),i=Vector.add(Vector.add(e,Vector.mult(t,-.5)),o);ctx.strokeStyle="#000",ctx.lineWidth=.5,ctx.beginPath(),ctx.moveTo(e.x,e.y),ctx.quadraticCurveTo(i.x,i.y,this.vertices[ropeIndex].x,this.vertices[ropeIndex].y),ctx.stroke()},draw(){},returnToPlayer(){if(Vector.magnitude(Vector.sub(this.position,remotePlayers[n].pos))<h){this.endCycle=0;const e=Vector.mult(Vector.sub(this.velocity,remotePlayers[n].velocity),remotePlayers[n].crouch?1e-4:2e-4);remotePlayers[n].force.x+=e.x,remotePlayers[n].force.y+=e.y}else{const e=Vector.sub(this.position,remotePlayers[n].pos),t=1+1e-6*Vector.magnitude(e)*Vector.magnitude(e),o=Vector.mult(Vector.normalise(e),t*r*this.mass);m.energy>this.drain&&(m.energy-=this.drain),m.energy<.05?(this.force.x-=.15*o.x,this.force.y-=.15*o.y):(this.force.x-=o.x,this.force.y-=o.y),this.grabPowerUp()}this.draw()},grabPowerUp(){if(this.caughtPowerUp)Matter.Body.setPosition(this.caughtPowerUp,Vector.add(this.vertices[2],this.velocity)),Matter.Body.setVelocity(this.caughtPowerUp,{x:0,y:0});else for(let e=0,t=powerUp.length;e<t;++e){if(remotePlayers[n].tech.isEnergyNoAmmo&&"ammo"===powerUp[e].name)continue;const t=powerUp[e].circleRadius+50;if(Vector.magnitudeSquared(Vector.sub(this.vertices[2],powerUp[e].position))<t*t&&!powerUp[e].isGrabbed&&("heal"!==powerUp[e].name||m.health!==m.maxHealth||remotePlayers[n].tech.isOverHeal)){powerUp[e].isGrabbed=!0,this.caughtPowerUp=powerUp[e],Matter.Body.setVelocity(powerUp[e],{x:0,y:0}),Matter.Body.setPosition(powerUp[e],this.vertices[2]),powerUp[e].collisionFilter.category=0,powerUp[e].collisionFilter.mask=0,r*=.6,this.endCycle+=.5;break}}},do(){if(this.cycle++,l||t){if(l)if(this.cycle>s){this.do=this.returnToPlayer,this.angularSpeed<.5&&(this.torque+=.001*this.inertia*(Math.random()-.5)),Matter.Sleeping.set(this,!1),this.endCycle=simulation.cycle+240;const e=Vector.mult(Vector.sub(this.velocity,remotePlayers[n].velocity),remotePlayers[n].crouch?15e-5:3e-4);remotePlayers[n].force.x+=e.x,remotePlayers[n].force.y+=e.y,requestAnimationFrame((()=>{this.collisionFilter.category=0,this.collisionFilter.mask=0}))}else this.grabPowerUp();if(t){const e={x:Math.cos(this.angle),y:Math.sin(this.angle)},o=Vector.normalise(Vector.sub(this.position,t.position));Vector.cross(o,e)>0?Matter.Body.rotate(this,this.turnRate):Matter.Body.rotate(this,-this.turnRate)}this.force.x+=r*this.mass*Math.cos(this.angle),this.force.y+=r*this.mass*Math.sin(this.angle)}this.draw()}}),l||t||(Matter.Body.setVelocity(bullet[c],{x:.7*remotePlayers[n].velocity.x+600*r*Math.cos(bullet[c].angle),y:.5*remotePlayers[n].velocity.x+600*r*Math.sin(bullet[c].angle)}),bullet[c].frictionAir=.002,bullet[c].do=function(){this.speed<20&&(this.force.y+=5e-4*this.mass),this.draw()}),remotePlayers[n].tech.isHarpoonPowerUp&&simulation.cycle-480<remotePlayers[n].tech.harpoonPowerUpCycle?bullet[c].draw=l?function(){this.drawDamageAura(),this.drawString()}:function(){this.drawDamageAura()}:l&&(bullet[c].draw=function(){this.drawString()}),Composite.add(engine.world,bullet[c]),bullet[c].remoteBullet=!0,bullet[c].collisionFilter.group=-n},window.b2.mine=(e,t,o=0,i)=>{const l=bullet.length;bullet[l]=Bodies.rectangle(e.x,e.y,45,16,{angle:o,friction:1,frictionStatic:1,frictionAir:0,restitution:0,dmg:0,classType:"bullet",bulletType:"mine",collisionFilter:{group:-i,category:cat.body,mask:cat.map|cat.body|cat.mob|cat.mobBullet|cat.mobShield|cat.player},minDmgSpeed:5,stillCount:0,isArmed:!1,endCycle:1/0,lookFrequency:0,range:700-300*remotePlayers[i].tech.isFoamMine,beforeDmg(){},onEnd(){if(this.isArmed&&!remotePlayers[i].tech.isMineSentry)if(remotePlayers[i].tech.isFoamMine){for(let e=0;e<12;e++){const e=13+8*Math.random(),t={x:.5+5.5*Math.random(),y:0};b2.foam(this.position,Vector.rotate(t,this.angle+1.57+3*(Math.random()-.5)),e,i)}let e=0,t=()=>{e<50&&(simulation.paused||simulation.isChoosing||(//!(simulation.cycle % 1) &&
e++,b2.targetedFoam(this.position,1,21+7*Math.random(),1200,!0,i)),requestAnimationFrame(t))};requestAnimationFrame(t)}else remotePlayers[i].tech.isSuperMine?b2.targetedBall(this.position,22+2*remotePlayers[i].tech.extraSuperBalls,40+10*Math.random(),1200,2.2,i):b2.targetedNail(this.position,22,40+10*Math.random(),1200,2.2,i)},do(){this.force.y+=.002*this.mass;let e=Matter.Query.collides(this,map);if(e.length>0){for(let t=0;t<e.length;t++)if(e[t].bodyA.collisionFilter.category===cat.map){const o=Vector.angle(e[t].normal,{x:1,y:0});Matter.Body.setAngle(this,Math.atan2(e[t].tangent.y,e[t].tangent.x));for(let l=0;l<10;l++){if(Matter.Query.collides(this,map).length>0){o>-.2||o<-1.5?(Matter.Body.setVelocity(this,{x:0,y:0}),Matter.Body.setStatic(this,!0),this.collisionFilter.category=0,this.collisionFilter.mask=0):(Matter.Body.setVelocity(this,{x:0,y:0}),Matter.Body.setAngularVelocity(this,0)),this.arm(),setTimeout((()=>{(0===Matter.Query.collides(this,map).length||Matter.Query.point(map,this.position).length>0)&&(this.endCycle=0,this.isArmed=!1,b2.mine(this.position,this.velocity,this.angle,i))}),100);break}Matter.Body.setPosition(this,Vector.add(this.position,Vector.mult(e[t].normal,2)))}break}}else this.speed<1&&this.angularSpeed<.01&&this.stillCount++;this.stillCount>25&&this.arm()},arm(){this.collisionFilter.mask=cat.map|cat.body|cat.mob|cat.mobBullet|cat.mobShield|cat.bullet|cat.player,this.lookFrequency=simulation.cycle+60,this.do=function(){this.force.y+=.002*this.mass,simulation.cycle>this.lookFrequency&&(this.isArmed=!0,this.lookFrequency=55+Math.floor(22*Math.random()),simulation.drawList.push({x:this.position.x,y:this.position.y,radius:10,color:"#f00",time:4}),this.do=function(){if(this.force.y+=.002*this.mass,!(simulation.cycle%this.lookFrequency)){const e=300*Math.random(),t=[...mob,player];for(let o=0,l=t.length;o<l;++o)if(t[o].id!=i&&Vector.magnitude(Vector.sub(this.position,t[o].position))<this.range+(t[o]==player?m.radius:t[o].radius)+e&&0===Matter.Query.ray(map,this.position,t[o].position).length&&0===Matter.Query.ray(body,this.position,t[o].position).length){if(remotePlayers[i].tech.isStun&&b.AoEStunEffect(this.position,this.range+t[o].radius+e),remotePlayers[i].tech.isMineSentry){this.lookFrequency=Math.floor(5+7*remotePlayers[i].fireCDscale+10*(remotePlayers[i].tech.oneSuperBall&&remotePlayers[i].tech.isSuperMine)+Math.floor(2*Math.random())),this.shots=remotePlayers[i].tech.sentryAmmo,this.do=function(){if(this.force.y+=.002*this.mass,!(simulation.cycle%this.lookFrequency)){if(remotePlayers[i].tech.isFoamMine)this.shots-=.6*b2.targetedFoam(this.position,1,21+7*Math.random(),1200,!1,i),b2.targetedFoam(this.position,1,21+7*Math.random(),1200,!1,i);else if(remotePlayers[i].tech.isSuperMine){const e=remotePlayers[i].tech.oneSuperBall?2:.7;this.shots-=e*b2.targetedBall(this.position,1,42+12*Math.random(),1200,!1,i);for(let e=0,t=remotePlayers[i].tech.extraSuperBalls/4;e<t;e++)Math.random()<.33&&b2.targetedBall(this.position,1,42+12*Math.random(),1200,!1,i)}else this.shots-=b2.targetedNail(this.position,1,45+5*Math.random(),1100,2.3,i);this.shots<0&&(this.endCycle=0),simulation.cycle%(6*this.lookFrequency)||simulation.drawList.push({x:this.position.x,y:this.position.y,radius:8,color:"#fe0",time:4})}};break}this.endCycle=0;break}}})}}}),bullet[l].torque+=2e-4*bullet[l].inertia*(.5-Math.random()),Matter.Body.setVelocity(bullet[l],t),Composite.add(engine.world,bullet[l])},window.b2.targetedNail=(e,t=1,o=40+10*Math.random(),i=1200,l=1.4,s)=>{let a=0;const r=[];let n=[...mob,player];for(let t=0,o=n.length;t<o;t++){const o=Vector.magnitude(Vector.sub(e,n[t].position));o<i+(n[t]==player?m.radius:n[t].radius)&&n[t].id!=s&&0===Matter.Query.ray(map,e,n[t].position).length&&0===Matter.Query.ray(body,e,n[t].position).length&&r.push(Vector.add(n[t].position,Vector.mult(n[t].velocity,o/60)))}for(let i=0;i<t;i++)if(r.length>0){const t=Math.floor(Math.random()*r.length),i=150/r.length,n={x:r[t].x+i*(Math.random()-.5),y:r[t].y+i*(Math.random()-.5)};b2.nail(e,Vector.mult(Vector.normalise(Vector.sub(n,e)),o),l,s),a++}else{const t=2*Math.PI*Math.random();b2.nail(e,{x:o*Math.cos(t),y:o*Math.sin(t)},l,s),a++}return a},window.b2.grapple=function(e,t,o){const i=bullet.length;bullet[i]=Bodies.fromVertices(e.x,e.y,[{x:-40,y:2,index:0,isInternal:!1},{x:-40,y:-2,index:1,isInternal:!1},{x:37,y:-2,index:2,isInternal:!1},{x:40,y:-1,index:3,isInternal:!1},{x:37,y:3,index:4,isInternal:!1}],{angle:t,friction:1,frictionAir:.4,thrustMag:.17,dmg:7,classType:"bullet",endCycle:simulation.cycle+70,isSlowPull:!1,drawStringControlMagnitude:1e3+1e3*Math.random(),drawStringFlip:Math.round(Math.random())?1:-1,attached:!1,glowColor:remotePlayers[o].tech.hookNails?"rgba(200,0,0,0.07)":remotePlayers[o].tech.isHarmReduce?"rgba(50,100,255,0.1)":"rgba(0,200,255,0.07)",collisionFilter:{group:-o,category:cat.body,mask:remotePlayers[o].tech.isShieldPierce?cat.body|cat.mob|cat.mobBullet:cat.body|cat.mob|cat.mobBullet|cat.mobShield|cat.player},minDmgSpeed:4,density:.004,drain:.001,powerUpDamage:remotePlayers[o].tech.isHarpoonPowerUp&&simulation.cycle-480<remotePlayers[o].tech.harpoonPowerUpCycle,draw(){const e={x:remotePlayers[o].pos.x+30*Math.cos(remotePlayers[o].angle2),y:remotePlayers[o].pos.y+30*Math.sin(remotePlayers[o].angle2)},t=Vector.sub(e,this.vertices[0]);if(ctx.strokeStyle="#000",ctx.lineWidth=.5,ctx.beginPath(),ctx.moveTo(e.x,e.y),this.attached){const o=Vector.add(e,Vector.mult(t,-.5));ctx.quadraticCurveTo(o.x,o.y,this.vertices[0].x,this.vertices[0].y)}else{const o=Math.max(Vector.magnitude(t),60),i=Vector.mult(Vector.normalise(Vector.perp(t)),this.drawStringFlip*Math.min(.7*o,10+this.drawStringControlMagnitude/(10+Vector.magnitude(t)))),l=Vector.add(Vector.add(e,Vector.mult(t,-.5)),i);ctx.quadraticCurveTo(l.x,l.y,this.vertices[0].x,this.vertices[0].y)}ctx.strokeStyle=this.glowColor,ctx.lineWidth=10,ctx.stroke(),ctx.strokeStyle="#000",ctx.lineWidth=.5,ctx.stroke(),this.powerUpDamage&&(ctx.beginPath(),ctx.moveTo(this.vertices[0].x,this.vertices[0].y),ctx.lineTo(this.vertices[1].x,this.vertices[1].y),ctx.lineTo(this.vertices[2].x,this.vertices[2].y),ctx.lineTo(this.vertices[3].x,this.vertices[3].y),ctx.lineTo(this.vertices[4].x,this.vertices[4].y),ctx.lineJoin="miter",ctx.miterLimit=30,ctx.lineWidth=25,ctx.strokeStyle="rgba(0,255,255,0.4)",ctx.stroke(),ctx.lineWidth=8,ctx.strokeStyle="rgb(0,255,255)",ctx.stroke(),ctx.lineJoin="round",ctx.miterLimit=5,ctx.fillStyle="#000",ctx.fill()),ctx.beginPath(),ctx.lineTo(this.vertices[0].x,this.vertices[0].y);const i=Vector.add(this.vertices[3],Vector.mult(Vector.sub(this.vertices[3],this.vertices[2]),2));ctx.moveTo(this.vertices[2].x,this.vertices[2].y),ctx.lineTo(i.x,i.y),ctx.lineTo(this.vertices[1].x,this.vertices[1].y),ctx.fillStyle="#000",ctx.fill()},beforeDmg(e){if(remotePlayers[o].tech.isShieldPierce&&e.isShielded&&(e.isShielded=!1,requestAnimationFrame((()=>{e.isShielded=!0}))),remotePlayers[o].fieldCDcycle<remotePlayers[o].cycle+30&&(remotePlayers[o].fieldCDcycle=remotePlayers[o].cycle+30),remotePlayers[o].tech.hookNails){b2.targetedNail(this.position,remotePlayers[o].tech.hookNails,40+10*Math.random(),1200,1.4,o);const e=2*Math.PI*Math.random();for(let t=0;t<4;t++)b2.nail(this.position,{x:10.5*Math.cos(e),y:10.5*Math.sin(e)},1.2,o)}remotePlayers[o].tech.isHarpoonPowerUp&&simulation.cycle-480<remotePlayers[o].tech.harpoonPowerUpCycle?Matter.Body.setDensity(this,1.8*.004):remotePlayers[o].tech.isHarpoonFullHealth&&1===e.health&&(Matter.Body.setDensity(this,.00844),simulation.ephemera.push({count:3,vertices:this.vertices,do(){this.count--,this.count<0&&simulation.removeEphemera(this),ctx.beginPath(),ctx.moveTo(this.vertices[0].x,this.vertices[0].y);for(let e=1,t=this.vertices.length;e<t;e+=1)ctx.lineTo(this.vertices[e].x,this.vertices[e].y);ctx.lineTo(this.vertices[0].x,this.vertices[0].y),ctx.lineJoin="miter",ctx.miterLimit=20,ctx.lineWidth=40,ctx.strokeStyle="rgba(255,0,100,0.35)",ctx.stroke(),ctx.lineWidth=10,ctx.strokeStyle="#f07",ctx.stroke(),ctx.lineJoin="round",ctx.miterLimit=5,ctx.fillStyle="#000",ctx.fill()}})),this.retract()},caughtPowerUp:null,dropCaughtPowerUp(){this.caughtPowerUp&&(this.caughtPowerUp.collisionFilter.category=cat.powerUp,this.caughtPowerUp.collisionFilter.mask=cat.map|cat.powerUp,this.caughtPowerUp=null)},onEnd(){if(!this.caughtPowerUp||simulation.isChoosing||"heal"===this.caughtPowerUp.name&&remotePlayers[o].health===remotePlayers[o].maxHealth&&!remotePlayers[o].tech.isOverHeal)this.dropCaughtPowerUp();else{let e=null;for(let t=0,o=powerUp.length;t<o;++t)powerUp[t]===this.caughtPowerUp&&(e=t);null!==e?(powerUps.onPickUp(this.caughtPowerUp),Matter.Composite.remove(engine.world,this.caughtPowerUp),powerUp.splice(e,1),remotePlayers[o].tech.isHarpoonPowerUp&&(remotePlayers[o].tech.harpoonPowerUpCycle=simulation.cycle)):this.dropCaughtPowerUp()}},retract(){this.attached=!1,this.do=this.returnToPlayer,this.endCycle=simulation.cycle+60,Matter.Body.setDensity(this,5e-4),this.angularSpeed<.5&&(this.torque+=.001*this.inertia*(Math.random()-.5)),this.collisionFilter.mask=0;const e=this.pickUpTarget?Math.min(5,Math.max(this.pickUpTarget.mass,.5)):.5,t=Vector.normalise(Vector.sub(this.position,remotePlayers[o].pos)),i=Vector.mult(t,e*(remotePlayers[o].crouch?.1:.2));remotePlayers[o].force.x+=i.x,remotePlayers[o].force.y+=i.y},returnToPlayer(){if(Vector.magnitude(Vector.sub(this.position,remotePlayers[o].pos))<100){this.endCycle=0;const e=Vector.normalise(Vector.sub(this.velocity,remotePlayers[o].velocity)),t=Vector.mult(e,remotePlayers[o].crouch?1e-4:2e-4);if(remotePlayers[o].force.x+=t.x,remotePlayers[o].force.y+=t.y,this.pickUpTarget){remotePlayers[o].tech.isReel&&this.blockDist>15&&remotePlayers[o].immuneCycle<remotePlayers[o].cycle&&(remotePlayers[o].energy+=.00113*Math.min(this.blockDist,800)*level.isReducedRegen,simulation.drawList.push({x:remotePlayers[o].pos.x,y:remotePlayers[o].pos.y,radius:10,color:remotePlayers[o].fieldMeterColor,time:simulation.drawTime})),remotePlayers[o].holdingTarget=this.pickUpTarget,remotePlayers[o].isHolding=!0;const e=Math.min(5,this.pickUpTarget.mass),t=Vector.mult(Vector.normalise(this.velocity),15*e),i=Vector.mult(remotePlayers[o].velocity,remotePlayers[o].mass);totalMomentum=Vector.add(i,t),Matter.Body.setVelocity(remotePlayers[o],Vector.mult(totalMomentum,1/(remotePlayers[o].defaultMass+e))),remotePlayers[o].definePlayerMass(remotePlayers[o].defaultMass+this.pickUpTarget.mass*remotePlayers[o].holdingMassScale),remotePlayers[o].holdingTarget.collisionFilter.category=0,remotePlayers[o].holdingTarget.collisionFilter.mask=0,this.pickUpTarget=null}}else{remotePlayers[o].energy>this.drain&&(remotePlayers[o].energy-=this.drain);const e=Vector.sub(this.position,remotePlayers[o].pos),t=1+3e-6*Vector.magnitude(e),i=Vector.mult(Vector.normalise(e),t*this.thrustMag*this.mass);this.force.x-=i.x,this.force.y-=i.y,this.grabPowerUp(),this.grabBlocks()}this.draw()},destroyBlocks(){const e=Matter.Query.collides(this,body);if(e.length&&!e[0].bodyA.isNotHoldable){e[0].bodyA.mass>2.5&&this.retract();const t=e[0].bodyA.vertices;Composite.remove(engine.world,e[0].bodyA),body.splice(body.indexOf(e[0].bodyA),1),simulation.ephemera.push({count:25,do(){this.count--,this.count<0&&simulation.removeEphemera(this),ctx.beginPath(),ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=2,ctx.strokeStyle=`rgba(0,0,0,${this.count/25})`,ctx.stroke()}})}},pickUpTarget:null,grabBlocks(){if(this.pickUpTarget)Matter.Body.setPosition(this.pickUpTarget,Vector.add(this.vertices[2],this.velocity)),Matter.Body.setVelocity(this.pickUpTarget,{x:0,y:0});else{const e=Matter.Query.collides(this,body);if(e.length)for(let t=0;t<e.length;t++)if("body"===e[t].bodyA.classType&&!e[t].bodyA.isNotHoldable&&e[0].bodyA.mass<40)if(this.retract(),remotePlayers[o].tech.hookNails){b2.targetedNail(this.position,3*remotePlayers[o].tech.hookNails,40+10*Math.random(),1200,1.4,o);const i=2*Math.PI*Math.random();for(let e=0;e<13;e++)b.nail(this.position,{x:10.5*Math.cos(i),y:10.5*Math.sin(i)},1.2);const l=e[t].bodyA.vertices;Composite.remove(engine.world,e[t].bodyA),body.splice(body.indexOf(e[t].bodyA),1),simulation.ephemera.push({count:25,do(){this.count--,this.count<0&&simulation.removeEphemera(this),ctx.beginPath(),ctx.moveTo(l[0].x,l[0].y);for(let e=1;e<l.length;e++)ctx.lineTo(l[e].x,l[e].y);ctx.lineTo(l[0].x,l[0].y),ctx.lineWidth=2,ctx.strokeStyle=`rgba(0,0,0,${this.count/25})`,ctx.stroke()}})}else this.pickUpTarget=e[t].bodyA,this.blockDist=Vector.magnitude(Vector.sub(this.pickUpTarget.position,remotePlayers[o].pos))}},grabPowerUp(){if(this.caughtPowerUp)Matter.Body.setPosition(this.caughtPowerUp,Vector.add(this.vertices[2],this.velocity)),Matter.Body.setVelocity(this.caughtPowerUp,{x:0,y:0});else for(let e=0,t=powerUp.length;e<t;++e){if(remotePlayers[o].tech.isEnergyNoAmmo&&"ammo"===powerUp[e].name)continue;const t=powerUp[e].circleRadius+50;if(Vector.magnitudeSquared(Vector.sub(this.vertices[2],powerUp[e].position))<t*t&&("heal"!==powerUp[e].name||remotePlayers[o].health!==remotePlayers[o].maxHealth||remotePlayers[o].tech.isOverHeal)){this.caughtPowerUp=powerUp[e],Matter.Body.setVelocity(powerUp[e],{x:0,y:0}),Matter.Body.setPosition(powerUp[e],this.vertices[2]),powerUp[e].collisionFilter.category=0,powerUp[e].collisionFilter.mask=0,this.thrustMag*=.6,this.endCycle+=.5;break}}remotePlayers[o].grabPowerUp()},do(){if(remotePlayers[o].inputField?(remotePlayers[o].fieldCDcycle<remotePlayers[o].cycle+5&&(remotePlayers[o].fieldCDcycle=remotePlayers[o].cycle+5),this.grabBlocks(),this.grabPowerUp()):this.retract(),remotePlayers[o].inputField&&Matter.Query.collides(this,map).length&&(Matter.Body.setPosition(this,Vector.add(this.position,{x:-20*Math.cos(this.angle),y:-20*Math.sin(this.angle)})),Matter.Query.collides(this,map).length)){if(remotePlayers[o].tech.hookNails){b2.targetedNail(this.position,remotePlayers[o].tech.hookNails,40+10*Math.random(),1200,1.4,o);const e=2*Math.PI*Math.random();for(let t=0;t<4;t++)b.nail(this.position,{x:10.5*Math.cos(e),y:10.5*Math.sin(e)},1.2)}this.attached=!0,Matter.Body.setVelocity(this,{x:0,y:0}),Matter.Sleeping.set(this,!0),this.endCycle=simulation.cycle+5,this.do=()=>{remotePlayers[o].inputField&&remotePlayers[o].fieldCDcycle<remotePlayers[o].cycle+5&&(remotePlayers[o].fieldCDcycle=remotePlayers[o].cycle+5),this.grabPowerUp();const e=Vector.sub(this.vertices[0],{x:remotePlayers[o].pos.x+30*Math.cos(remotePlayers[o].angle2),y:remotePlayers[o].pos.y+30*Math.sin(remotePlayers[o].angle2)});let t=Vector.magnitude(e);if(remotePlayers[o].inputField){this.endCycle=simulation.cycle+10,remotePlayers[o].inputDown?(this.isSlowPull=!0,t=0,remotePlayers[o].force.y+=3*remotePlayers[o].mass*simulation.g):remotePlayers[o].inputUp&&(this.isSlowPull=!1,remotePlayers[o].force.y-=remotePlayers[o].mass*simulation.g),remotePlayers[o].energy<this.drain&&(this.isSlowPull=!0);const i=1-30/Math.min(Math.max(100,t),700)-.1*(remotePlayers[o].speed>66);Matter.Body.setVelocity(remotePlayers[o],{x:remotePlayers[o].velocity.x*i,y:remotePlayers[o].velocity.y*i});const l=Vector.mult(Vector.normalise(e),4e-4*Math.min(Math.max(15,t),this.isSlowPull?70:200));remotePlayers[o].force.x+=l.x,remotePlayers[o].force.y+=l.y,t>500&&(remotePlayers[o].energy-=this.drain)}else Matter.Sleeping.set(this,!1),this.retract();this.draw()}}this.force.x+=this.thrustMag*this.mass*Math.cos(this.angle),this.force.y+=this.thrustMag*this.mass*Math.sin(this.angle),this.draw()}}),Composite.add(engine.world,bullet[i]),Matter.Body.setVelocity(bullet[i],remotePlayers[o].velocity)},window.b2.iceIX=function(e,t,o,i){const l=bullet.length,s=.0018,a=1-.11/remotePlayers[i].tech.bulletsLastLonger;bullet[l]=Bodies.polygon(o.x,o.y,3,18,{angle:t-Math.PI,spin:4e-5*(.1+Math.random())*(Math.round(Math.random())?1:-1),friction:0,frictionAir:.02,restitution:.9,dmg:1.5,lookFrequency:14+Math.floor(8*Math.random()),endCycle:simulation.cycle+65*remotePlayers[i].tech.bulletsLastLonger+Math.floor(25*Math.random()),classType:"bullet",collisionFilter:{group:-i,category:cat.body,mask:cat.map|cat.body|cat.mob|cat.mobBullet|cat.mobShield|cat.player},minDmgSpeed:0,lockedOn:null,beforeDmg(e){e.isInvulnerable||(remotePlayers[i].tech.iceEnergy&&!e.shield&&!e.isShielded&&e.isDropPowerUp&&e.alive&&remotePlayers[i].immuneCycle<remotePlayers[i].cycle&&setTimeout((()=>{e.alive||(remotePlayers[i].energy+=.8*remotePlayers[i].tech.iceEnergy*level.isReducedRegen)}),10),mobs.statusSlow(e,remotePlayers[i].tech.iceIXFreezeTime),this.endCycle=simulation.cycle)},onEnd(){},do(){if(!(simulation.cycle%this.lookFrequency)){Matter.Body.scale(this,a,a),this.lockedOn=null;let e=1/0;for(let t=0,o=mob.length;t<o;++t)if(!mob[t].isBadTarget&&mob[t].id!=i&&0===Matter.Query.ray(map,this.position,mob[t].position).length&&0===Matter.Query.ray(body,this.position,mob[t].position).length&&!mob[t].isInvulnerable){const o=Vector.sub(this.position,mob[t].position),i=Vector.magnitude(o);i<e&&(e=i,this.lockedOn=mob[t])}const t=Vector.sub(this.position,player.position),o=Vector.magnitude(t);o<e&&(e=o,this.lockedOn=player)}this.lockedOn?this.force=Vector.mult(Vector.normalise(Vector.sub(this.lockedOn.position,this.position)),this.mass*s):this.force=Vector.mult(Vector.normalise(this.velocity),this.mass*s),this.torque+=this.inertia*this.spin}}),Composite.add(engine.world,bullet[l]),Matter.Body.setVelocity(bullet[l],{x:e*Math.cos(t),y:e*Math.sin(t)}),Matter.Body.setAngularVelocity(bullet[l],3e3*bullet[l].spin)},window.b2.flea=function(e,t,o,i){const l=bullet.length;bullet[l]=Bodies.polygon(e.x,e.y,5,o,{isFlea:!0,angle:.5*Math.random(),friction:1,frictionStatic:1,frictionAir:0,restitution:0,density:5e-4,lookFrequency:19+Math.floor(7*Math.random()),endCycle:simulation.cycle+Math.floor(900*remotePlayers[i].tech.bulletsLastLonger+420*Math.random()+Math.max(0,150-bullet.length)),classType:"bullet",collisionFilter:{group:-i,category:cat.body,mask:cat.map|cat.body|cat.mob|cat.mobBullet|cat.mobShield|cat.player},minDmgSpeed:0,lockedOn:null,delay:50,cd:simulation.cycle+10,dmg:0,setDamage(){this.dmg=o*(remotePlayers[i].tech.isMutualism?3.3:1.1)},beforeDmg(e){Matter.Body.setVelocity(this,Vector.mult(Vector.normalise(Vector.sub(this.position,e.position)),10+10*Math.random())),this.cd=simulation.cycle+this.delay,e.isInvulnerable||0===this.dmg||(this.endCycle-=110,remotePlayers[i].tech.isSporeFreeze&&mobs.statusSlow(e,90),remotePlayers[i].tech.isSpawnBulletsOnDeath&&e.alive&&e.isDropPowerUp&&setTimeout((()=>{if(!e.alive)for(let e=0;e<2;e++){const e=10+5*Math.random(),t=2*Math.PI*Math.random();b.flea(this.position,{x:e*Math.cos(t),y:e*Math.sin(t)})}this.endCycle=0}),1),setTimeout((()=>{this.dmg=0})))},onEnd(){remotePlayers[i].tech.isMutualism&&this.isMutualismActive&&!remotePlayers[i].tech.isEnergyHealth&&(remotePlayers[i].health+=.02)},gravity:.002+.002*remotePlayers[i].tech.isSporeFollow,do(){if(this.force.y+=this.gravity*this.mass,this.cd<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)){this.cd=simulation.cycle+this.delay,this.lockedOn=null;let e=1/0;for(let t=0,o=mob.length;t<o;++t){if(!mob[t].isBadTarget&&!mob[t].isInvulnerable&&mob[t].id!=i&&mob[t].alive&&this.position.y-mob[t].position.y<1500&&this.position.y-mob[t].position.y>-300&&0===Matter.Query.ray(map,this.position,mob[t].position).length&&0===Matter.Query.ray(body,this.position,mob[t].position).length){const o=Vector.sub(this.position,mob[t].position),i=Vector.magnitude(o);i<e&&(e=i,this.lockedOn=mob[t])}const o=Vector.sub(this.position,player.position),l=Vector.magnitude(o);l<e&&(e=l,this.lockedOn=player)}if(remotePlayers[i].tech.isSporeFollow&&!this.lockedOn&&0===Matter.Query.ray(map,this.position,remotePlayers[i].pos).length&&(this.lockedOn={position:remotePlayers[i].pos,velocity:{x:0,y:0}}),this.lockedOn){const t=Vector.add(this.lockedOn.position,Vector.mult(this.lockedOn.velocity,5)),o=Math.max(0,this.position.y-t.y),l=-.06*(this.position.x-t.x)/Math.sqrt(2*o/this.gravity),s=.085*Math.sqrt(this.gravity*o),a=.07+.02*remotePlayers[i].tech.isSporeFollow,r=.12+.04*Math.random()+.05*remotePlayers[i].tech.isSporeFollow,n=e>500?.05+.02*Math.random():.02+.01*Math.random();this.force.x=Math.max(-a,Math.min(a,l))*this.mass,this.force.y=-Math.max(n,Math.min(r,s))*this.mass}else Math.random()<.5?this.force.x=(.01+.03*Math.random())*this.mass*(this.velocity.x>0?1:-1):this.force.x=(.01+.03*Math.random())*this.mass*(Math.random()<.5?1:-1),this.force.y=-(.03+.08*Math.random())*this.mass;Matter.Body.setVelocity(this,{x:0,y:0}),this.setDamage()}}}),Composite.add(engine.world,bullet[l]),Matter.Body.setVelocity(bullet[l],t),remotePlayers[i].tech.isMutualism&&remotePlayers[i].health>.05&&(remotePlayers[i].health-=.01,bullet[bullet.length-1].isMutualismActive=!0)},window.b2.worm=function(e,t,o){const i=bullet.length,l=6+4.2*remotePlayers[o].tech.wormSize*Math.random();if(i<500){bullet[i]=Bodies.polygon(e.x,e.y,3,3,{inertia:1/0,isFreeze:t,restitution:.5,friction:0,frictionAir:.025,thrust:(remotePlayers[o].tech.isSporeFollow?.0012:55e-5)*(1+.5*(Math.random()-.5)),wormSize:l,wormTail:1+Math.max(4,Math.min(l-2*remotePlayers[o].tech.wormSize,30)),dmg:(remotePlayers[o].tech.isMutualism?9.5:3.2)*l,lookFrequency:100+Math.floor(37*Math.random()),classType:"bullet",collisionFilter:{group:-o,category:cat.body,mask:cat.map|cat.mob|cat.mobBullet|cat.mobShield|cat.player},endCycle:simulation.cycle+Math.floor((600+Math.floor(420*Math.random()))*remotePlayers[o].tech.bulletsLastLonger),minDmgSpeed:0,playerOffPosition:{x:100*(Math.random()-.5),y:100*(Math.random()-.5)},beforeDmg(e){e.isInvulnerable?Matter.Body.setVelocity(this,Vector.mult(this.velocity,.1)):(remotePlayers[o].tech.isSpawnBulletsOnDeath&&e.alive&&e.isDropPowerUp?setTimeout((()=>{if(!e.alive)for(let e=0;e<3;e++)b2.worm(this.position,remotePlayers[o].tech.isSporeFreeze,o),bullet[bullet.length-1].endCycle=Math.min(simulation.cycle+Math.floor(420*remotePlayers[o].tech.bulletsLastLonger),this.endCycle+180+Math.floor(60*Math.random()));this.endCycle=0}),1):this.endCycle=0,this.isFreeze&&mobs.statusSlow(e,90))},onEnd(){remotePlayers[o].tech.isMutualism&&this.isMutualismActive&&!remotePlayers[o].tech.isEnergyHealth&&(remotePlayers[o].health+=.02,remotePlayers[o].health>remotePlayers[o].maxHealth&&(remotePlayers[o].health=remotePlayers[o].maxHealth),remotePlayers[o].displayHealth())},tailCycle:6.28*Math.random(),do(){this.tailCycle+=.025*this.speed,ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y);const e=Math.min(7,this.speed),t=Vector.mult(Vector.normalise(this.velocity),-.6*this.wormTail*e),i=Vector.add(this.position,t),l=Vector.add(Vector.add(i,t),Vector.rotate(t,Math.sin(this.tailCycle)));if(ctx.quadraticCurveTo(i.x,i.y,l.x,l.y),ctx.lineWidth=this.wormSize,ctx.strokeStyle="#000",ctx.stroke(),this.lockedOn&&this.lockedOn.alive)this.force=Vector.mult(Vector.normalise(Vector.sub(this.lockedOn.position,this.position)),this.mass*this.thrust);else{if(!(simulation.cycle%this.lookFrequency)){this.closestTarget=null,this.lockedOn=null;let e=1/0;for(let t=0,i=mob.length;t<i;++t)if(mob[t].id!=o&&!mob[t].isBadTarget&&0===Matter.Query.ray(map,this.position,mob[t].position).length&&!mob[t].isInvulnerable){const o=Vector.sub(this.position,mob[t].position),i=Vector.magnitude(o)*(Math.random()+.5);if(i<e&&(this.closestTarget=mob[t].position,e=i,this.lockedOn=mob[t],.3>Math.random()))break}const t=Vector.sub(this.position,player.position),i=Vector.magnitude(t)*(Math.random()+.5);i<e&&(this.closestTarget=player.position,e=i,this.lockedOn=player)}if(remotePlayers[o].tech.isSporeFollow&&null===this.lockedOn){const e=this.position.x-remotePlayers[o].pos.x,t=this.position.y-remotePlayers[o].pos.y;e*e+t*t>1e4&&(this.force=Vector.mult(Vector.normalise(Vector.sub(remotePlayers[o].pos,Vector.add(this.playerOffPosition,this.position))),this.mass*this.thrust))}else{const e=Vector.normalise(this.velocity),t=Vector.mult(Vector.rotate(e,.005*this.playerOffPosition.x),3e-6);this.force.x+=t.x,this.force.y+=t.y}}}});const s=2+1*Math.random(),a=2*Math.PI*Math.random();Matter.Body.setVelocity(bullet[i],{x:s*Math.cos(a),y:s*Math.sin(a)}),Composite.add(engine.world,bullet[i]),remotePlayers[o].tech.isMutualism&&remotePlayers[o].health>.5&&(remotePlayers[o].health-=.02,bullet[i].isMutualismActive=!0)}},spawn.bodyRect=function(e,t,o,i,l=1,s={friction:.05,frictionAir:.001}){if(Math.random()<l){body[body.length]=Bodies.rectangle(e+o/2,t+i/2,o,i,s);const l=body[body.length-1],a=deterministicBlockId(l.area,l.vertices.length,Math.seed,level.onLevel);l.id=a,l.remoteBlock=!1,l._lastBlockUpdate=0,l.collisionFilter.category=cat.body,l.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet,Composite.add(engine.world,l),l.classType="body",sendBlockCreate(l)}},spawn.bodyVertex=function(e,t,o,i){body[body.length]=Matter.Bodies.fromVertices(e,t,Vertices.fromPath(o),i);const l=body[body.length-1],s=deterministicBlockId(l.area,l.vertices.length,Math.seed,level.onLevel);l.id=s,l.remoteBlock=!1,l._lastBlockUpdate=0,l.collisionFilter.category=cat.body,l.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet,Composite.add(engine.world,l),l.classType="body",sendBlockCreate(l)},window.rpp=function(){for(let e in remotePlayers)if(remotePlayers[e].isTimeDilated)return!0;return!1},Matter.Events.on(engine,"afterUpdate",(()=>{!m.isTimeDilated&&rpp()?(player._frozenPos||(player._frozenPos={x:player.position.x,y:player.position.y}),Matter.Body.setPosition(player,player._frozenPos),Matter.Body.setVelocity(player,{x:0,y:0}),Matter.Body.setAngularVelocity(player,0),player.force.x=0,player.force.y=0,player.torque=0):player._frozenPos&&(delete player._frozenPos,delete player._frozenAngle)}));const chatStyle=document.createElement("style");chatStyle.textContent="\n        #chat-input {\n            position: fixed;\n            left: 50%;\n            top: 50%;\n            transform: translate(-50%, -50%);\n            width: min(70vw, 800px);\n            z-index: 9999;\n            width: -webkit-fill-available;\n            padding: 10px 12px;\n            font-size: 16px;\n            line-height: 1.4;\n            color: #000;\n            background: #e8e8e8cf;\n            border: 0;\n        }\n        #chat-input::placeholder { color: #aaa; }\n        ",document.head.appendChild(chatStyle);const overlay=document.createElement("div");overlay.style.display="none",overlay.innerHTML='<input id="chat-input" type="text" maxlength="420" placeholder="">',document.body.appendChild(overlay);const chatInput=overlay.querySelector("#chat-input");let chatOpen=!1;function openChat(){chatOpen=!0,overlay.style.display="block",chatInput.value="",setTimeout((()=>chatInput.focus()),0)}function closeChat(){chatOpen=!1,overlay.style.display="none"}function sendChatMessage(){const e=(chatInput.value||"").trim();if(!e)return void closeChat();const t=`${window.username||"unnamed player"}: ${e}`;sentChat(t),simulation&&"function"==typeof simulation.inGameConsole&&simulation.inGameConsole(t),closeChat()}document.addEventListener("keydown",(e=>{if(chatOpen)return e.target!==chatInput&&chatInput.focus(),"Enter"===e.key?(e.preventDefault(),e.stopPropagation(),void sendChatMessage()):"Escape"===e.key?(e.preventDefault(),e.stopPropagation(),void closeChat()):void e.stopPropagation();if("Enter"===e.key){const t=e.target;t&&("INPUT"===t.tagName&&t.type&&!["button","submit","checkbox","radio","range","color","file"].includes(t.type)||"TEXTAREA"===t.tagName||t.isContentEditable)||(e.preventDefault(),e.stopPropagation(),openChat())}}),!0)})()}
